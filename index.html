<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>周勤评分系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5a6fd0;
            --secondary-color: #4a59b5;
            --accent-color: #6bc5f0;
            --success-color: #5cd68a;
            --warning-color: #f8b042;
            --danger-color: #f56666;
            --light-color: #f8f9fa;
            --dark-color: #2d3748;
            --gray-color: #718096;
            --light-gray: #e2e8f0;
            --border-radius: 10px;
            --box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            --input-background: #ffffff;
            --card-background: rgba(255, 255, 255, 0.92);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: var(--background-gradient);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 头部样式 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(90, 111, 208, 0.2);
        }

        .logo-text h1 {
            font-size: 24px;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .logo-text p {
            color: var(--gray-color);
            font-size: 13px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 18px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--card-background);
            color: var(--dark-color);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            font-size: 14px;
        }

        .header-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .header-btn.customize {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .header-btn.records {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
        }

        .header-btn.help {
            background: linear-gradient(135deg, var(--accent-color), #2b9fc9);
            color: white;
        }

        /* 主内容区域 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 15px;
            height: calc(100vh - 150px);
            min-height: 500px;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }
        }

        /* 左侧面板 - 新增记录 */
        .panel-left {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 右侧面板 - 模板和记录 */
        .panel-right {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
            flex-shrink: 0;
        }

        .panel-title h2 {
            font-size: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title .help-icon {
            color: var(--gray-color);
            font-size: 18px;
            cursor: help;
        }

        /* 新增记录表单 */
        .record-form {
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 150px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 14px;
        }

        .select-wrapper, .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .select-wrapper select, .input-wrapper input, .input-wrapper textarea {
            width: 100%;
            padding: 12px 35px 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
            font-size: 15px;
            background-color: var(--input-background);
            appearance: none;
            transition: var(--transition);
            color: var(--dark-color);
        }

        .select-wrapper select:focus, .input-wrapper input:focus, .input-wrapper textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(90, 111, 208, 0.1);
        }

        .input-wrapper textarea {
            resize: vertical;
            min-height: 70px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            z-index: 5;
        }

        .clear-btn:hover {
            color: var(--danger-color);
        }

        /* 分数显示区域 */
        .score-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
            padding: 18px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .current-score {
            text-align: center;
        }

        .current-score-label {
            font-size: 13px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .current-score-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .daily-total {
            text-align: center;
        }

        .daily-total-label {
            font-size: 13px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .daily-total-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--success-color);
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(90, 111, 208, 0.3);
        }

        /* 右侧面板 - 模板和记录水平布局 */
        .right-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 100%;
            min-height: 0;
        }

        @media (max-width: 768px) {
            .right-content {
                grid-template-columns: 1fr;
            }
        }

        .template-section, .daily-records {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .template-list, .records-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
            max-height: 400px;
        }

        .template-list::-webkit-scrollbar, .records-list::-webkit-scrollbar {
            width: 6px;
        }

        .template-list::-webkit-scrollbar-track, .records-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .template-list::-webkit-scrollbar-thumb, .records-list::-webkit-scrollbar-thumb {
            background: rgba(90, 111, 208, 0.3);
            border-radius: 10px;
        }

        .template-list::-webkit-scrollbar-thumb:hover, .records-list::-webkit-scrollbar-thumb:hover {
            background: rgba(90, 111, 208, 0.5);
        }

        .template-item, .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            background-color: #f8fafc;
            position: relative;
            transition: var(--transition);
        }

        .template-item:hover, .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .template-item.completed {
            background-color: #f1f5f9;
            color: var(--gray-color);
            border-left-color: var(--gray-color);
        }

        .template-item.overdue {
            background-color: #fee2e2;
            border-left-color: var(--danger-color);
        }

        .template-item.normal {
            background-color: #f8fafc;
            border-left-color: var(--primary-color);
        }

        .record-item.template {
            background-color: #e6f7ee;
            border-left-color: var(--success-color);
        }

        .record-item.non-template {
            background-color: #e8f0fe;
            border-left-color: var(--accent-color);
        }

        .item-info {
            flex: 1;
            margin-right: 10px;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .item-details {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: var(--gray-color);
            flex-wrap: wrap;
        }

        .item-score {
            font-weight: 700;
            font-size: 16px;
            white-space: nowrap;
            margin-right: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .item-score .completion-date {
            font-size: 12px;
            font-weight: normal;
            color: var(--gray-color);
            margin-top: 2px;
        }

        .item-actions {
            display: flex;
            gap: 6px;
        }

        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        /* 自定义弹框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 750px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 18px 22px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            color: var(--dark-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 22px;
            color: var(--gray-color);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: #f1f5f9;
            color: var(--dark-color);
        }

        .modal-body {
            padding: 22px;
        }

        /* 事项管理样式 */
        .item-management {
            margin-bottom: 25px;
        }

        .add-item-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            transition: var(--transition);
        }

        .add-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
        }

        .items-list {
            list-style: none;
        }

        .item-card {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            overflow: hidden;
            background-color: var(--card-background);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background-color: #f8fafc;
            cursor: pointer;
            transition: var(--transition);
        }

        .item-header:hover {
            background-color: #f1f5f9;
        }

        .item-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .item-index {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .item-main-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            flex: 1;
        }

        .item-name-container {
            font-weight: 600;
            font-size: 15px;
        }

        .item-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--gray-color);
        }

        .item-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .item-stat i {
            color: var(--primary-color);
        }

        .item-toggle {
            font-size: 13px;
            color: var(--gray-color);
            transition: var(--transition);
            flex-shrink: 0;
        }

        .item-header.open .item-toggle {
            transform: rotate(180deg);
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition);
        }

        .edit-btn {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .delete-btn {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            color: white;
        }

        .small-delete-btn {
            padding: 3px 8px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            color: white;
            width: 28px;
            height: 28px;
            min-width: 28px;
            transition: var(--transition);
        }

        .small-delete-btn:hover {
            transform: scale(1.05);
        }

        .item-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .item-content.open {
            padding: 18px;
            max-height: 1000px;
        }

        .sub-items-list {
            list-style: none;
            margin-bottom: 10px;
        }

        .sub-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid #f1f5f9;
            transition: var(--transition);
        }

        .sub-item:hover {
            background-color: #f8fafc;
        }

        .sub-item:last-child {
            border-bottom: none;
        }

        .sub-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            flex-wrap: wrap;
        }

        .sub-item-time {
            min-width: 90px;
            font-size: 14px;
        }

        .sub-item-score {
            min-width: 50px;
            font-weight: 600;
            font-size: 14px;
        }

        .sub-item-description {
            flex: 1;
            font-size: 14px;
            color: var(--gray-color);
        }

        .sub-item-actions {
            display: flex;
            gap: 8px;
        }

        .add-subitem-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background-color: rgb(92, 214, 138);
            border: 1px dashed var(--light-gray);
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            margin-top: 12px;
            transition: var(--transition);
            font-size: 13px;
        }

        .add-subitem-btn:hover {
            background-color: #e5e7eb;
            color: var(--dark-color);
        }

        /* 模板管理样式 */
        .template-management {
            margin-bottom: 25px;
        }

        .current-template {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
            border-radius: var(--border-radius);
            flex-wrap: wrap;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .current-template-label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 14px;
        }

        .current-template-name {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 15px;
        }

        .change-template-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
            font-size: 13px;
            transition: var(--transition);
        }

        .change-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(248, 176, 66, 0.2);
        }

        .template-cards {
            margin-top: 18px;
        }

        .template-card {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            overflow: hidden;
            background-color: var(--card-background);
        }

        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background-color: #f8fafc;
            cursor: pointer;
            transition: var(--transition);
        }

        .template-card-header:hover {
            background-color: #f1f5f9;
        }

        .template-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .template-card-index {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .template-main-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            flex: 1;
        }

        .template-name-container {
            font-weight: 600;
            font-size: 15px;
        }

        .template-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--gray-color);
        }

        .template-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .template-stat i {
            color: var(--success-color);
        }

        .template-card-toggle {
            font-size: 13px;
            color: var(--gray-color);
            transition: var(--transition);
            flex-shrink: 0;
        }

        .template-card-header.open .template-card-toggle {
            transform: rotate(180deg);
        }

        .template-card-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .template-card-content.open {
            padding: 18px;
            max-height: 1000px;
        }

        .template-items-list {
            list-style: none;
            margin-bottom: 12px;
        }

        .template-item-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .template-item-detail:last-child {
            border-bottom: none;
        }

        /* 记录管理样式 */
        .records-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-size: 14px;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-form .form-group {
            min-width: 130px;
        }

        .search-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: var(--transition);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
        }

        /* 每日查询结果样式 */
        .daily-query-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 450px;
        }

        @media (max-width: 768px) {
            .daily-query-results {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .query-results-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .query-results-content {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .query-total-score {
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
            padding: 14px;
            border-radius: var(--border-radius);
            margin-bottom: 18px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .query-total-score-label {
            font-size: 13px;
            color: var(--gray-color);
            margin-bottom: 5px;
        }

        .query-total-score-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--success-color);
        }

        /* 周度报告样式 */
        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray-color);
        }

        .stat-details {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 13px;
            color: var(--gray-color);
        }

        .completion-summary {
            margin-top: 25px;
        }

        .completion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
        }

        .completion-item:hover {
            background-color: #f8fafc;
        }

        /* 使用说明样式 */
        .instructions-list {
            list-style: none;
            padding-left: 18px;
        }

        .instructions-list li {
            margin-bottom: 12px;
            padding-left: 8px;
            position: relative;
        }

        .instructions-list li:before {
            content: "•";
            color: var(--primary-color);
            font-size: 22px;
            position: absolute;
            left: -15px;
            top: -5px;
        }

        /* 烟花特效样式 */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2001;
            display: none;
        }

        .fireworks-container.active {
            display: block;
        }

        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }

        .celebration-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 2002;
            display: none;
            animation: popIn 0.5s ease-out;
            border: 4px solid var(--success-color);
        }

        .celebration-message.active {
            display: block;
        }

        .celebration-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: 10px;
        }

        .celebration-subtitle {
            font-size: 18px;
            color: var(--dark-color);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* 自定义通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            min-width: 280px;
            max-width: 350px;
            transform: translateX(350px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--gray-color);
            cursor: pointer;
        }

        .notification-content {
            color: var(--dark-color);
            font-size: 14px;
        }

        /* 确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .confirm-title {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--dark-color);
        }

        .confirm-message {
            margin-bottom: 22px;
            color: var(--gray-color);
            font-size: 14px;
        }

        .confirm-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .confirm-btn {
            padding: 8px 18px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .confirm-btn.cancel {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .confirm-btn.confirm {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            color: white;
        }

        /* 重复记录确认对话框 */
        .duplicate-record-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .duplicate-record-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .duplicate-record-content {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .duplicate-record-title {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--dark-color);
        }

        .duplicate-record-message {
            margin-bottom: 22px;
            color: var(--gray-color);
            font-size: 14px;
        }

        .duplicate-record-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .duplicate-record-btn {
            padding: 8px 18px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .duplicate-record-btn.cancel {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .duplicate-record-btn.confirm {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        /* 工具提示样式 - 修改为水平显示 */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: var(--border-radius);
            padding: 10px;
            position: absolute;
            z-index: 3000;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            font-weight: normal;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            white-space: normal;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent var(--dark-color) transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* 时间点编辑样式 */
        .time-point-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f8fafc;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-color);
            transition: var(--transition);
        }

        .time-point-item:hover {
            background-color: #f1f5f9;
        }

        .time-point-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .time-point-time {
            min-width: 100px;
            font-weight: 600;
        }

        .time-point-score {
            min-width: 50px;
            font-weight: 600;
        }

        .time-point-description {
            flex: 1;
            color: var(--gray-color);
        }

        .time-point-edit-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: var(--input-background);
        }

        /* 单位类型特定样式 */
        .unit-type-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .unit-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .unit-input {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            flex-wrap: wrap;
        }

        .unit-input input {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
            font-size: 15px;
            background-color: var(--input-background);
        }

        .unit-label {
            font-weight: 600;
            color: var(--dark-color);
            min-width: 40px;
        }

        .unit-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unit-range span {
            color: var(--gray-color);
        }

        /* 模板名称显示在主界面 */
        .template-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .current-template-display {
            font-size: 14px;
            color: var(--gray-color);
        }

        .current-template-display .template-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header-buttons {
                width: 100%;
                margin-top: 15px;
            }
            
            .header-btn {
                flex: 1;
                justify-content: center;
            }
            
            .logo {
                flex-direction: column;
                text-align: center;
                gap: 8px;
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .item-header, .template-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .item-actions {
                align-self: flex-end;
            }
            
            .sub-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .sub-item-info {
                width: 100%;
            }
            
            .modal {
                width: 98%;
            }
            
            .daily-query-results {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .report-stats {
                grid-template-columns: 1fr;
            }
            
            .celebration-message {
                width: 90%;
                padding: 20px;
            }
            
            .celebration-title {
                font-size: 22px;
            }
            
            .celebration-subtitle {
                font-size: 16px;
            }
            
            .item-main-info, .template-main-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .item-stats, .template-stats {
                width: 100%;
            }
            
            /* 移动端工具提示调整 */
            .tooltip .tooltip-text {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                max-width: 280px;
                z-index: 3001;
                margin-left: 0;
            }
            
            .tooltip .tooltip-text::after {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .header-buttons {
                flex-direction: column;
            }
            
            .header-btn {
                width: 100%;
            }
            
            .main-content {
                height: auto;
            }
            
            .right-content {
                grid-template-columns: 1fr;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .search-btn {
                width: 100%;
                justify-content: center;
            }
            
            .tooltip .tooltip-text {
                width: 180px;
                font-size: 12px;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <h1>周勤评分系统</h1>
                    <p>养成良好的习惯，提升自我管理能力</p>
                </div>
            </div>
            <div class="header-buttons">
                <button class="header-btn customize" id="customizeBtn">
                    <i class="fas fa-sliders-h"></i> 自定义功能
                </button>
                <button class="header-btn records" id="recordsBtn">
                    <i class="fas fa-history"></i> 记录管理
                </button>
                <button class="header-btn help" id="helpBtn">
                    <i class="fas fa-question-circle"></i> 使用说明
                </button>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 左侧：新增记录 -->
            <section class="panel-left">
                <div class="panel-title">
                    <h2>
                        <i class="fas fa-plus-circle"></i> 新增记录
                        <span class="tooltip help-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">在此处添加当日的习惯完成记录。选择事项和时间点后，系统会自动计算得分并累加到当日总分。</span>
                        </span>
                    </h2>
                </div>
                
                <div class="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemSource">事项来源</label>
                            <div class="select-wrapper">
                                <select id="itemSource">
                                    <option value="template">当前模板内</option>
                                    <option value="all">所有事项</option>
                                </select>
                                <button class="clear-btn" data-target="itemSource">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemSelect">事项选择</label>
                            <div class="select-wrapper">
                                <select id="itemSelect">
                                    <!-- 选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="itemSelect">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timeSelect">时间点选择</label>
                            <div class="select-wrapper">
                                <select id="timeSelect">
                                    <!-- 选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="timeSelect">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="score-display">
                        <div class="current-score">
                            <div class="current-score-label">当前得分</div>
                            <div class="current-score-value" id="currentScore">0</div>
                        </div>
                        <div class="daily-total">
                            <div class="daily-total-label">当日累计得分</div>
                            <div class="daily-total-value" id="dailyTotal">0</div>
                        </div>
                    </div>
                    
                    <button class="save-btn" id="saveRecordBtn">
                        <i class="fas fa-save"></i> 保存记录
                    </button>
                </div>
            </section>

            <!-- 右侧：模板和记录水平排列 -->
            <section class="panel-right">
                <div class="template-info-header">
                    <div class="current-template-display">
                        当前模板: <span class="template-name" id="currentTemplateDisplay">默认模板</span>
                    </div>
                </div>
                <div class="right-content">
                    <div class="template-section">
                        <div class="panel-title">
                            <h2>
                                <i class="fas fa-th-list"></i> 当前模板事项
                                <span class="tooltip help-icon">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">显示当前使用模板中的所有事项。已完成的事项会变为灰色，未完成的事项正常显示。间隔天数表示该事项完成后的休息天数。</span>
                                </span>
                            </h2>
                        </div>
                        <ul class="template-list" id="templateList">
                            <!-- 模板事项将通过JS动态生成 -->
                        </ul>
                    </div>
                    
                    <div class="daily-records">
                        <div class="panel-title">
                            <h2>
                                <i class="fas fa-calendar-day"></i> 当日记录
                                <span class="tooltip help-icon">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">显示当天已完成的事项记录。绿色背景表示是模板内事项，蓝色背景表示是非模板事项。</span>
                                </span>
                            </h2>
                        </div>
                        <ul class="records-list" id="dailyRecordsList">
                            <!-- 当日记录将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 烟花特效容器 -->
    <div class="fireworks-container" id="fireworksContainer"></div>
    
    <!-- 庆祝消息 -->
    <div class="celebration-message" id="celebrationMessage">
        <div class="celebration-title">签到成功！</div>
        <div class="celebration-subtitle">恭喜！太棒啦！</div>
    </div>

    <!-- 重复记录确认对话框 -->
    <div class="duplicate-record-dialog" id="duplicateRecordDialog">
        <div class="duplicate-record-content">
            <div class="duplicate-record-title" id="duplicateRecordTitle">确认添加记录</div>
            <div class="duplicate-record-message" id="duplicateRecordMessage"></div>
            <div class="duplicate-record-buttons">
                <button class="duplicate-record-btn cancel" id="duplicateRecordCancel">取消</button>
                <button class="duplicate-record-btn confirm" id="duplicateRecordConfirm">确认添加</button>
            </div>
        </div>
    </div>

    <!-- 自定义功能弹框 -->
    <div class="modal-overlay" id="customizeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">自定义功能</h3>
                <button class="modal-close" id="closeCustomizeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="records-tabs">
                    <button class="tab-btn" data-tab="itemsTab">事项及分数管理</button>
                    <button class="tab-btn active" data-tab="templatesTab">模板管理</button>
                </div>
                    
                <!-- 事项及分数管理 -->
                <div class="tab-content" id="itemsTab">
                    <div class="item-management">
                        <button class="add-item-btn" id="addItemBtn">
                            <i class="fas fa-plus"></i> 添加事项
                        </button>
                            
                        <ul class="items-list" id="itemsList">
                            <!-- 事项列表将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
                    
                <!-- 模板管理 -->
                <div class="tab-content active" id="templatesTab">
                    <div class="template-management">
                        <div class="current-template">
                            <span class="current-template-label">当前使用模板：</span>
                            <span class="current-template-name" id="currentTemplateName">默认模板</span>
                            <button class="change-template-btn" id="changeTemplateBtn">修改使用模板</button>
                        </div>
                            
                        <button class="add-item-btn" id="addTemplateBtn">
                            <i class="fas fa-plus"></i> 添加模板
                        </button>
                            
                        <div class="template-cards" id="templatesContainer">
                            <!-- 模板列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加事项弹框 -->
    <div class="modal-overlay" id="addItemModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="addItemModalTitle">添加事项</h3>
                <button class="modal-close" id="closeAddItemModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">事项名称 (不超过5个字)</label>
                        <div class="input-wrapper">
                            <input type="text" id="itemName" maxlength="5" placeholder="请输入事项名称">
                            <button class="clear-btn" data-target="itemName">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="itemUnitType">事项单位类型</label>
                        <div class="select-wrapper">
                            <select id="itemUnitType">
                                <option value="timePoint">时间点</option>
                                <option value="count">次</option>
                                <option value="distance">公里</option>
                                <option value="duration">时长</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="intervalDays">间隔天数</label>
                        <div class="select-wrapper">
                            <select id="intervalDays">
                                <option value="0">0 (无间隔，每天执行)</option>
                                <option value="1">1 (间隔1天)</option>
                                <option value="2">2 (间隔2天)</option>
                                <option value="3">3 (间隔3天)</option>
                                <option value="4">4 (间隔4天)</option>
                                <option value="5">5 (间隔5天)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="unfinishedScore">未完成分数</label>
                        <div class="select-wrapper">
                            <select id="unfinishedScore">
                                <option value="-1">-1</option>
                                <option value="-2">-2</option>
                                <option value="-3">-3</option>
                                <option value="-4">-4</option>
                                <option value="-5">-5</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription">事项说明</label>
                    <div class="input-wrapper">
                        <textarea id="itemDescription" placeholder="请输入事项说明" rows="2"></textarea>
                        <button class="clear-btn" data-target="itemDescription">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 时间点设置区域 -->
                <div class="unit-type-section" id="timePointSection">
                    <h4>时间点设置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>开始时间</label>
                            <div class="form-row">
                                <div class="select-wrapper">
                                    <select class="time-hour" data-index="0">
                                        <option value="">时</option>
                                        <!-- 小时选项将通过JS动态生成 -->
                                    </select>
                                </div>
                                <span>:</span>
                                <div class="select-wrapper">
                                    <select class="time-minute" data-index="0">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>结束时间 (可选)</label>
                            <div class="form-row">
                                <div class="select-wrapper">
                                    <select class="time-hour" data-index="1">
                                        <option value="">时</option>
                                        <!-- 小时选项将通过JS动态生成 -->
                                    </select>
                                </div>
                                <span>:</span>
                                <div class="select-wrapper">
                                    <select class="time-minute" data-index="1">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="timeScore">分数</label>
                            <div class="select-wrapper">
                                <select id="timeScore">
                                    <option value="5">5</option>
                                    <option value="4">4</option>
                                    <option value="3">3</option>
                                    <option value="2">2</option>
                                    <option value="1">1</option>
                                    <option value="-1">-1</option>
                                    <option value="-2">-2</option>
                                    <option value="-3">-3</option>
                                    <option value="-4">-4</option>
                                    <option value="-5">-5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="timeDescription">说明/备注</label>
                        <div class="input-wrapper">
                            <textarea id="timeDescription" placeholder="请输入说明或备注" rows="2"></textarea>
                            <button class="clear-btn" data-target="timeDescription">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button class="add-subitem-btn" id="addTimePointBtn">
                        <i class="fas fa-plus"></i> 添加时间点
                    </button>
                    
                    <div id="timePointsList">
                        <!-- 已添加的时间点将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 单位类型评分区域 -->
                <div class="unit-type-section" id="unitScoreSection" style="display: none;">
                    <h4 id="unitScoreTitle">次 数评分</h4>
                    <div class="unit-input-container">
                        <div class="unit-range">
                            <div class="unit-input">
                                <input type="number" id="unitValue1" min="0" max="999" step="0.1" placeholder="最小值">
                                <span>~</span>
                                <input type="number" id="unitValue2" min="0" max="999" step="0.1" placeholder="最大值">
                                <span class="unit-label" id="unitLabel">次</span>
                            </div>
                            <div class="select-wrapper">
                                <select id="unitScore">
                                    <option value="5">+5分</option>
                                    <option value="4">+4分</option>
                                    <option value="3">+3分</option>
                                    <option value="2">+2分</option>
                                    <option value="1">+1分</option>
                                    <option value="-1">-1分</option>
                                    <option value="-2">-2分</option>
                                    <option value="-3">-3分</option>
                                    <option value="-4">-4分</option>
                                    <option value="-5">-5分</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="unitDescription">说明/备注</label>
                        <div class="input-wrapper">
                            <textarea id="unitDescription" placeholder="请输入说明或备注" rows="2"></textarea>
                            <button class="clear-btn" data-target="unitDescription">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button class="add-subitem-btn" id="addUnitScoreBtn">
                        <i class="fas fa-plus"></i> 添加评分项
                    </button>
                    
                    <div id="unitScoresList">
                        <!-- 已添加的评分项将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveItemBtn">保存事项</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑时间点弹框 -->
    <div class="modal-overlay" id="editTimePointModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">编辑时间点</h3>
                <button class="modal-close" id="closeEditTimePointModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTimeDisplay">时间</label>
                    <div class="input-wrapper">
                        <input type="text" id="editTimeDisplay" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editTimeScore">分数</label>
                    <div class="select-wrapper">
                        <select id="editTimeScore">
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                            <option value="-1">-1</option>
                            <option value="-2">-2</option>
                            <option value="-3">-3</option>
                            <option value="-4">-4</option>
                            <option value="-5">-5</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editTimeDescription">说明/备注</label>
                    <div class="input-wrapper">
                        <textarea id="editTimeDescription" placeholder="请输入说明或备注" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveTimePointBtn">保存时间点</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模板弹框 -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="templateModalTitle">添加模板</h3>
                <button class="modal-close" id="closeTemplateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateName">模板名称</label>
                    <div class="input-wrapper">
                        <input type="text" id="templateName" placeholder="请输入模板名称">
                        <button class="clear-btn" data-target="templateName">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>选择事项</label>
                    <div class="items-selection">
                        <div class="form-row">
                            <div class="select-wrapper">
                                <select id="availableItems">
                                    <!-- 可用事项将通过JS动态生成 -->
                                </select>
                            </div>
                            <button class="action-btn" id="addItemToTemplateBtn" style="background-color: var(--success-color); color: white;">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                        
                        <div id="selectedItemsList" style="margin-top: 20px;">
                            <!-- 已选择的事项将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveTemplateBtn">保存模板</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 选择模板弹框 -->
    <div class="modal-overlay" id="selectTemplateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">选择使用模板</h3>
                <button class="modal-close" id="closeSelectTemplateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateSelect">选择模板</label>
                    <div class="select-wrapper">
                        <select id="templateSelect">
                            <!-- 模板选项将通过JS动态生成 -->
                        </select>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="confirmTemplateBtn">确定使用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 记录管理弹框 -->
    <div class="modal-overlay" id="recordsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">记录管理</h3>
                <button class="modal-close" id="closeRecordsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="records-tabs">
                    <button class="tab-btn active" data-tab="dailyQueryTab">每日查询</button>
                    <button class="tab-btn" data-tab="weeklyReportTab">周度报告</button>
                </div>
                
                <!-- 每日查询 -->
                <div class="tab-content active" id="dailyQueryTab">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="queryDate">日期</label>
                            <div class="input-wrapper">
                                <input type="date" id="queryDate">
                                <button class="clear-btn" data-target="queryDate">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="queryItem">事项</label>
                            <div class="select-wrapper">
                                <select id="queryItem">
                                    <option value="">全部事项</option>
                                    <!-- 事项选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="queryItem">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="searchRecordsBtn">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                    
                    <div class="query-total-score" id="queryTotalScoreContainer" style="display: none;">
                        <div class="query-total-score-label">当日累计得分</div>
                        <div class="query-total-score-value" id="queryTotalScore">0</div>
                    </div>
                    
                    <div class="daily-query-results">
                        <div class="query-results-panel panel-left">
                            <div class="panel-title">
                                <h4>当日模板事项</h4>
                            </div>
                            <div class="query-results-content">
                                <ul class="records-list" id="queryTemplateList">
                                    <!-- 查询结果将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                        <div class="query-results-panel panel-left">
                            <div class="panel-title">
                                <h4>当日完成记录</h4>
                            </div>
                            <div class="query-results-content">
                                <ul class="records-list" id="queryRecordsList">
                                    <!-- 查询结果将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 周度报告 -->
                <div class="tab-content" id="weeklyReportTab">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="reportWeek">选择周次</label>
                            <div class="input-wrapper">
                                <input type="week" id="reportWeek">
                                <button class="clear-btn" data-target="reportWeek">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="generateReportBtn">
                            <i class="fas fa-chart-bar"></i> 生成报告
                        </button>
                    </div>
                    
                    <div class="report-stats" id="weeklyStats">
                        <!-- 周度统计数据将通过JS动态生成 -->
                    </div>
                    
                    <div class="panel-left">
                        <div class="panel-title">
                            <h3>各项完成情况</h3>
                        </div>
                        <div class="completion-summary" id="completionSummary">
                            <!-- 完成情况将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="panel-left">
                        <div class="panel-title">
                            <h3>每日记录摘要</h3>
                        </div>
                        <div class="completion-summary" id="dailySummary">
                            <!-- 每日摘要将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用说明弹框 -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">使用说明</h3>
                <button class="modal-close" id="closeHelpModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h3>周勤评分系统使用指南</h3>
                <p>本系统旨在帮助您养成良好的习惯，通过评分机制激励自我提升。</p>
                
                <h4>主要功能</h4>
                <ul class="instructions-list">
                    <li><strong>主界面</strong>：用于新增当日记录，查看当前模板事项和当日完成记录。</li>
                    <li><strong>自定义功能</strong>：包括事项及分数管理和模板管理，可自定义评分规则。</li>
                    <li><strong>记录管理</strong>：提供每日查询和周度报告功能，帮助您跟踪习惯养成进度。</li>
                </ul>
                
                <h4>使用流程</h4>
                <ol class="instructions-list">
                    <li>在"自定义功能"中设置您要养成习惯的事项及评分规则</li>
                    <li>创建模板，将相关事项组合在一起方便管理</li>
                    <li>在主界面选择当前使用模板</li>
                    <li>每日完成事项后，在主界面添加记录</li>
                    <li>通过"记录管理"查看进度和统计数据</li>
                </ol>

                <h4>使用须知</h4>
                <ol class="instructions-list" style="color: rgb(76, 92, 185);">
                    <li>所有事项及评分都要事先录入</li>
                    <li>事项录入后，要添加使用模板，系统根据模板来生成拷贝模板，用来主界面显示逻辑和计分</li>
                    <li>周期性事项，使用间隔天数实现，例：每隔三天运动一次，间隔天数即3；默认为0，表示每天都要做。</li>
                    <li>周期性事项在下一次记录之前显示为未到期状态，并显示已经完成日期。</li>
                    <li>当日累计得分：当日完成记录得分 + 显示模板里的事项未完成记录得分</li>
                </ol>
                
                <h4>注意事项</h4>
                <ul class="instructions-list">
                    <li>事项名称不超过5个字</li>
                    <li>间隔天数表示该事项完成后，下次执行间隔的天数</li>
                    <li>同一事项在同一天可以记录多次，都会参与计分</li>
                    <li>数据会自动保存到浏览器本地存储中</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 自定义通知 -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-title" id="notificationTitle">通知</div>
            <button class="notification-close" id="notificationClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-content" id="notificationContent">这是一条通知</div>
    </div>

    <!-- 确认对话框 -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-title" id="confirmTitle">确认操作</div>
            <div class="confirm-message" id="confirmMessage">您确定要执行此操作吗？</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">取消</button>
                <button class="confirm-btn confirm" id="confirmOk">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 周勤评分系统
        class HabitScoreSystem {
            constructor() {
                // 初始化数据
                this.data = {
                    items: [], // 事项列表
                    templates: [], // 模板列表
                    currentTemplateId: null, // 当前使用的模板ID
                    dailyRecords: {}, // 每日记录
                    history: [], // 历史记录
                    currentTemplateCopy: [] // 当前模板拷贝，包含事项状态
                };
                
                // 事项单位类型数组
                this.unitTypes = [
                    { value: 'timePoint', label: '时间点', unit: '时间点' },
                    { value: 'count', label: '次', unit: '次' },
                    { value: 'distance', label: '公里', unit: '公里' },
                    { value: 'duration', label: '时长', unit: '分钟' }
                ];
                
                // 当前编辑的事项ID（用于编辑模式）
                this.editingItemId = null;
                
                // 当前编辑的模板ID（用于编辑模式）
                this.editingTemplateId = null;
                
                // 当前编辑的时间点信息
                this.editingTimePoint = {
                    itemId: null,
                    timePointIndex: null,
                    tempId: null
                };
                
                // 当前编辑的单位评分信息
                this.editingUnitScore = {
                    itemId: null,
                    unitScoreIndex: null,
                    tempId: null
                };
                
                // 模板表单中已选择的事项ID数组
                this.selectedTemplateItems = [];
                
                // 确认对话框回调函数
                this.confirmCallback = null;
                
                // 保存记录时的重复记录确认回调
                this.duplicateRecordCallback = null;
                
                // 保存记录时的数据
                this.pendingRecordData = null;
                
                // 是否已播放过庆祝特效
                this.hasCelebrated = false;
                
                // 模态框关闭控制
                this.modalClickStartOutside = false;
                
                // 初始化
                this.init();
            }
            
            // 初始化系统
            init() {
                this.loadData();
                this.bindEvents();
                this.renderAll();
            }
            
            // 加载数据
            loadData() {
                // 尝试从localStorage加载数据
                const savedData = localStorage.getItem('habitScoreSystem');
                if (savedData) {
                    this.data = JSON.parse(savedData);
                    // 如果模板拷贝不存在，重新生成
                    if (!this.data.currentTemplateCopy || this.data.currentTemplateCopy.length === 0) {
                        this.generateTemplateCopy();
                    }
                } else {
                    // 初始化示例数据
                    this.initSampleData();
                }
            }
            
            // 保存数据
            saveData() {
                localStorage.setItem('habitScoreSystem', JSON.stringify(this.data));
            }
            
            // 初始化示例数据
            initSampleData() {
                // 初始化事项数据
                this.data.items = [
                    {
                        id: 1,
                        name: '早餐',
                        description: '每日早餐',
                        unitType: 'timePoint',
                        intervalDays: 0,
                        unfinishedScore: -2,
                        timePoints: [
                            { id: 1, time: '6:00', score: 4, description: '按时早餐' },
                            { id: 2, time: '7:00', score: 2, description: '稍晚早餐' },
                            { id: 3, time: '8:00', score: 1, description: '迟到早餐' }
                        ]
                    },
                    {
                        id: 2,
                        name: '跑步',
                        description: '日常跑步',
                        unitType: 'distance',
                        intervalDays: 1,
                        unfinishedScore: -3,
                        unitScores: [
                            { id: 1, value: "1~3", unit: '公里', score: 3, description: '1-3公里跑步' },
                            { id: 2, value: "3~5", unit: '公里', score: 5, description: '3-5公里跑步' },
                            { id: 3, value: "5", unit: '公里', score: 8, description: '5公里跑步' }
                        ]
                    },
                    {
                        id: 3,
                        name: '阅读',
                        description: '每日阅读',
                        unitType: 'duration',
                        intervalDays: 0,
                        unfinishedScore: -1,
                        unitScores: [
                            { id: 4, value: "15~30", unit: '分钟', score: 2, description: '15-30分钟阅读' },
                            { id: 5, value: "30~60", unit: '分钟', score: 4, description: '30-60分钟阅读' },
                            { id: 6, value: "60", unit: '分钟', score: 6, description: '60分钟阅读' }
                        ]
                    },
                    {
                        id: 4,
                        name: '俯卧撑',
                        description: '每日锻炼',
                        unitType: 'count',
                        intervalDays: 0,
                        unfinishedScore: -2,
                        unitScores: [
                            { id: 7, value: "10~20", unit: '次', score: 3, description: '10-20次俯卧撑' },
                            { id: 8, value: "20~30", unit: '次', score: 5, description: '20-30次俯卧撑' },
                            { id: 9, value: "30", unit: '次', score: 8, description: '30次俯卧撑' }
                        ]
                    }
                ];
                
                // 初始化模板数据
                this.data.templates = [
                    {
                        id: 1,
                        name: '默认模板',
                        itemIds: [1, 2, 3, 4]
                    },
                    {
                        id: 2,
                        name: '健康模板',
                        itemIds: [1, 2, 4]
                    },
                    {
                        id: 3,
                        name: '学习模板',
                        itemIds: [1, 3]
                    }
                ];
                
                // 设置当前模板
                this.data.currentTemplateId = 1;
                
                // 生成模板拷贝
                this.generateTemplateCopy();
                
                // 初始化今日记录
                const today = this.getTodayDate();
                this.data.dailyRecords = {
                    [today]: {
                        date: today,
                        totalScore: 0,
                        records: [],
                        templateId: 1
                    }
                };
                
                // 初始化历史记录
                this.data.history = [
                    {
                        date: this.getPreviousDayDate(),
                        totalScore: 16,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '6:00', score: 4, isTemplateItem: true },
                            { itemId: 2, itemName: '跑步', value: 3, unit: '公里', score: 5, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 30, unit: '分钟', score: 4, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 20, unit: '次', score: 3, isTemplateItem: true }
                        ],
                        templateId: 1
                    },
                    {
                        date: '2023-10-24',
                        totalScore: 14,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '7:00', score: 2, isTemplateItem: true },
                            { itemId: 2, itemName: '跑步', value: 1, unit: '公里', score: 3, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 15, unit: '分钟', score: 2, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 10, unit: '次', score: 3, isTemplateItem: true }
                        ],
                        templateId: 1
                    },
                    {
                        date: '2023-10-25',
                        totalScore: 12,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '6:00', score: 4, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 60, unit: '分钟', score: 6, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 30, unit: '次', score: 2, isTemplateItem: true }
                        ],
                        templateId: 1
                    }
                ];
                
                this.saveData();
            }
            
            // 获取今天日期字符串
            getTodayDate() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }
            
            // 获取前一天日期字符串
            getPreviousDayDate() {
                const today = new Date();
                const previousDay = new Date(today);
                previousDay.setDate(today.getDate() - 1);
                return previousDay.toISOString().split('T')[0];
            }
            
            // 获取当前模板
            getCurrentTemplate() {
                return this.data.templates.find(t => t.id === this.data.currentTemplateId);
            }
            
            // 生成模板拷贝
            generateTemplateCopy() {
                const currentTemplate = this.getCurrentTemplate();
                if (!currentTemplate) {
                    this.data.currentTemplateCopy = [];
                    return;
                }
                
                const today = this.getTodayDate();
                const todayRecord = this.getTodayRecord();
                
                // 初始化模板拷贝
                this.data.currentTemplateCopy = currentTemplate.itemIds.map(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return null;
                    
                    // 检查今日是否已完成
                    const completedToday = todayRecord.records.some(r => r.itemId === itemId);
                    
                    if (completedToday) {
                        // 今日已完成
                        return {
                            itemId,
                            status: 'completed',
                            completionDate: today
                        };
                    }
                    
                    // 如果间隔天数为0，检查今日是否完成
                    if (item.intervalDays === 0) {
                        // 间隔为0，今日未完成
                        return {
                            itemId,
                            status: 'overdue'
                        };
                    }
                    
                    // 间隔天数大于0，查询历史记录
                    // 从今天往前推，最多查询间隔天数内的记录
                    const intervalDays = item.intervalDays;
                    let foundCompletion = false;
                    let completionDate = null;
                    
                    // 检查今天之前的间隔天数内的记录
                    for (let i = 1; i <= intervalDays; i++) {
                        const checkDate = new Date();
                        checkDate.setDate(checkDate.getDate() - i);
                        const checkDateStr = checkDate.toISOString().split('T')[0];
                        
                        // 检查该日期是否有完成记录
                        const isCompleted = this.isItemCompleted(itemId, checkDateStr);
                        if (isCompleted) {
                            foundCompletion = true;
                            completionDate = checkDateStr;
                            break;
                        }
                    }
                    
                    if (foundCompletion) {
                        // 在间隔天数内找到了完成记录
                        return {
                            itemId,
                            status: 'notDue',
                            completionDate
                        };
                    } else {
                        // 间隔天数内没有完成记录
                        return {
                            itemId,
                            status: 'overdue'
                        };
                    }
                }).filter(item => item !== null);
                
                // 保存数据
                this.saveData();
            }
            
            // 更新模板拷贝中特定事项的状态
            updateTemplateCopyItem(itemId, status, completionDate = null) {
                const copyItem = this.data.currentTemplateCopy.find(c => c.itemId === itemId);
                if (copyItem) {
                    copyItem.status = status;
                    if (completionDate) {
                        copyItem.completionDate = completionDate;
                    }
                    this.saveData();
                }
            }
            
            // 获取今日记录
            getTodayRecord() {
                const today = this.getTodayDate();
                if (!this.data.dailyRecords[today]) {
                    this.data.dailyRecords[today] = {
                        date: today,
                        totalScore: 0,
                        records: [],
                        templateId: this.data.currentTemplateId
                    };
                    // 生成模板拷贝
                    this.generateTemplateCopy();
                    this.saveData();
                }
                return this.data.dailyRecords[today];
            }
            
            // 计算当日累计分数（包括已完成事项和未完成事项的未完成分数）
            calculateDailyTotalScore() {
                const todayRecord = this.getTodayRecord();
                let totalScore = todayRecord.totalScore;
                
                // 遍历模板拷贝，将状态为overdue的事项的未完成分数加入
                this.data.currentTemplateCopy.forEach(copyItem => {
                    if (copyItem.status === 'overdue') {
                        const item = this.getItem(copyItem.itemId);
                        if (item) {
                            totalScore += item.unfinishedScore;
                        }
                    }
                });
                
                return totalScore;
            }
            
            // 计算指定日期的累计分数
            calculateDailyTotalScoreForDate(date) {
                let record = this.data.dailyRecords[date];
                if (!record) {
                    record = this.data.history.find(r => r.date === date);
                }
                
                if (!record) {
                    return 0;
                }
                
                let totalScore = record.totalScore;
                
                // 对于历史日期，我们需要模拟计算模板拷贝的状态
                const template = this.data.templates.find(t => t.id === record.templateId);
                if (template) {
                    // 遍历模板内的所有事项
                    template.itemIds.forEach(itemId => {
                        const item = this.getItem(itemId);
                        if (!item) return;
                        
                        // 检查该事项在指定日期是否已完成
                        const isCompleted = record.records.some(r => r.itemId === itemId);
                        
                        if (!isCompleted) {
                            // 未完成，需要检查是否在间隔天数内
                            if (item.intervalDays === 0) {
                                // 间隔为0，当日未完成，加上未完成分数
                                totalScore += item.unfinishedScore;
                            } else {
                                // 间隔天数大于0，检查间隔天数内的完成记录
                                const targetDate = new Date(date);
                                let foundCompletion = false;
                                
                                for (let i = 1; i <= item.intervalDays; i++) {
                                    const checkDate = new Date(targetDate);
                                    checkDate.setDate(checkDate.getDate() - i);
                                    const checkDateStr = checkDate.toISOString().split('T')[0];
                                    
                                    // 检查该日期是否有完成记录
                                    const isCompletedInHistory = this.isItemCompleted(itemId, checkDateStr);
                                    if (isCompletedInHistory) {
                                        foundCompletion = true;
                                        break;
                                    }
                                }
                                
                                // 如果间隔天数内没有找到完成记录，加上未完成分数
                                if (!foundCompletion) {
                                    totalScore += item.unfinishedScore;
                                }
                            }
                        }
                    });
                }
                
                return totalScore;
            }
            
            // 获取事项
            getItem(itemId) {
                return this.data.items.find(item => item.id === itemId);
            }
            
            // 获取事项名称
            getItemName(itemId) {
                const item = this.getItem(itemId);
                return item ? item.name : '未知事项';
            }
            
            // 获取事项的时间点选项
            getTimeOptions(itemId) {
                const item = this.getItem(itemId);
                if (!item || item.unitType !== 'timePoint') return [];
                
                return item.timePoints.map(tp => ({
                    value: tp.id,
                    text: `${tp.time} (${tp.score >= 0 ? '+' : ''}${tp.score}分) - ${tp.description}`
                }));
            }
            
            // 获取事项的单位评分选项
            getUnitScoreOptions(itemId) {
                const item = this.getItem(itemId);
                if (!item || item.unitType === 'timePoint') return [];
                
                const unitLabel = this.getUnitLabel(item.unitType);
                return item.unitScores.map(us => ({
                    value: us.id,
                    text: `${us.value}${unitLabel} (${us.score >= 0 ? '+' : ''}${us.score}分) - ${us.description}`
                }));
            }
            
            // 获取时间点的分数
            getTimePointScore(timePointId) {
                for (const item of this.data.items) {
                    if (item.unitType !== 'timePoint' || !item.timePoints) continue;
                    const timePoint = item.timePoints.find(tp => tp.id === timePointId);
                    if (timePoint) {
                        return timePoint.score;
                    }
                }
                return 0;
            }
            
            // 获取单位评分的分数
            getUnitScoreScore(unitScoreId) {
                for (const item of this.data.items) {
                    if (item.unitType === 'timePoint' || !item.unitScores) continue;
                    const unitScore = item.unitScores.find(us => us.id === unitScoreId);
                    if (unitScore) {
                        return unitScore.score;
                    }
                }
                return 0;
            }
            
            // 根据来源获取事项列表
            getItemsBySource(source) {
                if (source === 'template') {
                    const currentTemplate = this.getCurrentTemplate();
                    if (!currentTemplate) return [];
                    
                    return this.data.items.filter(item => 
                        currentTemplate.itemIds.includes(item.id)
                    );
                } else {
                    return this.data.items;
                }
            }
            
            // 获取单位标签
            getUnitLabel(unitType) {
                const unit = this.unitTypes.find(u => u.value === unitType);
                return unit ? unit.unit : '单位';
            }
            
            // 检查事项是否已完成
            isItemCompleted(itemId, date = null) {
                const targetDate = date || this.getTodayDate();
                const record = this.data.dailyRecords[targetDate] || 
                              this.data.history.find(r => r.date === targetDate);
                
                if (!record) return false;
                
                return record.records.some(r => r.itemId === itemId);
            }
            
            // 添加记录
            addRecord(itemId, scoreId, isTimePoint = true) {
                const item = this.getItem(itemId);
                if (!item) return false;
                
                const todayRecord = this.getTodayRecord();
                
                // 检查是否已记录过该事项（现在只提示，不阻止）
                const existingRecords = todayRecord.records.filter(r => r.itemId === itemId);
                
                let record;
                
                if (isTimePoint && item.unitType === 'timePoint') {
                    // 获取时间点
                    let timePoint = null;
                    for (const tp of item.timePoints) {
                        if (tp.id === scoreId) {
                            timePoint = tp;
                            break;
                        }
                    }
                    
                    if (!timePoint) {
                        this.showNotification('错误', '未找到对应的时间点', 'error');
                        return false;
                    }
                    
                    // 检查是否为模板内事项
                    const currentTemplate = this.getCurrentTemplate();
                    const isTemplateItem = currentTemplate ? 
                        currentTemplate.itemIds.includes(itemId) : false;
                    
                    // 添加记录
                    record = {
                        itemId,
                        itemName: item.name,
                        time: timePoint.time,
                        score: timePoint.score,
                        isTemplateItem,
                        scoreId,
                        unitType: 'timePoint'
                    };
                } else if (!isTimePoint && item.unitType !== 'timePoint') {
                    // 获取单位评分
                    let unitScore = null;
                    for (const us of item.unitScores) {
                        if (us.id === scoreId) {
                            unitScore = us;
                            break;
                        }
                    }
                    
                    if (!unitScore) {
                        this.showNotification('错误', '未找到对应的评分项', 'error');
                        return false;
                    }
                    
                    // 检查是否为模板内事项
                    const currentTemplate = this.getCurrentTemplate();
                    const isTemplateItem = currentTemplate ? 
                        currentTemplate.itemIds.includes(itemId) : false;
                    
                    // 添加记录
                    record = {
                        itemId,
                        itemName: item.name,
                        value: unitScore.value,
                        unit: unitScore.unit,
                        score: unitScore.score,
                        isTemplateItem,
                        scoreId,
                        unitType: item.unitType
                    };
                } else {
                    this.showNotification('错误', '记录类型不匹配', 'error');
                    return false;
                }
                
                todayRecord.records.push(record);
                todayRecord.totalScore += record.score;
                
                // 如果记录在模板内，更新模板拷贝状态
                if (record.isTemplateItem) {
                    this.updateTemplateCopyItem(itemId, 'completed', this.getTodayDate());
                }
                
                this.saveData();
                
                // 检查是否是第一条记录，如果是则触发庆祝特效
                if (todayRecord.records.length === 1) {
                    this.triggerCelebration();
                } else {
                    this.showNotification('成功', '记录添加成功', 'success');
                }
                
                // 更新当日累计分数显示
                this.updateDailyTotalScore();
                
                return true;
            }
            
            // 触发庆祝特效
            triggerCelebration() {
                // 显示庆祝消息
                const celebrationMessage = document.getElementById('celebrationMessage');
                celebrationMessage.classList.add('active');
                
                // 显示烟花特效
                const fireworksContainer = document.getElementById('fireworksContainer');
                fireworksContainer.classList.add('active');
                
                // 生成烟花
                this.createFireworks();
                
                // 3秒后隐藏庆祝消息
                setTimeout(() => {
                    celebrationMessage.classList.remove('active');
                }, 3000);
                
                // 5秒后停止烟花
                setTimeout(() => {
                    fireworksContainer.classList.remove('active');
                    // 清空烟花容器
                    fireworksContainer.innerHTML = '';
                }, 5000);
                
                this.showNotification('成功', '记录添加成功！今日首次签到！', 'success');
            }
            
            // 创建烟花效果
            createFireworks() {
                const container = document.getElementById('fireworksContainer');
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#ff0088'];
                
                // 创建多个烟花
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        
                        // 随机位置
                        const left = Math.random() * 100;
                        const top = Math.random() * 100;
                        
                        // 随机颜色
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        firework.style.left = `${left}%`;
                        firework.style.top = `${top}%`;
                        firework.style.backgroundColor = color;
                        firework.style.boxShadow = `0 0 10px ${color}, 0 0 20px ${color}`;
                        
                        container.appendChild(firework);
                        
                        // 添加爆炸效果
                        this.explodeFirework(firework, color);
                        
                        // 2秒后移除烟花
                        setTimeout(() => {
                            if (firework.parentNode) {
                                firework.parentNode.removeChild(firework);
                            }
                        }, 2000);
                        
                    }, i * 150);
                }
            }
            
            // 烟花爆炸效果
            explodeFirework(firework, color) {
                setTimeout(() => {
                    const container = firework.parentNode;
                    const rect = firework.getBoundingClientRect();
                    
                    // 创建爆炸粒子
                    for (let i = 0; i < 12; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework';
                        
                        // 计算粒子位置
                        const angle = (i / 12) * Math.PI * 2;
                        const distance = 30 + Math.random() * 40;
                        
                        particle.style.left = `50%`;
                        particle.style.top = `50%`;
                        particle.style.width = '3px';
                        particle.style.height = '3px';
                        particle.style.backgroundColor = color;
                        particle.style.boxShadow = `0 0 5px ${color}`;
                        particle.style.position = 'absolute';
                        particle.style.transform = `translate(-50%, -50%)`;
                        
                        container.appendChild(particle);
                        
                        // 动画
                        setTimeout(() => {
                            particle.style.transition = 'all 0.8s ease-out';
                            particle.style.left = `${50 + Math.cos(angle) * distance}%`;
                            particle.style.top = `${50 + Math.sin(angle) * distance}%`;
                            particle.style.opacity = '0';
                            
                            // 移除粒子
                            setTimeout(() => {
                                if (particle.parentNode) {
                                    particle.parentNode.removeChild(particle);
                                }
                            }, 800);
                        }, 10);
                    }
                }, 500);
            }
            
            // 删除记录
            deleteRecord(date, recordIndex) {
                const record = this.data.dailyRecords[date] || 
                              this.data.history.find(r => r.date === date);
                
                if (!record || !record.records[recordIndex]) return false;
                
                const deletedRecord = record.records[recordIndex];
                
                // 更新总分
                record.totalScore -= deletedRecord.score;
                
                // 如果删除的是模板内事项，重新生成模板拷贝
                if (deletedRecord.isTemplateItem && date === this.getTodayDate()) {
                    // 删除记录
                    record.records.splice(recordIndex, 1);
                    // 重新生成模板拷贝
                    this.generateTemplateCopy();
                } else {
                    // 删除记录
                    record.records.splice(recordIndex, 1);
                }
                
                this.saveData();
                return true;
            }
            
            // 添加事项
            addItem(itemData) {
                // 检查事项名称是否已存在
                const existingItem = this.data.items.find(item => item.name === itemData.name);
                if (existingItem) {
                    return false; // 名称已存在
                }
                
                // 生成新ID
                const newId = this.data.items.length > 0 ? 
                    Math.max(...this.data.items.map(i => i.id)) + 1 : 1;
                
                // 创建新事项
                const newItem = {
                    id: newId,
                    ...itemData
                };
                
                this.data.items.push(newItem);
                this.saveData();
                return newId;
            }
            
            // 更新事项
            updateItem(itemId, itemData) {
                const index = this.data.items.findIndex(i => i.id === itemId);
                if (index === -1) return false;
                
                // 检查事项名称是否已存在（除了自己）
                const existingItem = this.data.items.find(item => item.name === itemData.name && item.id !== itemId);
                if (existingItem) {
                    return false; // 名称已存在
                }
                
                // 保留ID
                itemData.id = itemId;
                this.data.items[index] = itemData;
                this.saveData();
                return true;
            }
            
            // 删除事项
            deleteItem(itemId) {
                const index = this.data.items.findIndex(i => i.id === itemId);
                if (index === -1) return false;
                
                // 从所有模板中移除该事项
                for (const template of this.data.templates) {
                    const itemIndex = template.itemIds.indexOf(itemId);
                    if (itemIndex !== -1) {
                        template.itemIds.splice(itemIndex, 1);
                    }
                }
                
                // 从模板拷贝中移除
                this.data.currentTemplateCopy = this.data.currentTemplateCopy.filter(c => c.itemId !== itemId);
                
                // 删除事项
                this.data.items.splice(index, 1);
                this.saveData();
                return true;
            }
            
            // 添加模板
            addTemplate(templateData) {
                // 检查模板名称是否已存在
                const existingTemplate = this.data.templates.find(t => t.name === templateData.name);
                if (existingTemplate) {
                    return false; // 名称已存在
                }
                
                // 生成新ID
                const newId = this.data.templates.length > 0 ? 
                    Math.max(...this.data.templates.map(t => t.id)) + 1 : 1;
                
                // 创建新模板
                const newTemplate = {
                    id: newId,
                    ...templateData
                };
                
                this.data.templates.push(newTemplate);
                this.saveData();
                return newId;
            }
            
            // 更新模板
            updateTemplate(templateId, templateData) {
                const index = this.data.templates.findIndex(t => t.id === templateId);
                if (index === -1) return false;
                
                // 检查模板名称是否已存在（除了自己）
                const existingTemplate = this.data.templates.find(t => t.name === templateData.name && t.id !== templateId);
                if (existingTemplate) {
                    return false; // 名称已存在
                }
                
                // 保留ID
                templateData.id = templateId;
                this.data.templates[index] = templateData;
                this.saveData();
                return true;
            }
            
            // 删除模板
            deleteTemplate(templateId) {
                // 不能删除当前使用的模板
                if (templateId === this.data.currentTemplateId) {
                    return false;
                }
                
                const index = this.data.templates.findIndex(t => t.id === templateId);
                if (index === -1) return false;
                
                this.data.templates.splice(index, 1);
                this.saveData();
                return true;
            }
            
            // 设置当前模板
            setCurrentTemplate(templateId) {
                const template = this.data.templates.find(t => t.id === templateId);
                if (!template) return false;
                
                this.data.currentTemplateId = templateId;
                
                // 更新今日记录的模板ID
                const todayRecord = this.getTodayRecord();
                todayRecord.templateId = templateId;
                
                // 重新生成模板拷贝
                this.generateTemplateCopy();
                
                this.saveData();
                return true;
            }
            
            // 查询每日记录
            queryDailyRecords(date, itemFilter = '') {
                let record = this.data.dailyRecords[date];
                if (!record) {
                    record = this.data.history.find(r => r.date === date);
                }
                
                if (!record) {
                    return {
                        totalScore: 0,
                        templateItems: [],
                        records: []
                    };
                }
                
                // 获取当日模板
                const template = this.data.templates.find(t => t.id === record.templateId);
                const templateItems = template ? template.itemIds.map(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return null;
                    
                    const completed = record.records.some(r => r.itemId === itemId);
                    
                    // 确定状态
                    let status = 'overdue';
                    let completionDate = null;
                    
                    if (completed) {
                        status = 'completed';
                        completionDate = date;
                    } else if (item.intervalDays > 0) {
                        // 检查间隔天数内的完成记录
                        const targetDate = new Date(date);
                        let foundCompletion = false;
                        
                        for (let i = 1; i <= item.intervalDays; i++) {
                            const checkDate = new Date(targetDate);
                            checkDate.setDate(checkDate.getDate() - i);
                            const checkDateStr = checkDate.toISOString().split('T')[0];
                            
                            // 检查该日期是否有完成记录
                            const isCompletedInHistory = this.isItemCompleted(itemId, checkDateStr);
                            if (isCompletedInHistory) {
                                foundCompletion = true;
                                completionDate = checkDateStr;
                                break;
                            }
                        }
                        
                        if (foundCompletion) {
                            status = 'notDue';
                        }
                    }
                    
                    return {
                        itemId,
                        name: item.name,
                        intervalDays: item.intervalDays,
                        unfinishedScore: item.unfinishedScore,
                        status,
                        completionDate
                    };
                }).filter(item => item !== null) : [];
                
                // 过滤记录
                let records = record.records;
                if (itemFilter) {
                    records = records.filter(r => r.itemName === itemFilter);
                }
                
                return {
                    totalScore: this.calculateDailyTotalScoreForDate(date),
                    templateItems,
                    records
                };
            }
            
            // 生成周度报告
            generateWeeklyReport(startDateStr) {
                // 计算一周的日期范围
                const startDate = new Date(startDateStr);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                // 获取该周的所有记录
                const weekRecords = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    let record = this.data.dailyRecords[dateStr];
                    if (!record) {
                        record = this.data.history.find(r => r.date === dateStr);
                    }
                    if (record) {
                        weekRecords.push(record);
                    }
                }
                
                if (weekRecords.length === 0) {
                    return null;
                }
                
                // 计算统计数据
                const stats = {
                    recordDays: weekRecords.length,
                    interruptDays: 7 - weekRecords.length,
                    longestStreak: 0,
                    currentStreak: 0,
                    totalScore: 0,
                    maxDailyScore: -Infinity,
                    minDailyScore: Infinity,
                    averageScore: 0,
                    itemsCompletion: {}
                };
                
                // 计算连续天数
                let currentStreak = 0;
                let longestStreak = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const hasRecord = weekRecords.some(r => r.date === dateStr);
                    
                    if (hasRecord) {
                        currentStreak++;
                        longestStreak = Math.max(longestStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                }
                
                stats.longestStreak = longestStreak;
                stats.currentStreak = currentStreak;
                
                // 计算分数统计
                for (const record of weekRecords) {
                    const dailyTotal = this.calculateDailyTotalScoreForDate(record.date);
                    stats.totalScore += dailyTotal;
                    stats.maxDailyScore = Math.max(stats.maxDailyScore, dailyTotal);
                    stats.minDailyScore = Math.min(stats.minDailyScore, dailyTotal);
                    
                    // 统计事项完成情况
                    for (const r of record.records) {
                        if (!stats.itemsCompletion[r.itemName]) {
                            stats.itemsCompletion[r.itemName] = {
                                count: 0,
                                totalScore: 0
                            };
                        }
                        stats.itemsCompletion[r.itemName].count++;
                        stats.itemsCompletion[r.itemName].totalScore += r.score;
                    }
                }
                
                stats.averageScore = stats.recordDays > 0 ? stats.totalScore / stats.recordDays : 0;
                
                return {
                    weekStart: startDateStr,
                    weekEnd: endDate.toISOString().split('T')[0],
                    records: weekRecords,
                    stats
                };
            }
            
            // 绑定事件
            bindEvents() {
                // 头部按钮事件
                document.getElementById('customizeBtn').addEventListener('click', () => {
                    this.openModal('customizeModal');
                });
                
                document.getElementById('recordsBtn').addEventListener('click', () => {
                    this.openModal('recordsModal');
                    // 设置默认查询日期为前一天
                    document.getElementById('queryDate').value = this.getPreviousDayDate();
                    // 更新事项查询下拉框
                    this.updateQueryItemOptions();
                    // 自动查询前一天数据
                    setTimeout(() => {
                        this.searchDailyRecords();
                    }, 100);
                });
                
                document.getElementById('helpBtn').addEventListener('click', () => {
                    this.openModal('helpModal');
                });
                
                // 关闭按钮事件
                document.getElementById('closeCustomizeModal').addEventListener('click', () => {
                    this.closeModal('customizeModal');
                });
                
                document.getElementById('closeRecordsModal').addEventListener('click', () => {
                    this.closeModal('recordsModal');
                });
                
                document.getElementById('closeHelpModal').addEventListener('click', () => {
                    this.closeModal('helpModal');
                });
                
                document.getElementById('closeAddItemModal').addEventListener('click', () => {
                    this.closeModal('addItemModal');
                    this.editingItemId = null;
                });
                
                document.getElementById('closeTemplateModal').addEventListener('click', () => {
                    this.closeModal('templateModal');
                    this.editingTemplateId = null;
                });
                
                document.getElementById('closeSelectTemplateModal').addEventListener('click', () => {
                    this.closeModal('selectTemplateModal');
                });
                
                document.getElementById('closeEditTimePointModal').addEventListener('click', () => {
                    this.closeModal('editTimePointModal');
                    this.editingTimePoint = {
                        itemId: null,
                        timePointIndex: null,
                        tempId: null
                    };
                });
                
                // 重复记录确认对话框按钮
                document.getElementById('duplicateRecordCancel').addEventListener('click', () => {
                    this.hideDuplicateRecordDialog();
                });
                
                document.getElementById('duplicateRecordConfirm').addEventListener('click', () => {
                    if (this.duplicateRecordCallback && this.pendingRecordData) {
                        const { itemId, scoreId, isTimePoint } = this.pendingRecordData;
                        this.duplicateRecordCallback(itemId, scoreId, isTimePoint);
                    }
                    this.hideDuplicateRecordDialog();
                });
                
                // 点击遮罩层关闭弹框 - 修改为需要鼠标按下和抬起都在弹框外
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('mousedown', (e) => {
                        if (e.target === overlay) {
                            this.modalClickStartOutside = true;
                        } else {
                            this.modalClickStartOutside = false;
                        }
                    });
                    
                    overlay.addEventListener('mouseup', (e) => {
                        if (e.target === overlay && this.modalClickStartOutside) {
                            overlay.classList.remove('active');
                            this.editingItemId = null;
                            this.editingTemplateId = null;
                            this.editingTimePoint = {
                                itemId: null,
                                timePointIndex: null,
                                tempId: null
                            };
                        }
                        this.modalClickStartOutside = false;
                    });
                });
                
                // 标签切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tabId = e.target.getAttribute('data-tab');
                        this.switchTab(tabId);
                        
                        // 如果是周度报告标签，自动生成报告
                        if (tabId === 'weeklyReportTab') {
                            setTimeout(() => {
                                this.generateWeeklyReportFromForm();
                            }, 100);
                        }
                    });
                });
                
                // 添加事项按钮
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.openAddItemModal();
                });
                
                // 单位类型改变事件
                document.getElementById('itemUnitType').addEventListener('change', () => {
                    this.toggleUnitTypeSection();
                });
                
                // 添加时间点按钮
                document.getElementById('addTimePointBtn').addEventListener('click', () => {
                    this.addTimePointToForm();
                });
                
                // 添加单位评分按钮
                document.getElementById('addUnitScoreBtn').addEventListener('click', () => {
                    this.addUnitScoreToForm();
                });
                
                // 保存事项按钮
                document.getElementById('saveItemBtn').addEventListener('click', () => {
                    this.saveItemFromForm();
                });
                
                // 添加模板按钮
                document.getElementById('addTemplateBtn').addEventListener('click', () => {
                    this.openTemplateModal();
                });
                
                // 修改模板按钮
                document.getElementById('changeTemplateBtn').addEventListener('click', () => {
                    this.openSelectTemplateModal();
                });
                
                // 保存模板按钮
                document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                    this.saveTemplateFromForm();
                });
                
                // 确认模板选择
                document.getElementById('confirmTemplateBtn').addEventListener('click', () => {
                    this.confirmTemplateSelection();
                });
                
                // 保存记录按钮
                document.getElementById('saveRecordBtn').addEventListener('click', () => {
                    this.saveRecordFromForm();
                });
                
                // 搜索记录按钮
                document.getElementById('searchRecordsBtn').addEventListener('click', () => {
                    this.searchDailyRecords();
                });
                
                // 生成报告按钮
                document.getElementById('generateReportBtn').addEventListener('click', () => {
                    this.generateWeeklyReportFromForm();
                });
                
                // 保存时间点按钮
                document.getElementById('saveTimePointBtn').addEventListener('click', () => {
                    this.saveTimePointFromForm();
                });
                
                // 事项选择改变事件
                document.getElementById('itemSelect').addEventListener('change', () => {
                    this.updateCurrentScore();
                    this.updateScoreOptions();
                });
                
                // 时间点选择改变事件
                document.getElementById('timeSelect').addEventListener('change', () => {
                    this.updateCurrentScore();
                });
                
                // 事项来源改变事件
                document.getElementById('itemSource').addEventListener('change', () => {
                    this.updateItemOptions();
                });
                
                // 清空按钮事件
                document.querySelectorAll('.clear-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // 防止事件冒泡
                        const targetId = e.target.closest('.clear-btn').getAttribute('data-target');
                        this.clearInput(targetId);
                    });
                });
                
                // 通知关闭按钮
                document.getElementById('notificationClose').addEventListener('click', () => {
                    this.hideNotification();
                });
                
                // 确认对话框按钮
                document.getElementById('confirmCancel').addEventListener('click', () => {
                    this.hideConfirmDialog();
                });
                
                document.getElementById('confirmOk').addEventListener('click', () => {
                    if (this.confirmCallback) {
                        this.confirmCallback();
                    }
                    this.hideConfirmDialog();
                });
                
                // 添加事项到模板按钮
                document.getElementById('addItemToTemplateBtn').addEventListener('click', () => {
                    this.addItemToTemplateForm();
                });
                
                // 初始化小时选择器
                this.initHourSelectors();
                
                // 设置今天日期
                document.getElementById('queryDate').value = this.getTodayDate();
                
                // 设置本周
                this.setCurrentWeek();
            }
            
            // 设置当前周
            setCurrentWeek() {
                const today = new Date();
                const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                const year = firstDayOfWeek.getFullYear();
                const month = String(firstDayOfWeek.getMonth() + 1).padStart(2, '0');
                const day = String(firstDayOfWeek.getDate()).padStart(2, '0');
                document.getElementById('reportWeek').value = `${year}-W${String(Math.ceil((firstDayOfWeek.getDate() + firstDayOfWeek.getDay()) / 7)).padStart(2, '0')}`;
            }
            
            // 初始化小时选择器
            initHourSelectors() {
                const hourSelectors = document.querySelectorAll('.time-hour');
                hourSelectors.forEach(select => {
                    // 清空现有选项
                    select.innerHTML = '<option value="">时</option>';
                    
                    // 添加小时选项
                    for (let i = 0; i < 24; i++) {
                        const hour = i.toString().padStart(2, '0');
                        const option = document.createElement('option');
                        option.value = hour;
                        option.textContent = hour;
                        select.appendChild(option);
                    }
                });
            }
            
            // 渲染所有内容
            renderAll() {
                this.renderTemplateList();
                this.renderDailyRecords();
                this.renderItemsList();
                this.renderTemplatesCards();
                this.updateItemOptions();
                this.updateCurrentTemplateName();
                this.updateCurrentTemplateDisplay();
                
                // 更新当日累计得分
                this.updateDailyTotalScore();
            }
            
            // 更新当日累计得分
            updateDailyTotalScore() {
                const totalScore = this.calculateDailyTotalScore();
                document.getElementById('dailyTotal').textContent = totalScore;
            }
            
            // 更新当前模板显示
            updateCurrentTemplateDisplay() {
                const currentTemplate = this.getCurrentTemplate();
                if (currentTemplate) {
                    document.getElementById('currentTemplateDisplay').textContent = currentTemplate.name;
                } else {
                    document.getElementById('currentTemplateDisplay').textContent = '无';
                }
            }
            
            // 渲染模板事项列表（使用模板拷贝）
            renderTemplateList() {
                const templateList = document.getElementById('templateList');
                templateList.innerHTML = '';
                
                const currentTemplate = this.getCurrentTemplate();
                if (!currentTemplate || this.data.currentTemplateCopy.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'template-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">暂无模板</div>
                            <div class="item-details">请先在自定义功能中添加模板</div>
                        </div>
                    `;
                    templateList.appendChild(li);
                    return;
                }
                
                this.data.currentTemplateCopy.forEach(copyItem => {
                    const item = this.getItem(copyItem.itemId);
                    if (!item) return;
                    
                    let className = 'template-item';
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (copyItem.status) {
                        case 'completed':
                            className += ' completed';
                            statusText = '已完成';
                            statusClass = 'positive';
                            break;
                        case 'notDue':
                            className += ' completed';
                            statusText = '未到期';
                            statusClass = 'positive';
                            break;
                        case 'overdue':
                            className += ' overdue';
                            statusText = '未完成';
                            statusClass = 'negative';
                            break;
                    }
                    
                    const li = document.createElement('li');
                    li.className = className;
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                <span>间隔: ${item.intervalDays}天</span>
                                <span>未完成: ${item.unfinishedScore}分</span>
                            </div>
                        </div>
                        <div class="item-score ${statusClass}">
                            ${statusText}
                            ${copyItem.completionDate ? `<div class="completion-date">${copyItem.completionDate}</div>` : ''}
                        </div>
                    `;
                    templateList.appendChild(li);
                });
            }
            
            // 渲染当日记录
            renderDailyRecords() {
                const recordsList = document.getElementById('dailyRecordsList');
                recordsList.innerHTML = '';
                
                const todayRecord = this.getTodayRecord();
                
                if (!todayRecord.records || todayRecord.records.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">暂无记录</div>
                            <div class="item-details">今日尚未添加任何记录</div>
                        </div>
                    `;
                    recordsList.appendChild(li);
                    return;
                }
                
                // 更新当日累计得分
                this.updateDailyTotalScore();
                
                todayRecord.records.forEach((record, index) => {
                    const li = document.createElement('li');
                    li.className = `record-item ${record.isTemplateItem ? 'template' : 'non-template'}`;
                    
                    let detailsHtml = '';
                    if (record.unitType === 'timePoint') {
                        detailsHtml = `<span>时间: ${record.time}</span>`;
                    } else {
                        detailsHtml = `<span>${record.value}${record.unit}</span>`;
                    }
                    detailsHtml += `<span>${record.isTemplateItem ? '模板内事项' : '额外事项'}</span>`;
                    
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${record.itemName}</div>
                            <div class="item-details">
                                ${detailsHtml}
                            </div>
                        </div>
                        <div class="item-score ${record.score >= 0 ? 'positive' : 'negative'}">
                            ${record.score >= 0 ? '+' : ''}${record.score}
                        </div>
                        <div class="item-actions">
                            <button class="small-delete-btn" data-index="${index}" title="删除记录">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    recordsList.appendChild(li);
                });
                
                // 绑定删除按钮事件
                recordsList.querySelectorAll('.small-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('.small-delete-btn').getAttribute('data-index'));
                        this.deleteTodayRecord(index);
                    });
                });
            }
            
            // 删除当日记录
            deleteTodayRecord(index) {
                this.showConfirmDialog('确认删除', '确定要删除这条记录吗？', () => {
                    const today = this.getTodayDate();
                    if (this.deleteRecord(today, index)) {
                        this.showNotification('成功', '记录删除成功', 'success');
                        this.renderDailyRecords();
                        this.renderTemplateList();
                        this.updateDailyTotalScore();
                    } else {
                        this.showNotification('错误', '删除记录失败', 'error');
                    }
                });
            }
            
            // 渲染事项列表
            renderItemsList() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (this.data.items.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'item-card';
                    li.innerHTML = `
                        <div class="item-header">
                            <div class="item-info">
                                <div class="item-name">暂无事项</div>
                                <div class="item-details">请点击"添加事项"按钮创建新事项</div>
                            </div>
                        </div>
                    `;
                    itemsList.appendChild(li);
                    return;
                }
                
                this.data.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'item-card';
                    li.innerHTML = `
                        <div class="item-header" onclick="habitSystem.toggleItemContent(this)">
                            <div class="item-header-title">
                                <span class="item-index">${index + 1}</span>
                                <div class="item-main-info">
                                    <div class="item-name-container">${item.name}</div>
                                    <div class="item-stats">
                                        <div class="item-stat">
                                            <i class="fas fa-calendar-day"></i>
                                            <span>间隔: ${item.intervalDays}天</span>
                                        </div>
                                        <div class="item-stat">
                                            <i class="fas fa-minus-circle"></i>
                                            <span>未完成: ${item.unfinishedScore}分</span>
                                        </div>
                                        <div class="item-stat">
                                            <i class="fas fa-ruler"></i>
                                            <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                        </div>
                                    </div>
                                </div>
                                <span class="item-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-id="${item.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="action-btn delete-btn" data-id="${item.id}">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="item-content">
                            <div class="item-details">
                                <p><strong>事项说明:</strong> ${item.description || '无'}</p>
                            </div>
                            <h4>${item.unitType === 'timePoint' ? '时间点及分数:' : '评分项:'}</h4>
                            <ul class="sub-items-list">
                                ${item.unitType === 'timePoint' ? 
                                    (item.timePoints ? item.timePoints.map((tp, tpIndex) => `
                                        <li class="sub-item">
                                            <div class="sub-item-info">
                                                <div class="sub-item-time">${tp.time}</div>
                                                <div class="sub-item-score ${tp.score >= 0 ? 'positive' : 'negative'}">${tp.score >= 0 ? '+' : ''}${tp.score}</div>
                                                <div class="sub-item-description">${tp.description}</div>
                                            </div>
                                            <div class="sub-item-actions">
                                                <button class="action-btn delete-btn" data-item-id="${item.id}" data-tp-index="${tpIndex}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('') : '<li>暂无时间点</li>') : 
                                    (item.unitScores ? item.unitScores.map((us, usIndex) => `
                                        <li class="sub-item">
                                            <div class="sub-item-info">
                                                <div class="sub-item-time">${us.value}${us.unit}</div>
                                                <div class="sub-item-score ${us.score >= 0 ? 'positive' : 'negative'}">${us.score >= 0 ? '+' : ''}${us.score}</div>
                                                <div class="sub-item-description">${us.description}</div>
                                            </div>
                                            <div class="sub-item-actions">
                                                <button class="action-btn delete-btn" data-item-id="${item.id}" data-us-index="${usIndex}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('') : '<li>暂无评分项</li>')
                                }
                            </ul>
                        </div>
                    `;
                    itemsList.appendChild(li);
                });
                
                // 绑定事件
                itemsList.querySelectorAll('.edit-btn[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.edit-btn').getAttribute('data-id'));
                        this.editItem(itemId);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-id'));
                        this.deleteItemConfirm(itemId);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-item-id][data-tp-index]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-item-id'));
                        const tpIndex = parseInt(e.target.closest('.delete-btn').getAttribute('data-tp-index'));
                        this.deleteTimePointConfirm(itemId, tpIndex);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-item-id][data-us-index]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-item-id'));
                        const usIndex = parseInt(e.target.closest('.delete-btn').getAttribute('data-us-index'));
                        this.deleteUnitScoreConfirm(itemId, usIndex);
                    });
                });
            }
            
            // 渲染模板卡片
            renderTemplatesCards() {
                const templatesContainer = document.getElementById('templatesContainer');
                templatesContainer.innerHTML = '';
                
                if (this.data.templates.length === 0) {
                    templatesContainer.innerHTML = `
                        <div style="text-align: center; padding: 25px; color: var(--gray-color);">
                            暂无模板，请点击"添加模板"按钮创建
                        </div>
                    `;
                    return;
                }
                
                this.data.templates.forEach((template, index) => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card';
                    
                    // 计算平均间隔天数和包含事项数
                    let avgInterval = 0;
                    let itemsCount = 0;
                    if (template.itemIds.length > 0) {
                        let totalInterval = 0;
                        template.itemIds.forEach(itemId => {
                            const item = this.getItem(itemId);
                            if (item) {
                                totalInterval += item.intervalDays;
                                itemsCount++;
                            }
                        });
                        avgInterval = itemsCount > 0 ? Math.round(totalInterval / itemsCount) : 0;
                    }
                    
                    templateCard.innerHTML = `
                        <div class="template-card-header" onclick="habitSystem.toggleTemplateCard(this)">
                            <div class="template-card-title">
                                <span class="template-card-index">${index + 1}</span>
                                <div class="template-main-info">
                                    <div class="template-name-container">${template.name}</div>
                                    <div class="template-stats">
                                        <div class="template-stat">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>平均间隔: ${avgInterval}天</span>
                                        </div>
                                        <div class="template-stat">
                                            <i class="fas fa-list-ol"></i>
                                            <span>包含: ${itemsCount}项</span>
                                        </div>
                                    </div>
                                </div>
                                ${template.id === this.data.currentTemplateId ? '<span style="color: green; font-weight: 600; margin-left: 10px;">(使用中)</span>' : ''}
                                <span class="template-card-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-template-id="${template.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" data-template-id="${template.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${template.id !== this.data.currentTemplateId ? `
                                    <button class="action-btn" style="background: linear-gradient(135deg, var(--success-color), #38a169); color: white;" data-template-id="${template.id}">
                                        <i class="fas fa-check"></i> 使用
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="template-card-content">
                            <div class="item-details">
                                <p><strong>模板说明:</strong> 包含${itemsCount}个事项，平均间隔${avgInterval}天</p>
                            </div>
                            <h4>包含事项:</h4>
                            <ul class="template-items-list">
                                ${template.itemIds.map(itemId => {
                                    const item = this.getItem(itemId);
                                    if (!item) return '';
                                    return `
                                        <li class="template-item-detail">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-details">
                                                <span>间隔天数: ${item.intervalDays}</span>
                                                <span>未完成分数: ${item.unfinishedScore}</span>
                                                <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                            </div>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                    templatesContainer.appendChild(templateCard);
                });
                
                // 绑定事件
                templatesContainer.querySelectorAll('.edit-btn[data-template-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = parseInt(e.target.closest('.edit-btn').getAttribute('data-template-id'));
                        this.editTemplate(templateId);
                    });
                });
                
                templatesContainer.querySelectorAll('.delete-btn[data-template-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = parseInt(e.target.closest('.delete-btn').getAttribute('data-template-id'));
                        this.deleteTemplateConfirm(templateId);
                    });
                });
                
                templatesContainer.querySelectorAll('.action-btn[data-template-id]').forEach(btn => {
                    if (btn.style.background.includes('var(--success-color)')) {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const templateId = parseInt(e.target.closest('.action-btn').getAttribute('data-template-id'));
                            this.setCurrentTemplate(templateId);
                            this.showNotification('成功', '模板切换成功', 'success');
                            this.renderAll();
                        });
                    }
                });
            }
            
            // 更新事项选项
            updateItemOptions() {
                const source = document.getElementById('itemSource').value;
                const itemSelect = document.getElementById('itemSelect');
                
                // 清空当前选项（保留第一个提示选项）
                itemSelect.innerHTML = '<option value="">请选择事项</option>';
                
                const items = this.getItemsBySource(source);
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${this.getUnitLabel(item.unitType)})`;
                    itemSelect.appendChild(option);
                });
                
                // 更新分数选项
                this.updateScoreOptions();
            }
            
            // 更新分数选项
            updateScoreOptions() {
                const itemId = parseInt(document.getElementById('itemSelect').value);
                const timeSelect = document.getElementById('timeSelect');
                
                // 清空当前选项
                timeSelect.innerHTML = '<option value="">请选择评分项</option>';
                
                if (!itemId) {
                    // 添加提示选项
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '不存在的评分项请至事项管理处添加';
                    option.disabled = true;
                    timeSelect.appendChild(option);
                    return;
                }
                
                const item = this.getItem(itemId);
                if (!item) return;
                
                if (item.unitType === 'timePoint') {
                    const timeOptions = this.getTimeOptions(itemId);
                    if (timeOptions.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '该事项没有时间点，请先添加';
                        option.disabled = true;
                        timeSelect.appendChild(option);
                    } else {
                        timeOptions.forEach(optionData => {
                            const option = document.createElement('option');
                            option.value = optionData.value;
                            option.textContent = optionData.text;
                            timeSelect.appendChild(option);
                        });
                    }
                } else {
                    const unitOptions = this.getUnitScoreOptions(itemId);
                    if (unitOptions.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '该事项没有评分项，请先添加';
                        option.disabled = true;
                        timeSelect.appendChild(option);
                    } else {
                        unitOptions.forEach(optionData => {
                            const option = document.createElement('option');
                            option.value = optionData.value;
                            option.textContent = optionData.text;
                            timeSelect.appendChild(option);
                        });
                    }
                }
            }
            
            // 更新查询事项选项
            updateQueryItemOptions() {
                const queryItemSelect = document.getElementById('queryItem');
                
                // 清空当前选项（保留第一个提示选项）
                queryItemSelect.innerHTML = '<option value="">全部事项</option>';
                
                this.data.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} (${this.getUnitLabel(item.unitType)})`;
                    queryItemSelect.appendChild(option);
                });
            }
            
            // 更新当前得分
            updateCurrentScore() {
                const itemId = parseInt(document.getElementById('itemSelect').value);
                const scoreId = parseInt(document.getElementById('timeSelect').value);
                
                if (itemId && scoreId) {
                    const item = this.getItem(itemId);
                    let score = 0;
                    
                    if (item.unitType === 'timePoint') {
                        score = this.getTimePointScore(scoreId);
                    } else {
                        score = this.getUnitScoreScore(scoreId);
                    }
                    
                    const scoreElement = document.getElementById('currentScore');
                    scoreElement.textContent = score >= 0 ? `+${score}` : score;
                    scoreElement.className = `current-score-value ${score >= 0 ? 'positive' : 'negative'}`;
                } else {
                    document.getElementById('currentScore').textContent = '0';
                    document.getElementById('currentScore').className = 'current-score-value';
                }
            }
            
            // 更新当前模板名称
            updateCurrentTemplateName() {
                const currentTemplate = this.getCurrentTemplate();
                document.getElementById('currentTemplateName').textContent = currentTemplate ? currentTemplate.name : '无';
            }
            
            // 打开添加事项模态框
            openAddItemModal(itemId = null) {
                this.editingItemId = itemId;
                
                // 设置标题
                document.getElementById('addItemModalTitle').textContent = 
                    itemId ? '编辑事项' : '添加事项';
                
                // 清空表单
                this.clearAddItemForm();
                
                // 如果是编辑模式，填充数据
                if (itemId) {
                    const item = this.getItem(itemId);
                    if (item) {
                        document.getElementById('itemName').value = item.name;
                        document.getElementById('itemUnitType').value = item.unitType;
                        document.getElementById('intervalDays').value = item.intervalDays;
                        document.getElementById('unfinishedScore').value = item.unfinishedScore;
                        document.getElementById('itemDescription').value = item.description || '';
                        
                        // 切换单位类型显示
                        this.toggleUnitTypeSection();
                        
                        // 清空现有评分项
                        if (item.unitType === 'timePoint') {
                            document.getElementById('timePointsList').innerHTML = '';
                            document.getElementById('unitScoresList').innerHTML = '';
                            
                            // 添加现有时间点
                            if (item.timePoints) {
                                item.timePoints.forEach(tp => {
                                    this.addTimePointToDisplay(tp);
                                });
                            }
                        } else {
                            document.getElementById('timePointsList').innerHTML = '';
                            document.getElementById('unitScoresList').innerHTML = '';
                            
                            // 添加现有单位评分项
                            if (item.unitScores) {
                                item.unitScores.forEach(us => {
                                    this.addUnitScoreToDisplay(us);
                                });
                            }
                        }
                    }
                } else {
                    // 默认显示时间点设置
                    this.toggleUnitTypeSection();
                }
                
                this.openModal('addItemModal');
            }
            
            // 清空添加事项表单
            clearAddItemForm() {
                document.getElementById('itemName').value = '';
                document.getElementById('itemUnitType').value = 'timePoint';
                document.getElementById('intervalDays').value = '0';
                document.getElementById('unfinishedScore').value = '-1';
                document.getElementById('itemDescription').value = '';
                
                // 清空时间点表单
                document.querySelectorAll('.time-hour').forEach(select => {
                    select.value = '';
                });
                document.querySelectorAll('.time-minute').forEach(select => {
                    select.value = '00';
                });
                document.getElementById('timeScore').value = '5';
                document.getElementById('timeDescription').value = '';
                
                // 清空单位评分表单
                document.getElementById('unitValue1').value = '';
                document.getElementById('unitValue2').value = '';
                document.getElementById('unitScore').value = '5';
                document.getElementById('unitDescription').value = '';
                
                // 清空显示列表
                document.getElementById('timePointsList').innerHTML = '';
                document.getElementById('unitScoresList').innerHTML = '';
            }
            
            // 切换单位类型显示区域
            toggleUnitTypeSection() {
                const unitType = document.getElementById('itemUnitType').value;
                const timePointSection = document.getElementById('timePointSection');
                const unitScoreSection = document.getElementById('unitScoreSection');
                const unitScoreTitle = document.getElementById('unitScoreTitle');
                const unitLabel = document.getElementById('unitLabel');
                
                if (unitType === 'timePoint') {
                    timePointSection.style.display = 'block';
                    unitScoreSection.style.display = 'none';
                } else {
                    timePointSection.style.display = 'none';
                    unitScoreSection.style.display = 'block';
                    
                    // 更新标题和单位标签
                    const unitLabelText = this.getUnitLabel(unitType);
                    unitScoreTitle.textContent = `${unitLabelText}评分`;
                    unitLabel.textContent = unitLabelText;
                }
            }
            
            // 添加时间点到表单
            addTimePointToForm() {
                const hour1 = document.querySelector('.time-hour[data-index="0"]').value;
                const minute1 = document.querySelector('.time-minute[data-index="0"]').value;
                const hour2 = document.querySelector('.time-hour[data-index="1"]').value;
                const minute2 = document.querySelector('.time-minute[data-index="1"]').value;
                const score = document.getElementById('timeScore').value;
                const description = document.getElementById('timeDescription').value;
                
                if (!hour1 || !minute1) {
                    this.showNotification('警告', '请至少选择起始时间', 'warning');
                    return;
                }
                
                // 验证时间范围
                if (hour2 && minute2) {
                    const time1 = parseInt(hour1) * 60 + parseInt(minute1);
                    const time2 = parseInt(hour2) * 60 + parseInt(minute2);
                    
                    if (time2 <= time1) {
                        this.showNotification('错误', '结束时间必须晚于开始时间', 'error');
                        return;
                    }
                }
                
                // 构建时间字符串
                let timeStr = `${hour1}:${minute1}`;
                if (hour2 && minute2) {
                    timeStr += ` ~ ${hour2}:${minute2}`;
                }
                
                // 创建时间点对象
                const timePoint = {
                    id: Date.now(), // 临时ID，保存时会重新生成
                    time: timeStr,
                    score: parseInt(score),
                    description: description
                };
                
                // 添加到显示列表
                this.addTimePointToDisplay(timePoint);
                
                // 清空表单
                document.querySelector('.time-hour[data-index="0"]').value = '';
                document.querySelector('.time-minute[data-index="0"]').value = '00';
                document.querySelector('.time-hour[data-index="1"]').value = '';
                document.querySelector('.time-minute[data-index="1"]').value = '00';
                document.getElementById('timeScore').value = '5';
                document.getElementById('timeDescription').value = '';
            }
            
            // 添加单位评分到表单
            addUnitScoreToForm() {
                const unitValue1 = parseFloat(document.getElementById('unitValue1').value);
                const unitValue2 = parseFloat(document.getElementById('unitValue2').value);
                const score = document.getElementById('unitScore').value;
                const description = document.getElementById('unitDescription').value;
                const unitType = document.getElementById('itemUnitType').value;
                const unitLabel = this.getUnitLabel(unitType);
                
                if (!unitValue1 || isNaN(unitValue1)) {
                    this.showNotification('警告', '请输入有效的数值', 'warning');
                    return;
                }
                
                // 验证数值范围
                if (unitValue2 && !isNaN(unitValue2)) {
                    if (unitValue2 <= unitValue1) {
                        this.showNotification('错误', '最大值必须大于最小值', 'error');
                        return;
                    }
                }
                
                // 构建数值字符串
                let valueStr = unitValue1.toString();
                if (unitValue2 && !isNaN(unitValue2)) {
                    valueStr = `${unitValue1}~${unitValue2}`;
                }
                
                // 创建单位评分对象
                const unitScore = {
                    id: Date.now(), // 临时ID，保存时会重新生成
                    value: valueStr,
                    unit: unitLabel,
                    score: parseInt(score),
                    description: description
                };
                
                // 添加到显示列表
                this.addUnitScoreToDisplay(unitScore);
                
                // 清空表单
                document.getElementById('unitValue1').value = '';
                document.getElementById('unitValue2').value = '';
                document.getElementById('unitScore').value = '5';
                document.getElementById('unitDescription').value = '';
            }
            
            // 添加时间点到显示列表
            addTimePointToDisplay(timePoint) {
                const timePointsList = document.getElementById('timePointsList');
                const div = document.createElement('div');
                div.className = 'time-point-item';
                div.dataset.tempId = timePoint.id;
                div.innerHTML = `
                    <div class="time-point-info">
                        <div class="time-point-time">${timePoint.time}</div>
                        <div class="time-point-score ${timePoint.score >= 0 ? 'positive' : 'negative'}">${timePoint.score >= 0 ? '+' : ''}${timePoint.score}</div>
                        <div class="time-point-description">${timePoint.description}</div>
                    </div>
                    <div class="sub-item-actions">
                        <button class="action-btn edit-btn" data-temp-id="${timePoint.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-temp-id="${timePoint.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                timePointsList.appendChild(div);
                
                // 绑定编辑和删除按钮事件
                const editBtn = div.querySelector('.edit-btn[data-temp-id]');
                const deleteBtn = div.querySelector('.delete-btn[data-temp-id]');
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tempId = parseInt(e.target.closest('.edit-btn').getAttribute('data-temp-id'));
                    this.editTimePointInForm(tempId);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tempId = parseInt(e.target.closest('.delete-btn').getAttribute('data-temp-id'));
                    this.removeTimePointFromDisplay(tempId);
                });
            }
            
            // 添加单位评分到显示列表
            addUnitScoreToDisplay(unitScore) {
                const unitScoresList = document.getElementById('unitScoresList');
                const div = document.createElement('div');
                div.className = 'time-point-item';
                div.dataset.tempId = unitScore.id;
                div.innerHTML = `
                    <div class="time-point-info">
                        <div class="time-point-time">${unitScore.value}${unitScore.unit}</div>
                        <div class="time-point-score ${unitScore.score >= 0 ? 'positive' : 'negative'}">${unitScore.score >= 0 ? '+' : ''}${unitScore.score}</div>
                        <div class="time-point-description">${unitScore.description}</div>
                    </div>
                    <div class="sub-item-actions">
                        <button class="action-btn edit-btn" data-temp-id="${unitScore.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-temp-id="${unitScore.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                unitScoresList.appendChild(div);
                
                // 绑定编辑和删除按钮事件
                const editBtn = div.querySelector('.edit-btn[data-temp-id]');
                const deleteBtn = div.querySelector('.delete-btn[data-temp-id]');
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tempId = parseInt(e.target.closest('.edit-btn').getAttribute('data-temp-id'));
                    this.editUnitScoreInForm(tempId);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tempId = parseInt(e.target.closest('.delete-btn').getAttribute('data-temp-id'));
                    this.removeUnitScoreFromDisplay(tempId);
                });
            }
            
            // 编辑表单中的时间点
            editTimePointInForm(tempId) {
                const element = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (!element) return;
                
                const time = element.querySelector('.time-point-time').textContent;
                const scoreText = element.querySelector('.time-point-score').textContent;
                const description = element.querySelector('.time-point-description').textContent;
                
                // 解析分数
                const score = parseInt(scoreText.replace('+', ''));
                
                // 设置编辑表单的值
                document.getElementById('editTimeDisplay').value = time;
                document.getElementById('editTimeScore').value = score;
                document.getElementById('editTimeDescription').value = description;
                
                // 保存当前编辑的时间点信息
                this.editingTimePoint.tempId = tempId;
                
                // 打开编辑时间点弹框
                this.openModal('editTimePointModal');
            }
            
            // 编辑表单中的单位评分
            editUnitScoreInForm(tempId) {
                const element = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (!element) return;
                
                const valueText = element.querySelector('.time-point-time').textContent;
                const scoreText = element.querySelector('.time-point-score').textContent;
                const description = element.querySelector('.time-point-description').textContent;
                
                // 解析数值和分数
                const unitMatch = valueText.match(/([\d.~]+)(.+)/);
                const score = parseInt(scoreText.replace('+', ''));
                
                if (unitMatch) {
                    // 解析数值范围
                    const valueStr = unitMatch[1];
                    if (valueStr.includes('~')) {
                        const [val1, val2] = valueStr.split('~');
                        document.getElementById('unitValue1').value = val1;
                        document.getElementById('unitValue2').value = val2;
                    } else {
                        document.getElementById('unitValue1').value = valueStr;
                        document.getElementById('unitValue2').value = '';
                    }
                    
                    document.getElementById('unitScore').value = score;
                    document.getElementById('unitDescription').value = description;
                    
                    // 移除原来的项
                    this.removeUnitScoreFromDisplay(tempId);
                }
            }
            
            // 保存时间点表单
            saveTimePointFromForm() {
                const tempId = this.editingTimePoint.tempId;
                const score = parseInt(document.getElementById('editTimeScore').value);
                const description = document.getElementById('editTimeDescription').value;
                
                if (!tempId) return;
                
                const element = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (!element) return;
                
                // 更新时间点显示
                const time = element.querySelector('.time-point-time').textContent;
                const scoreElement = element.querySelector('.time-point-score');
                const descriptionElement = element.querySelector('.time-point-description');
                
                scoreElement.textContent = score >= 0 ? `+${score}` : score;
                scoreElement.className = `time-point-score ${score >= 0 ? 'positive' : 'negative'}`;
                descriptionElement.textContent = description;
                
                // 关闭弹框
                this.closeModal('editTimePointModal');
                this.editingTimePoint.tempId = null;
                
                this.showNotification('成功', '时间点更新成功', 'success');
            }
            
            // 从显示列表中移除时间点
            removeTimePointFromDisplay(tempId) {
                const element = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (element) {
                    element.remove();
                }
            }
            
            // 从显示列表中移除单位评分
            removeUnitScoreFromDisplay(tempId) {
                const element = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (element) {
                    element.remove();
                }
            }
            
            // 保存事项表单
            saveItemFromForm() {
                const itemName = document.getElementById('itemName').value.trim();
                const unitType = document.getElementById('itemUnitType').value;
                const intervalDays = parseInt(document.getElementById('intervalDays').value);
                const unfinishedScore = parseInt(document.getElementById('unfinishedScore').value);
                const description = document.getElementById('itemDescription').value.trim();
                
                if (!itemName) {
                    this.showNotification('错误', '请输入事项名称', 'error');
                    return;
                }
                
                if (itemName.length > 5) {
                    this.showNotification('错误', '事项名称不能超过5个字', 'error');
                    return;
                }
                
                let itemData;
                
                if (unitType === 'timePoint') {
                    // 收集时间点
                    const timePointElements = document.querySelectorAll('#timePointsList .time-point-item');
                    const timePoints = [];
                    
                    if (timePointElements.length === 0) {
                        this.showNotification('错误', '请至少添加一个时间点', 'error');
                        return;
                    }
                    
                    timePointElements.forEach((element, index) => {
                        const time = element.querySelector('.time-point-time').textContent;
                        const scoreText = element.querySelector('.time-point-score').textContent;
                        const description = element.querySelector('.time-point-description').textContent;
                        
                        // 解析分数
                        const score = parseInt(scoreText.replace('+', ''));
                        
                        timePoints.push({
                            id: index + 1,
                            time,
                            score,
                            description
                        });
                    });
                    
                    itemData = {
                        name: itemName,
                        description: description,
                        unitType: unitType,
                        intervalDays,
                        unfinishedScore,
                        timePoints
                    };
                } else {
                    // 收集单位评分
                    const unitScoreElements = document.querySelectorAll('#unitScoresList .time-point-item');
                    const unitScores = [];
                    
                    if (unitScoreElements.length === 0) {
                        this.showNotification('错误', '请至少添加一个评分项', 'error');
                        return;
                    }
                    
                    unitScoreElements.forEach((element, index) => {
                        const valueText = element.querySelector('.time-point-time').textContent;
                        const scoreText = element.querySelector('.time-point-score').textContent;
                        const description = element.querySelector('.time-point-description').textContent;
                        
                        // 解析数值和分数
                        const unitMatch = valueText.match(/([\d.~]+)(.+)/);
                        const score = parseInt(scoreText.replace('+', ''));
                        
                        if (unitMatch) {
                            unitScores.push({
                                id: index + 1,
                                value: unitMatch[1],
                                unit: unitMatch[2],
                                score,
                                description
                            });
                        }
                    });
                    
                    itemData = {
                        name: itemName,
                        description: description,
                        unitType: unitType,
                        intervalDays,
                        unfinishedScore,
                        unitScores
                    };
                }
                
                let success = false;
                if (this.editingItemId) {
                    // 更新现有事项
                    success = this.updateItem(this.editingItemId, itemData);
                    if (success) {
                        this.showNotification('成功', '事项更新成功', 'success');
                    } else {
                        this.showNotification('错误', '事项名称已存在，请修改名称', 'error');
                        return;
                    }
                } else {
                    // 添加新事项
                    const newId = this.addItem(itemData);
                    success = !!newId;
                    if (success) {
                        this.showNotification('成功', '事项添加成功', 'success');
                    } else {
                        this.showNotification('错误', '事项名称已存在，请修改名称', 'error');
                        return;
                    }
                }
                
                if (success) {
                    this.closeModal('addItemModal');
                    this.editingItemId = null;
                    // 如果当前模板包含此事项，重新生成模板拷贝
                    const currentTemplate = this.getCurrentTemplate();
                    if (currentTemplate && currentTemplate.itemIds.includes(this.editingItemId || newId)) {
                        this.generateTemplateCopy();
                    }
                    this.renderAll();
                } else {
                    this.showNotification('错误', '保存事项失败', 'error');
                }
            }
            
            // 编辑事项
            editItem(itemId) {
                this.openAddItemModal(itemId);
            }
            
            // 删除事项确认
            deleteItemConfirm(itemId) {
                this.showConfirmDialog('确认删除', '确定要删除这个事项吗？删除后相关模板也会移除该事项。', () => {
                    if (this.deleteItem(itemId)) {
                        this.showNotification('成功', '事项删除成功', 'success');
                        this.renderAll();
                    } else {
                        this.showNotification('错误', '删除事项失败', 'error');
                    }
                });
            }
            
            // 删除时间点确认
            deleteTimePointConfirm(itemId, tpIndex) {
                this.showConfirmDialog('确认删除', '确定要删除这个时间点吗？', () => {
                    const item = this.getItem(itemId);
                    if (!item || !item.timePoints || !item.timePoints[tpIndex]) {
                        this.showNotification('错误', '时间点不存在', 'error');
                        return;
                    }
                    
                    item.timePoints.splice(tpIndex, 1);
                    this.saveData();
                    this.showNotification('成功', '时间点删除成功', 'success');
                    this.renderItemsList();
                });
            }
            
            // 删除单位评分确认
            deleteUnitScoreConfirm(itemId, usIndex) {
                this.showConfirmDialog('确认删除', '确定要删除这个评分项吗？', () => {
                    const item = this.getItem(itemId);
                    if (!item || !item.unitScores || !item.unitScores[usIndex]) {
                        this.showNotification('错误', '评分项不存在', 'error');
                        return;
                    }
                    
                    item.unitScores.splice(usIndex, 1);
                    this.saveData();
                    this.showNotification('成功', '评分项删除成功', 'success');
                    this.renderItemsList();
                });
            }
            
            // 打开模板模态框
            openTemplateModal(templateId = null) {
                this.editingTemplateId = templateId;
                
                // 设置标题
                document.getElementById('templateModalTitle').textContent = 
                    templateId ? '编辑模板' : '添加模板';
                
                // 清空表单
                this.clearTemplateForm();
                
                // 如果是编辑模式，填充数据
                if (templateId) {
                    const template = this.data.templates.find(t => t.id === templateId);
                    if (template) {
                        document.getElementById('templateName').value = template.name;
                        
                        // 添加已选择的事项
                        this.selectedTemplateItems = [...template.itemIds];
                        this.renderSelectedItems();
                    }
                } else {
                    this.selectedTemplateItems = [];
                    this.renderSelectedItems();
                }
                
                // 更新可用事项列表
                this.updateAvailableItems();
                
                this.openModal('templateModal');
            }
            
            // 清空模板表单
            clearTemplateForm() {
                document.getElementById('templateName').value = '';
                document.getElementById('selectedItemsList').innerHTML = '';
                this.selectedTemplateItems = [];
            }
            
            // 更新可用事项列表
            updateAvailableItems() {
                const availableItemsSelect = document.getElementById('availableItems');
                availableItemsSelect.innerHTML = '<option value="">请选择事项</option>';
                
                this.data.items.forEach(item => {
                    // 只显示未选择的事项
                    if (!this.selectedTemplateItems.includes(item.id)) {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.name} (${this.getUnitLabel(item.unitType)})`;
                        availableItemsSelect.appendChild(option);
                    }
                });
            }
            
            // 渲染已选择的事项
            renderSelectedItems() {
                const selectedItemsList = document.getElementById('selectedItemsList');
                selectedItemsList.innerHTML = '';
                
                if (this.selectedTemplateItems.length === 0) {
                    selectedItemsList.innerHTML = '<p style="color: var(--gray-color); text-align: center;">暂无事项</p>';
                    return;
                }
                
                this.selectedTemplateItems.forEach(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return;
                    
                    const div = document.createElement('div');
                    div.className = 'sub-item';
                    div.innerHTML = `
                        <div class="sub-item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                <span>间隔天数: ${item.intervalDays}</span>
                                <span>未完成分数: ${item.unfinishedScore}</span>
                                <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                            </div>
                        </div>
                        <div class="sub-item-actions">
                            <button class="action-btn delete-btn" data-item-id="${itemId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    selectedItemsList.appendChild(div);
                });
                
                // 绑定删除按钮事件
                selectedItemsList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-item-id'));
                        this.removeItemFromTemplate(itemId);
                    });
                });
            }
            
            // 添加事项到模板表单
            addItemToTemplateForm() {
                const itemId = parseInt(document.getElementById('availableItems').value);
                if (!itemId) {
                    this.showNotification('警告', '请选择事项', 'warning');
                    return;
                }
                
                if (this.selectedTemplateItems.includes(itemId)) {
                    this.showNotification('警告', '该事项已添加', 'warning');
                    return;
                }
                
                this.selectedTemplateItems.push(itemId);
                this.renderSelectedItems();
                this.updateAvailableItems();
                
                // 清空选择
                document.getElementById('availableItems').value = '';
            }
            
            // 从模板中移除事项
            removeItemFromTemplate(itemId) {
                const index = this.selectedTemplateItems.indexOf(itemId);
                if (index !== -1) {
                    this.selectedTemplateItems.splice(index, 1);
                    this.renderSelectedItems();
                    this.updateAvailableItems();
                }
            }
            
            // 保存模板表单
            saveTemplateFromForm() {
                const templateName = document.getElementById('templateName').value.trim();
                
                if (!templateName) {
                    this.showNotification('错误', '请输入模板名称', 'error');
                    return;
                }
                
                if (this.selectedTemplateItems.length === 0) {
                    this.showNotification('错误', '请至少选择一个事项', 'error');
                    return;
                }
                
                // 创建模板对象
                const templateData = {
                    name: templateName,
                    itemIds: [...this.selectedTemplateItems]
                };
                
                let success = false;
                if (this.editingTemplateId) {
                    // 更新现有模板
                    success = this.updateTemplate(this.editingTemplateId, templateData);
                    if (success) {
                        this.showNotification('成功', '模板更新成功', 'success');
                        // 如果更新的是当前使用的模板，重新生成模板拷贝
                        if (this.editingTemplateId === this.data.currentTemplateId) {
                            this.generateTemplateCopy();
                        }
                    } else {
                        this.showNotification('错误', '模板名称已存在，请修改名称', 'error');
                        return;
                    }
                } else {
                    // 添加新模板
                    const newId = this.addTemplate(templateData);
                    success = !!newId;
                    if (success) {
                        this.showNotification('成功', '模板添加成功', 'success');
                    } else {
                        this.showNotification('错误', '模板名称已存在，请修改名称', 'error');
                        return;
                    }
                }
                
                if (success) {
                    this.closeModal('templateModal');
                    this.editingTemplateId = null;
                    this.renderAll();
                } else {
                    this.showNotification('错误', '保存模板失败', 'error');
                }
            }
            
            // 编辑模板
            editTemplate(templateId) {
                this.openTemplateModal(templateId);
            }
            
            // 删除模板确认
            deleteTemplateConfirm(templateId) {
                this.showConfirmDialog('确认删除', '确定要删除这个模板吗？', () => {
                    if (this.deleteTemplate(templateId)) {
                        this.showNotification('成功', '模板删除成功', 'success');
                        this.renderAll();
                    } else {
                        this.showNotification('错误', '无法删除当前正在使用的模板', 'error');
                    }
                });
            }
            
            // 打开选择模板模态框
            openSelectTemplateModal() {
                const templateSelect = document.getElementById('templateSelect');
                templateSelect.innerHTML = '<option value="">请选择模板</option>';
                
                this.data.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    if (template.id === this.data.currentTemplateId) {
                        option.selected = true;
                    }
                    templateSelect.appendChild(option);
                });
                
                this.openModal('selectTemplateModal');
            }
            
            // 确认模板选择
            confirmTemplateSelection() {
                const templateId = parseInt(document.getElementById('templateSelect').value);
                if (!templateId) {
                    this.showNotification('错误', '请选择模板', 'error');
                    return;
                }
                
                if (this.setCurrentTemplate(templateId)) {
                    this.showNotification('成功', '模板切换成功', 'success');
                    this.closeModal('selectTemplateModal');
                    this.renderAll();
                } else {
                    this.showNotification('错误', '切换模板失败', 'error');
                }
            }
            
            // 保存记录表单
            saveRecordFromForm() {
                const itemId = parseInt(document.getElementById('itemSelect').value);
                const scoreId = parseInt(document.getElementById('timeSelect').value);
                
                if (!itemId) {
                    this.showNotification('错误', '请选择事项', 'error');
                    return;
                }
                
                if (!scoreId) {
                    this.showNotification('错误', '请选择评分项', 'error');
                    return;
                }
                
                const item = this.getItem(itemId);
                const isTimePoint = item.unitType === 'timePoint';
                
                const todayRecord = this.getTodayRecord();
                const existingRecords = todayRecord.records.filter(r => r.itemId === itemId);
                
                // 如果该事项今天已经有记录，显示确认对话框
                if (existingRecords.length > 0) {
                    this.showDuplicateRecordDialog(item.name, existingRecords.length, itemId, scoreId, isTimePoint);
                } else {
                    // 直接添加记录
                    if (this.addRecord(itemId, scoreId, isTimePoint)) {
                        // 清空表单
                        document.getElementById('itemSelect').value = '';
                        document.getElementById('timeSelect').value = '';
                        document.getElementById('currentScore').textContent = '0';
                        document.getElementById('currentScore').className = 'current-score-value';
                        
                        // 重新渲染
                        this.renderDailyRecords();
                        this.renderTemplateList();
                        this.updateDailyTotalScore();
                    }
                }
            }
            
            // 显示重复记录确认对话框
            showDuplicateRecordDialog(itemName, existingCount, itemId, scoreId, isTimePoint) {
                const dialog = document.getElementById('duplicateRecordDialog');
                const title = document.getElementById('duplicateRecordTitle');
                const message = document.getElementById('duplicateRecordMessage');
                
                title.textContent = '确认添加重复记录';
                message.textContent = `"${itemName}"今天已经记录了${existingCount}次，确定要继续添加吗？`;
                
                // 保存回调函数和数据
                this.duplicateRecordCallback = (itemId, scoreId, isTimePoint) => {
                    if (this.addRecord(itemId, scoreId, isTimePoint)) {
                        // 清空表单
                        document.getElementById('itemSelect').value = '';
                        document.getElementById('timeSelect').value = '';
                        document.getElementById('currentScore').textContent = '0';
                        document.getElementById('currentScore').className = 'current-score-value';
                        
                        // 重新渲染
                        this.renderDailyRecords();
                        this.renderTemplateList();
                        this.updateDailyTotalScore();
                    }
                };
                
                this.pendingRecordData = { itemId, scoreId, isTimePoint };
                
                // 显示对话框
                dialog.classList.add('active');
            }
            
            // 隐藏重复记录确认对话框
            hideDuplicateRecordDialog() {
                const dialog = document.getElementById('duplicateRecordDialog');
                dialog.classList.remove('active');
                this.duplicateRecordCallback = null;
                this.pendingRecordData = null;
            }
            
            // 查询每日记录
            searchDailyRecords() {
                const date = document.getElementById('queryDate').value;
                const itemFilter = document.getElementById('queryItem').value;
                
                if (!date) {
                    this.showNotification('错误', '请选择日期', 'error');
                    return;
                }
                
                const results = this.queryDailyRecords(date, itemFilter);
                
                // 显示累计分数
                document.getElementById('queryTotalScoreContainer').style.display = 'block';
                document.getElementById('queryTotalScore').textContent = results.totalScore;
                
                // 渲染模板事项
                const templateList = document.getElementById('queryTemplateList');
                templateList.innerHTML = '';
                
                if (results.templateItems.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">无模板数据</div>
                        </div>
                    `;
                    templateList.appendChild(li);
                } else {
                    results.templateItems.forEach(item => {
                        const li = document.createElement('li');
                        let className = 'record-item ';
                        if (item.status === 'completed' || item.status === 'notDue') {
                            className += 'template'; // 已完成或未到期，使用模板事项样式
                        } else {
                            className += 'non-template'; // 未完成，使用非模板事项样式
                        }
                        
                        li.className = className;
                        li.innerHTML = `
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-details">
                                    <span>间隔天数: ${item.intervalDays}</span>
                                    <span>未完成分数: ${item.unfinishedScore}</span>
                                </div>
                            </div>
                            <div class="item-score ${item.status === 'overdue' ? 'negative' : 'positive'}">
                                ${item.status === 'completed' ? '已完成' : item.status === 'notDue' ? '未到期' : '未完成'}
                                ${item.completionDate ? `<div class="completion-date">${item.completionDate}</div>` : ''}
                            </div>
                        `;
                        templateList.appendChild(li);
                    });
                }
                
                // 渲染完成记录
                const recordsList = document.getElementById('queryRecordsList');
                recordsList.innerHTML = '';
                
                if (results.records.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">无完成记录</div>
                        </div>
                    `;
                    recordsList.appendChild(li);
                } else {
                    results.records.forEach(record => {
                        const li = document.createElement('li');
                        li.className = `record-item ${record.isTemplateItem ? 'template' : 'non-template'}`;
                        
                        let detailsHtml = '';
                        if (record.unitType === 'timePoint') {
                            detailsHtml = `<span>时间: ${record.time}</span>`;
                        } else {
                            detailsHtml = `<span>${record.value}${record.unit}</span>`;
                        }
                        detailsHtml += `<span>${record.isTemplateItem ? '模板内事项' : '额外事项'}</span>`;
                        
                        li.innerHTML = `
                            <div class="item-info">
                                <div class="item-name">${record.itemName}</div>
                                <div class="item-details">
                                    ${detailsHtml}
                                </div>
                            </div>
                            <div class="item-score ${record.score >= 0 ? 'positive' : 'negative'}">
                                ${record.score >= 0 ? '+' : ''}${record.score}
                            </div>
                        `;
                        recordsList.appendChild(li);
                    });
                }
            }
            
            // 生成周度报告
            generateWeeklyReportFromForm() {
                const weekStr = document.getElementById('reportWeek').value;
                if (!weekStr) {
                    // 使用当前周
                    this.setCurrentWeek();
                }
                
                // 解析周字符串
                const [year, weekPart] = weekStr.split('-W');
                if (!year || !weekPart) {
                    this.showNotification('错误', '周次格式不正确', 'error');
                    return;
                }
                
                // 计算周的开始日期
                const firstDayOfYear = new Date(year, 0, 1);
                const daysOffset = (parseInt(weekPart) - 1) * 7;
                const startDate = new Date(firstDayOfYear);
                startDate.setDate(firstDayOfYear.getDate() + daysOffset);
                
                // 调整到周一
                const dayOfWeek = startDate.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                startDate.setDate(startDate.getDate() + diff);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                
                const report = this.generateWeeklyReport(startDateStr);
                if (!report) {
                    this.showNotification('提示', '该周没有记录数据', 'warning');
                    return;
                }
                
                // 渲染统计数据
                this.renderWeeklyStats(report.stats);
                
                // 渲染完成情况
                this.renderCompletionSummary(report.stats.itemsCompletion);
                
                // 渲染每日摘要
                this.renderDailySummary(report.records);
            }
            
            // 渲染周度统计数据
            renderWeeklyStats(stats) {
                const weeklyStats = document.getElementById('weeklyStats');
                weeklyStats.innerHTML = '';
                
                // 记录天数卡片
                const recordDaysCard = document.createElement('div');
                recordDaysCard.className = 'stat-card';
                recordDaysCard.innerHTML = `
                    <div class="stat-value">${stats.recordDays}</div>
                    <div class="stat-label">记录天数</div>
                    <div class="stat-details">
                        <div>中断天数: ${stats.interruptDays}</div>
                        <div>最长持续: ${stats.longestStreak}天</div>
                    </div>
                `;
                weeklyStats.appendChild(recordDaysCard);
                
                // 分数统计卡片
                const scoreCard = document.createElement('div');
                scoreCard.className = 'stat-card';
                scoreCard.innerHTML = `
                    <div class="stat-value">${stats.totalScore}</div>
                    <div class="stat-label">累计分数</div>
                    <div class="stat-details">
                        <div>最高日分: ${stats.maxDailyScore}</div>
                        <div>最低日分: ${stats.minDailyScore}</div>
                    </div>
                `;
                weeklyStats.appendChild(scoreCard);
                
                // 日均分数卡片
                const avgCard = document.createElement('div');
                avgCard.className = 'stat-card';
                avgCard.innerHTML = `
                    <div class="stat-value">${stats.averageScore.toFixed(1)}</div>
                    <div class="stat-label">日均分数</div>
                `;
                weeklyStats.appendChild(avgCard);
                
                // 完成率卡片（估算）
                const completionCard = document.createElement('div');
                completionCard.className = 'stat-card';
                const totalItemsCount = Object.keys(stats.itemsCompletion).length;
                const completionRate = totalItemsCount > 0 ? 
                    Math.round(Object.values(stats.itemsCompletion).reduce((sum, item) => sum + item.count, 0) / (totalItemsCount * 7) * 100) : 0;
                completionCard.innerHTML = `
                    <div class="stat-value">${completionRate}%</div>
                    <div class="stat-label">完成率</div>
                `;
                weeklyStats.appendChild(completionCard);
            }
            
            // 渲染完成情况
            renderCompletionSummary(itemsCompletion) {
                const completionSummary = document.getElementById('completionSummary');
                completionSummary.innerHTML = '';
                
                if (Object.keys(itemsCompletion).length === 0) {
                    completionSummary.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">无完成情况数据</p>';
                    return;
                }
                
                Object.entries(itemsCompletion).forEach(([itemName, data]) => {
                    const avgScore = data.count > 0 ? (data.totalScore / data.count).toFixed(1) : 0;
                    const div = document.createElement('div');
                    div.className = 'completion-item';
                    div.innerHTML = `
                        <span>${itemName}</span>
                        <span>${data.count}次，均分: ${avgScore}</span>
                    `;
                    completionSummary.appendChild(div);
                });
            }
            
            // 渲染每日摘要
            renderDailySummary(records) {
                const dailySummary = document.getElementById('dailySummary');
                dailySummary.innerHTML = '';
                
                if (records.length === 0) {
                    dailySummary.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">无每日记录数据</p>';
                    return;
                }
                
                records.forEach(record => {
                    const dailyTotal = this.calculateDailyTotalScoreForDate(record.date);
                    const div = document.createElement('div');
                    div.className = 'completion-item';
                    div.innerHTML = `
                        <span>${record.date}</span>
                        <span>得分: ${dailyTotal}</span>
                    `;
                    dailySummary.appendChild(div);
                });
            }
            
            // 切换事项内容显示/隐藏
            toggleItemContent(header) {
                const itemCard = header.parentElement;
                const content = itemCard.querySelector('.item-content');
                const toggleIcon = header.querySelector('.item-toggle i');
                
                header.classList.toggle('open');
                content.classList.toggle('open');
                
                if (content.classList.contains('open')) {
                    toggleIcon.className = 'fas fa-chevron-up';
                } else {
                    toggleIcon.className = 'fas fa-chevron-down';
                }
            }
            
            // 切换模板卡片显示/隐藏
            toggleTemplateCard(header) {
                const templateCard = header.parentElement;
                const content = templateCard.querySelector('.template-card-content');
                const toggleIcon = header.querySelector('.template-card-toggle i');
                
                header.classList.toggle('open');
                content.classList.toggle('open');
                
                if (content.classList.contains('open')) {
                    toggleIcon.className = 'fas fa-chevron-up';
                } else {
                    toggleIcon.className = 'fas fa-chevron-down';
                }
            }
            
            // 打开模态框
            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }
            
            // 关闭模态框
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
            
            // 切换标签
            switchTab(tabId) {
                // 移除所有标签的active类
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // 添加active类到当前标签
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }
            
            // 清空输入框
            clearInput(targetId) {
                const element = document.getElementById(targetId);
                if (element) {
                    element.value = '';
                    
                    if (targetId === 'itemSelect' || targetId === 'timeSelect') {
                        this.updateCurrentScore();
                    } else if (targetId === 'itemSource') {
                        this.updateItemOptions();
                    }
                }
            }
            
            // 显示通知
            showNotification(title, content, type = 'info') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notificationTitle');
                const notificationContent = document.getElementById('notificationContent');
                
                // 设置内容和类型
                notificationTitle.textContent = title;
                notificationContent.textContent = content;
                
                // 设置类型样式
                notification.className = 'notification';
                notification.classList.add(type);
                
                // 显示通知
                notification.classList.add('show');
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    this.hideNotification();
                }, 5000);
            }
            
            // 隐藏通知
            hideNotification() {
                const notification = document.getElementById('notification');
                notification.classList.remove('show');
            }
            
            // 显示确认对话框
            showConfirmDialog(title, message, callback) {
                const dialog = document.getElementById('confirmDialog');
                const dialogTitle = document.getElementById('confirmTitle');
                const dialogMessage = document.getElementById('confirmMessage');
                
                // 设置内容和回调
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                this.confirmCallback = callback;
                
                // 显示对话框
                dialog.classList.add('active');
            }
            
            // 隐藏确认对话框
            hideConfirmDialog() {
                const dialog = document.getElementById('confirmDialog');
                dialog.classList.remove('active');
                this.confirmCallback = null;
            }
        }

        // 初始化系统
        const habitSystem = new HabitScoreSystem();
    </script>
</body>
</html>
