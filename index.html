<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeekTodoScoring-2.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #5a6fd0;
    --secondary-color: #4a59b5;
    --accent-color: #6bc5f0;
    --success-color: #5cd68a;
    --warning-color: #f8b042;
    --danger-color: #f56666;
    --light-color: #f8f9fa;
    --dark-color: #2d3748;
    --gray-color: #718096;
    --light-gray: #e2e8f0;
    --border-radius: 10px;
    --box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
    --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
    --input-background: #ffffff;
    --card-background: rgba(255, 255, 255, 0.92);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
}

body {
    background: var(--background-gradient);
    color: var(--dark-color);
    line-height: 1.6;
    padding: 15px;
    min-height: 100vh;
    overflow-x: hidden;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

/* 头部样式 */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 4px 8px rgba(90, 111, 208, 0.2);
}

.logo-text h1 {
    font-size: 24px;
    color: var(--dark-color);
    margin-bottom: 5px;
}

.logo-text p {
    color: var(--gray-color);
    font-size: 13px;
}

.header-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.header-btn {
    padding: 10px 18px;
    border-radius: var(--border-radius);
    border: none;
    background-color: var(--card-background);
    color: var(--dark-color);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    font-size: 14px;
}

.header-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.header-btn.customize {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

.header-btn.records {
    background: linear-gradient(135deg, var(--success-color), #38a169);
    color: white;
}

.header-btn.help {
    background: linear-gradient(135deg, var(--accent-color), #2b9fc9);
    color: white;
}

/* 主内容区域 */
.main-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 15px;
    margin-bottom: 15px;
    height: calc(100vh - 150px);
    min-height: 500px;
    overflow: hidden;
}

@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
        height: auto;
        min-height: auto;
    }
}

/* 左侧面板 - 新增记录 */
.panel-left {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--box-shadow);
    height: 100%;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* 右侧面板 - 模板和记录 */
.panel-right {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--box-shadow);
    height: 100%;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.panel-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--light-gray);
    flex-shrink: 0;
}

.panel-title h2 {
    font-size: 20px;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.panel-title .help-icon {
    color: var(--gray-color);
    font-size: 18px;
    cursor: help;
}

/* 新增记录表单 */
.record-form {
    margin-bottom: 20px;
    flex-shrink: 0;
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 15px;
    align-items: flex-end;
}

.form-group {
    flex: 1;
    min-width: 150px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--dark-color);
    font-size: 14px;
}

.select-wrapper, .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.select-wrapper select, .input-wrapper input, .input-wrapper textarea {
    width: 100%;
    padding: 12px 35px 12px 15px;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
    font-size: 15px;
    background-color: var(--input-background);
    appearance: none;
    transition: var(--transition);
    color: var(--dark-color);
}

.select-wrapper select:focus, .input-wrapper input:focus, .input-wrapper textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 111, 208, 0.1);
}

.input-wrapper textarea {
    resize: vertical;
    min-height: 70px;
}

.clear-btn {
    position: absolute;
    right: 10px;
    background: none;
    border: none;
    color: var(--gray-color);
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    z-index: 5;
}

.clear-btn:hover {
    color: var(--danger-color);
}

/* 分数显示区域 */
.score-display {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.score-item {
    background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
    padding: 15px;
    border-radius: var(--border-radius);
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.score-label {
    font-size: 13px;
    color: var(--gray-color);
    margin-bottom: 5px;
}

.score-value {
    font-size: 28px;
    font-weight: 700;
}

.score-item:nth-child(1) .score-value {
    color: var(--primary-color);
}

.score-item:nth-child(2) .score-value {
    color: var(--primary-color);
}

.score-item:nth-child(3) .score-value {
    color: var(--success-color);
}

.save-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
}

.save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(90, 111, 208, 0.3);
}

/* 右侧面板 - 模板和记录水平布局 */
.right-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    height: 100%;
    min-height: 0;
}

@media (max-width: 768px) {
    .right-content {
        grid-template-columns: 1fr;
    }
}

.template-section, .daily-records {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 0;
}

.template-list, .records-list {
    list-style: none;
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    padding-right: 5px;
    max-height: 400px;
}

.template-list::-webkit-scrollbar, .records-list::-webkit-scrollbar {
    width: 6px;
}

.template-list::-webkit-scrollbar-track, .records-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
}

.template-list::-webkit-scrollbar-thumb, .records-list::-webkit-scrollbar-thumb {
    background: rgba(90, 111, 208, 0.3);
    border-radius: 10px;
}

.template-list::-webkit-scrollbar-thumb:hover, .records-list::-webkit-scrollbar-thumb:hover {
    background: rgba(90, 111, 208, 0.5);
}

.template-item, .record-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    margin-bottom: 10px;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
    background-color: #f8fafc;
    position: relative;
    transition: var(--transition);
}

.template-item:hover, .record-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
}

.template-item.completed {
    background-color: #f1f5f9;
    color: var(--gray-color);
    border-left-color: var(--gray-color);
}

.template-item.overdue {
    background-color: #fee2e2;
    border-left-color: var(--danger-color);
}

.template-item.normal {
    background-color: #f8fafc;
    border-left-color: var(--primary-color);
}

.record-item.template {
    background-color: #e6f7ee;
    border-left-color: var(--success-color);
}

.record-item.non-template {
    background-color: #e8f0fe;
    border-left-color: var(--accent-color);
}

.item-info {
    flex: 1;
    margin-right: 10px;
}

.item-name {
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 15px;
}

.item-details {
    display: flex;
    gap: 12px;
    font-size: 13px;
    color: var(--gray-color);
    flex-wrap: wrap;
}

.item-score {
    font-weight: 700;
    font-size: 16px;
    white-space: nowrap;
    margin-right: 8px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.item-score .completion-date {
    font-size: 12px;
    font-weight: normal;
    color: var(--gray-color);
    margin-top: 2px;
}

.item-actions {
    display: flex;
    gap: 6px;
}

.positive {
    color: var(--success-color);
}

.negative {
    color: var(--danger-color);
}

/* 自定义弹框样式 */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    backdrop-filter: blur(5px);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    width: 95%;
    max-width: 750px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.modal-overlay.active .modal {
    transform: translateY(0);
}

.modal-header {
    padding: 18px 22px;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 20px;
    color: var(--dark-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 22px;
    color: var(--gray-color);
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.modal-close:hover {
    background-color: #f1f5f9;
    color: var(--dark-color);
}

.modal-body {
    padding: 22px;
}

/* 事项管理样式 */
.item-management {
    margin-bottom: 25px;
}

.add-item-btn {
    padding: 10px 18px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 20px;
    font-size: 14px;
    transition: var(--transition);
}

.add-item-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
}

.items-list {
    list-style: none;
}

.item-card {
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    overflow: hidden;
    background-color: var(--card-background);
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    background-color: #f8fafc;
    cursor: pointer;
    transition: var(--transition);
}

.item-header:hover {
    background-color: #f1f5f9;
}

.item-header-title {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.item-index {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    flex-shrink: 0;
}

.item-main-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    flex: 1;
}

.item-name-container {
    font-weight: 600;
    font-size: 15px;
}

.item-stats {
    display: flex;
    gap: 15px;
    font-size: 13px;
    color: var(--gray-color);
}

.item-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

.item-stat i {
    color: var(--primary-color);
}

.item-toggle {
    font-size: 13px;
    color: var(--gray-color);
    transition: var(--transition);
    flex-shrink: 0;
}

.item-header.open .item-toggle {
    transform: rotate(180deg);
}

.action-btn {
    padding: 5px 10px;
    border-radius: var(--border-radius);
    border: none;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
}

.edit-btn {
    background: linear-gradient(135deg, var(--warning-color), #e67e22);
    color: white;
}

.delete-btn {
    background: linear-gradient(135deg, var(--danger-color), #e74c3c);
    color: white;
}

.small-delete-btn {
    padding: 3px 8px;
    border-radius: var(--border-radius);
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--danger-color), #e74c3c);
    color: white;
    width: 28px;
    height: 28px;
    min-width: 28px;
    transition: var(--transition);
}

.small-delete-btn:hover {
    transform: scale(1.05);
}

.item-content {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: var(--transition);
}

.item-content.open {
    padding: 18px;
    max-height: 1000px;
}

.sub-items-list {
    list-style: none;
    margin-bottom: 10px;
}

.sub-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid #f1f5f9;
    transition: var(--transition);
}

.sub-item:hover {
    background-color: #f8fafc;
}

.sub-item:last-child {
    border-bottom: none;
}

.sub-item-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    flex-wrap: wrap;
}

.sub-item-time {
    min-width: 90px;
    font-size: 14px;
}

.sub-item-score {
    min-width: 50px;
    font-weight: 600;
    font-size: 14px;
}

.sub-item-description {
    flex: 1;
    font-size: 14px;
    color: var(--gray-color);
}

.sub-item-actions {
    display: flex;
    gap: 8px;
}

.add-subitem-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background-color: rgb(92, 214, 138);
    border: 1px dashed var(--light-gray);
    border-radius: var(--border-radius);
    color: white;
    cursor: pointer;
    margin-top: 12px;
    transition: var(--transition);
    font-size: 13px;
}

.add-subitem-btn:hover {
    background-color: #e5e7eb;
    color: var(--dark-color);
}

/* 模板管理样式 */
.template-management {
    margin-bottom: 25px;
}

.current-template {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 14px;
    background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
    border-radius: var(--border-radius);
    flex-wrap: wrap;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.current-template-label {
    font-weight: 600;
    color: var(--dark-color);
    font-size: 14px;
}

.current-template-name {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 15px;
}

.change-template-btn {
    padding: 8px 14px;
    background: linear-gradient(135deg, var(--warning-color), #e67e22);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    margin-left: auto;
    font-size: 13px;
    transition: var(--transition);
}

.change-template-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(248, 176, 66, 0.2);
}

.template-cards {
    margin-top: 18px;
}

.template-card {
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    overflow: hidden;
    background-color: var(--card-background);
}

.template-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    background-color: #f8fafc;
    cursor: pointer;
    transition: var(--transition);
}

.template-card-header:hover {
    background-color: #f1f5f9;
}

.template-card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.template-card-index {
    background: linear-gradient(135deg, var(--success-color), #38a169);
    color: white;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    flex-shrink: 0;
}

.template-main-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    flex: 1;
}

.template-name-container {
    font-weight: 600;
    font-size: 15px;
}

.template-stats {
    display: flex;
    gap: 15px;
    font-size: 13px;
    color: var(--gray-color);
}

.template-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

.template-stat i {
    color: var(--success-color);
}

.template-card-toggle {
    font-size: 13px;
    color: var(--gray-color);
    transition: var(--transition);
    flex-shrink: 0;
}

.template-card-header.open .template-card-toggle {
    transform: rotate(180deg);
}

.template-card-content {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: var(--transition);
}

.template-card-content.open {
    padding: 18px;
    max-height: 1000px;
}

.template-items-list {
    list-style: none;
    margin-bottom: 12px;
}

.template-item-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid #f1f5f9;
}

.template-item-detail:last-child {
    border-bottom: none;
}

/* 记录管理样式 */
.records-tabs {
    display: flex;
    border-bottom: 1px solid var(--light-gray);
    margin-bottom: 20px;
}

.tab-btn {
    padding: 10px 20px;
    background: none;
    border: none;
    font-weight: 600;
    color: var(--gray-color);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: var(--transition);
    font-size: 14px;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.search-form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
}

.search-form .form-group {
    min-width: 130px;
}

.search-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    transition: var(--transition);
}

.search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
}

/* 每日查询结果样式 */
.daily-query-results {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    height: 450px;
}

@media (max-width: 768px) {
    .daily-query-results {
        grid-template-columns: 1fr;
        height: auto;
    }
}

.query-results-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.query-results-content {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
}

.query-total-score {
    background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
    padding: 14px;
    border-radius: var(--border-radius);
    margin-bottom: 18px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.query-total-score-label {
    font-size: 13px;
    color: var(--gray-color);
    margin-bottom: 5px;
}

.query-total-score-value {
    font-size: 26px;
    font-weight: 700;
    color: var(--success-color);
}

/* 周度报告样式 */
.report-stats {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 18px;
    box-shadow: var(--box-shadow);
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 13px;
    color: var(--gray-color);
}

.stat-details {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    font-size: 13px;
    color: var(--gray-color);
}

.completion-summary {
    margin-top: 25px;
}

.completion-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--light-gray);
    transition: var(--transition);
}

.completion-item:hover {
    background-color: #f8fafc;
}

/* 使用说明样式 */
.instructions-list {
    list-style: none;
    padding-left: 18px;
}

.instructions-list li {
    margin-bottom: 12px;
    padding-left: 8px;
    position: relative;
}

.instructions-list li:before {
    content: "•";
    color: var(--primary-color);
    font-size: 22px;
    position: absolute;
    left: -15px;
    top: -5px;
}

/* 烟花特效样式 */
.fireworks-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2001;
    display: none;
}

.fireworks-container.active {
    display: block;
}

.firework {
    position: absolute;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    box-shadow: 0 0 10px #fff;
}

.celebration-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 30px 40px;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    text-align: center;
    z-index: 2002;
    display: none;
    animation: popIn 0.5s ease-out;
    border: 4px solid var(--success-color);
}

.celebration-message.active {
    display: block;
}

.celebration-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--success-color);
    margin-bottom: 10px;
}

.celebration-subtitle {
    font-size: 18px;
    color: var(--dark-color);
}

@keyframes popIn {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

/* 自定义通知样式 */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 18px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    min-width: 280px;
    max-width: 350px;
    transform: translateX(350px);
    transition: transform 0.3s ease;
    border-left: 4px solid var(--primary-color);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    border-left-color: var(--success-color);
}

.notification.warning {
    border-left-color: var(--warning-color);
}

.notification.error {
    border-left-color: var(--danger-color);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    font-weight: 600;
    font-size: 16px;
}

.notification-close {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--gray-color);
    cursor: pointer;
}

.notification-content {
    color: var(--dark-color);
    font-size: 14px;
}

/* 确认对话框样式 */
.confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    backdrop-filter: blur(5px);
}

.confirm-dialog.active {
    opacity: 1;
    visibility: visible;
}

.confirm-content {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 25px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.confirm-title {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--dark-color);
}

.confirm-message {
    margin-bottom: 22px;
    color: var(--gray-color);
    font-size: 14px;
}

.confirm-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.confirm-btn {
    padding: 8px 18px;
    border-radius: var(--border-radius);
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
}

.confirm-btn.cancel {
    background-color: var(--light-gray);
    color: var(--dark-color);
}

.confirm-btn.confirm {
    background: linear-gradient(135deg, var(--danger-color), #e74c3c);
    color: white;
}

/* 重复记录确认对话框 */
.duplicate-record-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    backdrop-filter: blur(5px);
}

.duplicate-record-dialog.active {
    opacity: 1;
    visibility: visible;
}

.duplicate-record-content {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 25px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.duplicate-record-title {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--dark-color);
}

.duplicate-record-message {
    margin-bottom: 22px;
    color: var(--gray-color);
    font-size: 14px;
}

.duplicate-record-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.duplicate-record-btn {
    padding: 8px 18px;
    border-radius: var(--border-radius);
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
}

.duplicate-record-btn.cancel {
    background-color: var(--light-gray);
    color: var(--dark-color);
}

.duplicate-record-btn.confirm {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

/* 工具提示样式 - 修改为水平显示 */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltip-text {
    visibility: hidden;
    width: 220px;
    background-color: var(--dark-color);
    color: white;
    text-align: center;
    border-radius: var(--border-radius);
    padding: 10px;
    position: absolute;
    z-index: 3000;
    top: 50%;
    left: 100%;
    transform: translateY(-50%);
    margin-left: 10px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 13px;
    font-weight: normal;
    line-height: 1.4;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    white-space: normal;
}

.tooltip .tooltip-text::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 100%;
    margin-top: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent var(--dark-color) transparent transparent;
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* 时间点编辑样式 */
.time-point-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    border-left: 3px solid var(--accent-color);
    transition: var(--transition);
}

.time-point-item:hover {
    background-color: #f1f5f9;
}

.time-point-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.time-point-time {
    min-width: 100px;
    font-weight: 600;
}

.time-point-score {
    min-width: 50px;
    font-weight: 600;
}

.time-point-description {
    flex: 1;
    color: var(--gray-color);
}

.time-point-edit-input {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    font-size: 14px;
    background-color: var(--input-background);
}

/* 单位类型特定样式 */
.unit-type-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--light-gray);
}

.unit-input-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.unit-input {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    flex-wrap: wrap;
}

.unit-input input {
    flex: 1;
    min-width: 80px;
    padding: 10px;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
    font-size: 15px;
    background-color: var(--input-background);
}

.unit-label {
    font-weight: 600;
    color: var(--dark-color);
    min-width: 40px;
}

.unit-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

.unit-range span {
    color: var(--gray-color);
}

/* 模板名称显示在主界面 */
.template-info-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.current-template-display {
    font-size: 14px;
    color: var(--gray-color);
}

.current-template-display .template-name {
    font-weight: 600;
    color: var(--primary-color);
}

/* 评分输入增强样式 */
.score-input-container {
    position: relative;
    width: 100%;
}

.score-input-container .select-wrapper {
    display: flex;
    align-items: center;
}

.score-select {
    flex: 1;
    border-right: none;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.score-input {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--light-gray);
    border-left: none;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    font-size: 15px;
    background-color: var(--input-background);
}

.score-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 111, 208, 0.1);
}

/* 添加自定义单位类型按钮 */
.add-unit-type-btn {
    padding: 10px 15px;
    background: linear-gradient(135deg, var(--success-color), #38a169);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    margin-left: 10px;
    transition: var(--transition);
}

.add-unit-type-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 214, 138, 0.2);
}

.custom-unit-types {
    margin-top: 15px;
    padding: 15px;
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
}

.custom-unit-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background-color: white;
    border-radius: var(--border-radius);
    border-left: 3px solid var(--accent-color);
}

/* 月度报告样式 */
.monthly-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 20px;
}

.calendar-day {
    padding: 10px;
    text-align: center;
    border-radius: var(--border-radius);
    background-color: #f8fafc;
    border: 1px solid var(--light-gray);
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.calendar-day.has-record {
    background-color: var(--success-color);
    color: white;
}

.calendar-day.today {
    border: 2px solid var(--primary-color);
}

.calendar-day.empty {
    background-color: transparent;
    border: none;
}

.calendar-day-number {
    font-weight: 600;
    margin-bottom: 5px;
}

.calendar-day-score {
    font-size: 12px;
    opacity: 0.8;
}

/* 所有记录查询样式 */
.all-records-search {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.record-date-item {
    cursor: pointer;
    transition: var(--transition);
}

.record-date-item:hover {
    background-color: #f8fafc;
}

.record-details-modal {
    max-width: 800px;
}

/* 数据存储信息样式 */
.storage-path {
    margin-top: 15px;
    padding: 15px;
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
    font-size: 14px;
}

.storage-path-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e2e8f0;
}

.storage-path-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

/* 响应式调整 */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .header-buttons {
        width: 100%;
        margin-top: 15px;
    }
    
    .header-btn {
        flex: 1;
        justify-content: center;
    }
    
    .logo {
        flex-direction: column;
        text-align: center;
        gap: 8px;
        width: 100%;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .form-group {
        min-width: 100%;
    }
    
    .item-header, .template-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .item-actions {
        align-self: flex-end;
    }
    
    .sub-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .sub-item-info {
        width: 100%;
    }
    
    .modal {
        width: 98%;
    }
    
    .daily-query-results {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .report-stats {
        grid-template-columns: 1fr;
    }
    
    .celebration-message {
        width: 90%;
        padding: 20px;
    }
    
    .celebration-title {
        font-size: 22px;
    }
    
    .celebration-subtitle {
        font-size: 16px;
    }
    
    .item-main-info, .template-main-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .item-stats, .template-stats {
        width: 100%;
    }
    
    /* 移动端工具提示调整 */
    .tooltip .tooltip-text {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 280px;
        z-index: 3001;
        margin-left: 0;
    }
    
    .tooltip .tooltip-text::after {
        display: none;
    }
    
    .all-records-search {
        flex-direction: column;
    }
    
    .monthly-calendar {
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
    }
    
    .calendar-day {
        padding: 5px;
        min-height: 40px;
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .header-buttons {
        flex-direction: column;
    }
    
    .header-btn {
        width: 100%;
    }
    
    .main-content {
        height: auto;
    }
    
    .right-content {
        grid-template-columns: 1fr;
    }
    
    .search-form {
        flex-direction: column;
    }
    
    .search-btn {
        width: 100%;
        justify-content: center;
    }
    
    .tooltip .tooltip-text {
        width: 180px;
        font-size: 12px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .score-display {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .score-item {
        padding: 12px;
    }
    
    .score-value {
        font-size: 24px;
    }
}

/* 数据管理标签页样式 */
.data-management {
    margin-bottom: 25px;
}

.data-section {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--box-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title i {
    color: var(--primary-color);
}

.export-options, .import-options {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.option-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
    min-width: 200px;
}

.option-group label {
    font-weight: 600;
    color: var(--dark-color);
    font-size: 14px;
}

.option-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.option-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.option-checkbox span {
    font-size: 14px;
    color: var(--dark-color);
}

.button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.action-button {
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    transition: var(--transition);
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(90, 111, 208, 0.2);
}

.action-button.secondary {
    background: linear-gradient(135deg, var(--gray-color), #718096);
}

.action-button.success {
    background: linear-gradient(135deg, var(--success-color), #38a169);
}

.action-button.warning {
    background: linear-gradient(135deg, var(--warning-color), #e67e22);
}

.action-button.danger {
    background: linear-gradient(135deg, var(--danger-color), #e74c3c);
}

.file-upload-area {
    border: 2px dashed var(--light-gray);
    border-radius: var(--border-radius);
    padding: 30px 20px;
    text-align: center;
    margin-bottom: 20px;
    cursor: pointer;
    transition: var(--transition);
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background-color: rgba(90, 111, 208, 0.05);
}

.file-upload-area.drag-over {
    border-color: var(--success-color);
    background-color: rgba(92, 214, 138, 0.05);
}

.file-upload-icon {
    font-size: 40px;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.file-upload-text {
    font-size: 16px;
    color: var(--dark-color);
    margin-bottom: 5px;
}

.file-upload-hint {
    font-size: 13px;
    color: var(--gray-color);
}

.file-input {
    display: none;
}

.selected-file {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    margin-bottom: 15px;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-icon {
    color: var(--primary-color);
    font-size: 18px;
}

.file-name {
    font-weight: 600;
    color: var(--dark-color);
}

.file-size {
    font-size: 13px;
    color: var(--gray-color);
}

.remove-file {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    font-size: 16px;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.remove-file:hover {
    background-color: rgba(245, 102, 102, 0.1);
}

.import-preview {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    display: none;
}

.import-preview.active {
    display: block;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
}

.preview-table th {
    background-color: #f8fafc;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 1px solid var(--light-gray);
    font-size: 14px;
}

.preview-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 13px;
    color: var(--dark-color);
}

.preview-table tr:last-child td {
    border-bottom: none;
}

.preview-table .positive {
    color: var(--success-color);
    font-weight: 600;
}

.preview-table .negative {
    color: var(--danger-color);
    font-weight: 600;
}

.data-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 18px;
    box-shadow: var(--box-shadow);
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-icon {
    font-size: 24px;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--dark-color);
}

.stat-label {
    font-size: 13px;
    color: var(--gray-color);
}

.backup-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
}

.backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    margin-bottom: 10px;
    border-radius: var(--border-radius);
    background-color: #f8fafc;
    border-left: 4px solid var(--primary-color);
    transition: var(--transition);
}

.backup-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
}

.backup-info {
    flex: 1;
    margin-right: 10px;
}

.backup-name {
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 15px;
}

.backup-details {
    display: flex;
    gap: 12px;
    font-size: 13px;
    color: var(--gray-color);
    flex-wrap: wrap;
}

.backup-actions {
    display: flex;
    gap: 6px;
}

.no-backups {
    text-align: center;
    padding: 30px;
    color: var(--gray-color);
    font-style: italic;
}

.backup-status {
    font-size: 13px;
    color: var(--gray-color);
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.backup-status i {
    color: var(--warning-color);
}

/* 导入结果弹窗 */
.import-results-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    backdrop-filter: blur(5px);
}

.import-results-modal.active {
    opacity: 1;
    visibility: visible;
}

.import-results-content {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    width: 95%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.import-results-modal.active .import-results-content {
    transform: translateY(0);
}

.import-results-header {
    padding: 18px 22px;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.import-results-title {
    font-size: 20px;
    color: var(--dark-color);
}

.import-results-close {
    background: none;
    border: none;
    font-size: 22px;
    color: var(--gray-color);
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.import-results-close:hover {
    background-color: #f1f5f9;
    color: var(--dark-color);
}

.import-results-body {
    padding: 22px;
}

.import-summary {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.summary-item {
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    padding: 15px;
    text-align: center;
}

.summary-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.summary-label {
    font-size: 13px;
    color: var(--gray-color);
}

.import-details {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-top: 20px;
}

.import-details-table {
    width: 100%;
    border-collapse: collapse;
}

.import-details-table th {
    background-color: #f8fafc;
    padding: 10px;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 1px solid var(--light-gray);
    font-size: 13px;
}

.import-details-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 12px;
    color: var(--dark-color);
}

.import-details-table .success {
    color: var(--success-color);
}

.import-details-table .error {
    color: var(--danger-color);
}

.import-details-table .warning {
    color: var(--warning-color);
}

/* 月度报告统计样式 */
.monthly-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.monthly-stat-card {
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--box-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.monthly-stat-value {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--primary-color);
}

.monthly-stat-label {
    font-size: 14px;
    color: var(--gray-color);
    margin-bottom: 10px;
}

.monthly-stat-desc {
    font-size: 12px;
    color: var(--gray-color);
    opacity: 0.8;
}

/* 所有记录列表样式 */
.all-records-list-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
}

.all-records-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: #f8fafc;
    border-bottom: 1px solid var(--light-gray);
    font-size: 14px;
}

.all-records-count {
    font-weight: 600;
    color: var(--primary-color);
}

.all-records-list {
    list-style: none;
}

.all-record-item {
    padding: 15px;
    border-bottom: 1px solid #f1f5f9;
    transition: var(--transition);
}

.all-record-item:hover {
    background-color: #f8fafc;
}

.all-record-item:last-child {
    border-bottom: none;
}

.all-record-date {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--dark-color);
}

.all-record-stats {
    display: flex;
    gap: 15px;
    font-size: 13px;
    color: var(--gray-color);
    margin-bottom: 8px;
}

.all-record-score {
    font-weight: 600;
    color: var(--primary-color);
}

.all-record-actions {
    display: flex;
    justify-content: flex-end;
}

/* 记录详情样式 */
.record-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--light-gray);
}

.record-details-date {
    font-size: 20px;
    font-weight: 600;
    color: var(--dark-color);
}

.record-details-template {
    font-size: 14px;
    color: var(--gray-color);
}

.record-details-template span {
    color: var(--primary-color);
    font-weight: 600;
}

.detail-scores {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.detail-score-item {
    background: linear-gradient(135deg, rgba(245, 247, 250, 0.8), rgba(228, 233, 242, 0.8));
    padding: 15px;
    border-radius: var(--border-radius);
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.detail-score-label {
    font-size: 13px;
    color: var(--gray-color);
    margin-bottom: 5px;
}

.detail-score-value {
    font-size: 24px;
    font-weight: 700;
}

.detail-score-item:nth-child(1) .detail-score-value {
    color: var(--success-color);
}

.detail-score-item:nth-child(2) .detail-score-value {
    color: var(--danger-color);
}

.detail-score-item:nth-child(3) .detail-score-value {
    color: var(--primary-color);
}

/* 自定义单位类型管理 */
.custom-unit-manager {
    margin-top: 20px;
}

.custom-unit-list {
    list-style: none;
    margin-top: 15px;
}

.custom-unit-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 8px;
    background-color: #f8fafc;
    border-radius: var(--border-radius);
    border-left: 3px solid var(--accent-color);
}

.custom-unit-info {
    flex: 1;
}

.custom-unit-name {
    font-weight: 600;
    color: var(--dark-color);
}

.custom-unit-desc {
    font-size: 13px;
    color: var(--gray-color);
    margin-top: 3px;
}

/* 响应式调整补充 */
@media (max-width: 768px) {
    .export-options, .import-options {
        flex-direction: column;
    }
    
    .option-group {
        min-width: 100%;
    }
    
    .data-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    .action-button {
        width: 100%;
        justify-content: center;
    }
    
    .import-summary {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .monthly-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .detail-scores {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .monthly-calendar {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .import-summary {
        grid-template-columns: 1fr;
    }
    
    .section-title {
        font-size: 16px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .records-tabs {
        flex-wrap: wrap;
    }
    
    .tab-btn {
        flex: 1;
        text-align: center;
        padding: 8px 12px;
        font-size: 12px;
    }
}
</style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <h1>周勤评分系统</h1>
                    <p>养成良好的习惯，提升自我管理能力</p>
                </div>
            </div>
            <div class="header-buttons">
                <button class="header-btn customize" id="customizeBtn">
                    <i class="fas fa-sliders-h"></i> 事项模板管理
                </button>
                <button class="header-btn records" id="recordsBtn">
                    <i class="fas fa-history"></i> 记录管理
                </button>
                <button class="header-btn help" id="helpBtn">
                    <i class="fas fa-question-circle"></i> 使用说明
                </button>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 左侧：新增记录 -->
            <section class="panel-left">
                <div class="panel-title">
                    <h2>
                        <i class="fas fa-plus-circle"></i> 新增记录
                        <span class="tooltip help-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">在此处添加当日的习惯完成记录。选择事项和时间点后，系统会自动计算得分并累加到当日总分。</span>
                        </span>
                    </h2>
                </div>
                
                <div class="record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemSource">事项来源</label>
                            <div class="select-wrapper">
                                <select id="itemSource">
                                    <option value="template">当前模板内</option>
                                    <option value="all">所有事项</option>
                                </select>
                                <button class="clear-btn" data-target="itemSource">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemSelect">事项选择</label>
                            <div class="select-wrapper">
                                <select id="itemSelect">
                                    <!-- 选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="itemSelect">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timeSelect">时间点选择</label>
                            <div class="select-wrapper">
                                <select id="timeSelect">
                                    <!-- 选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="timeSelect">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 修改后的分数显示区域，增加仅完成记录总分 -->
                    <div class="score-display">
                        <div class="score-item">
                            <div class="score-label">当前得分</div>
                            <div class="score-value" id="currentScore">0</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">仅完成记录总分</div>
                            <div class="score-value" id="completedTotalScore">0</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">当日累计得分</div>
                            <div class="score-value" id="dailyTotal">0</div>
                        </div>
                    </div>
                    
                    <button class="save-btn" id="saveRecordBtn">
                        <i class="fas fa-save"></i> 保存记录
                    </button>
                </div>
            </section>

            <!-- 右侧：模板和记录水平排列 -->
            <section class="panel-right">
                <div class="template-info-header">
                    <div class="current-template-display">
                        当前模板: <span class="template-name" id="currentTemplateDisplay">默认模板</span>
                    </div>
                </div>
                <div class="right-content">
                    <div class="template-section">
                        <div class="panel-title">
                            <h2>
                                <i class="fas fa-th-list"></i> 当前模板事项
                                <span class="tooltip help-icon">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">显示当前使用模板中的所有事项。已完成的事项会变为灰色，未完成的事项正常显示。间隔天数表示该事项完成后的休息天数。</span>
                                </span>
                            </h2>
                        </div>
                        <ul class="template-list" id="templateList">
                            <!-- 模板事项将通过JS动态生成 -->
                        </ul>
                    </div>
                    
                    <div class="daily-records">
                        <div class="panel-title">
                            <h2>
                                <i class="fas fa-calendar-day"></i> 当日记录
                                <span class="tooltip help-icon">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">显示当天已完成的事项记录。绿色背景表示是模板内事项，蓝色背景表示是非模板事项。</span>
                                </span>
                            </h2>
                        </div>
                        <ul class="records-list" id="dailyRecordsList">
                            <!-- 当日记录将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 烟花特效容器 -->
    <div class="fireworks-container" id="fireworksContainer"></div>
    
    <!-- 庆祝消息 -->
    <div class="celebration-message" id="celebrationMessage">
        <div class="celebration-title">签到成功！</div>
        <div class="celebration-subtitle">恭喜！太棒啦！</div>
    </div>

    <!-- 重复记录确认对话框 -->
    <div class="duplicate-record-dialog" id="duplicateRecordDialog">
        <div class="duplicate-record-content">
            <div class="duplicate-record-title" id="duplicateRecordTitle">确认添加记录</div>
            <div class="duplicate-record-message" id="duplicateRecordMessage"></div>
            <div class="duplicate-record-buttons">
                <button class="duplicate-record-btn cancel" id="duplicateRecordCancel">取消</button>
                <button class="duplicate-record-btn confirm" id="duplicateRecordConfirm">确认添加</button>
            </div>
        </div>
    </div>

    <!-- 自定义功能弹框 -->
    <div class="modal-overlay" id="customizeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">自定义功能</h3>
                <button class="modal-close" id="closeCustomizeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="records-tabs">
                    <button class="tab-btn" data-tab="itemsTab">事项及分数管理</button>
                    <button class="tab-btn active" data-tab="templatesTab">模板管理</button>
                    <button class="tab-btn" data-tab="dataTab">数据管理</button>
                </div>
                    
                <!-- 事项及分数管理 -->
                <div class="tab-content" id="itemsTab">
                    <div class="item-management">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                            <button class="add-item-btn" id="addItemBtn">
                            <i class="fas fa-plus"></i> 添加事项
                            </button>
        
                            <button class="add-item-btn add-unit-type-btn" id="addCustomUnitTypeBtn">
                            <i class="fas fa-plus-circle"></i> 添加单位类型
                            </button>
                        </div>
        
                        <ul class="items-list" id="itemsList">
                        <!-- 事项列表将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
                    
                <!-- 模板管理 -->
                <div class="tab-content active" id="templatesTab">
                    <div class="template-management">
                        <div class="current-template">
                            <span class="current-template-label">当前使用模板：</span>
                            <span class="current-template-name" id="currentTemplateName">默认模板</span>
                            <button class="change-template-btn" id="changeTemplateBtn">修改使用模板</button>
                        </div>
                            
                        <button class="add-item-btn" id="addTemplateBtn">
                            <i class="fas fa-plus"></i> 添加模板
                        </button>
                            
                        <div class="template-cards" id="templatesContainer">
                            <!-- 模板列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 数据管理 -->
                <div class="tab-content" id="dataTab">
                    <div class="data-management">
                        <!-- 数据统计 -->
                        <div class="data-section">
                            <h3 class="section-title">
                                <i class="fas fa-chart-bar"></i> 数据统计
                            </h3>
                            <div class="data-stats-grid" id="dataStats">
                                <!-- 统计数据将通过JS动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 数据导出 -->
                        <div class="data-section">
                            <h3 class="section-title">
                                <i class="fas fa-download"></i> 数据导出
                            </h3>
                            <div class="export-options">
                                <div class="option-group">
                                    <label>导出格式</label>
                                    <div class="option-checkboxes">
                                        <label class="option-checkbox">
                                            <input type="radio" name="exportFormat" value="json" checked>
                                            <span>JSON 格式</span>
                                        </label>
                                        <label class="option-checkbox">
                                            <input type="radio" name="exportFormat" value="csv">
                                            <span>CSV 格式</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <label>导出范围</label>
                                    <div class="option-checkboxes">
                                        <label class="option-checkbox">
                                            <input type="checkbox" name="exportScope" value="items" checked>
                                            <span>事项数据</span>
                                        </label>
                                        <label class="option-checkbox">
                                            <input type="checkbox" name="exportScope" value="templates" checked>
                                            <span>模板数据</span>
                                        </label>
                                        <label class="option-checkbox">
                                            <input type="checkbox" name="exportScope" value="records" checked>
                                            <span>记录数据</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="button-group">
                                <button class="action-button" id="exportDataBtn">
                                    <i class="fas fa-file-export"></i> 导出数据
                                </button>
                                <button class="action-button secondary" id="exportAllBackupsBtn">
                                    <i class="fas fa-archive"></i> 导出所有备份
                                </button>
                            </div>
                            <!-- 新增：数据保存路径显示 -->
                            <div class="storage-path">
                                <div class="storage-path-item">
                                    <span>当前数据保存路径：</span>
                                    <span id="storagePathDisplay">浏览器本地存储</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数据导入 -->
                        <div class="data-section">
                            <h3 class="section-title">
                                <i class="fas fa-upload"></i> 数据导入
                            </h3>
                            <div class="import-options">
                                <div class="option-group">
                                    <label>导入模式</label>
                                    <div class="option-checkboxes">
                                        <label class="option-checkbox">
                                            <input type="radio" name="importMode" value="merge" checked>
                                            <span>合并数据（保留现有）</span>
                                        </label>
                                        <label class="option-checkbox">
                                            <input type="radio" name="importMode" value="replace">
                                            <span>替换数据（覆盖现有）</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="file-upload-area" id="fileUploadArea">
                                <div class="file-upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="file-upload-text">点击或拖拽文件到此处上传</div>
                                <div class="file-upload-hint">支持 JSON 或 CSV 格式文件</div>
                                <input type="file" class="file-input" id="importFileInput" accept=".json,.csv">
                            </div>
                            
                            <div id="selectedFileContainer" style="display: none;">
                                <div class="selected-file">
                                    <div class="file-info">
                                        <i class="fas fa-file file-icon"></i>
                                        <div>
                                            <div class="file-name" id="fileName">未选择文件</div>
                                            <div class="file-size" id="fileSize">0 KB</div>
                                        </div>
                                    </div>
                                    <button class="remove-file" id="removeFileBtn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <div class="import-preview" id="importPreview">
                                    <!-- 导入预览将通过JS动态生成 -->
                                </div>
                                
                                <div class="button-group">
                                    <button class="action-button success" id="importDataBtn" disabled>
                                        <i class="fas fa-file-import"></i> 导入数据
                                    </button>
                                    <button class="action-button secondary" id="clearImportBtn">
                                        <i class="fas fa-times"></i> 清空选择
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 自动备份管理 -->
                        <div class="data-section">
                            <h3 class="section-title">
                                <i class="fas fa-history"></i> 自动备份管理
                            </h3>
                            <div class="backup-status">
                                <i class="fas fa-info-circle"></i>
                                <span>系统自动保存最近 5 个备份版本，每周提醒手动导出</span>
                            </div>
                            <div class="button-group" style="margin-top: 15px;">
                                <button class="action-button" id="createBackupBtn">
                                    <i class="fas fa-plus"></i> 创建手动备份
                                </button>
                                <button class="action-button warning" id="clearBackupsBtn">
                                    <i class="fas fa-trash"></i> 清空所有备份
                                </button>
                            </div>
                            
                            <h4 style="margin-top: 20px; margin-bottom: 15px;">备份列表</h4>
                            <ul class="backup-list" id="backupList">
                                <!-- 备份列表将通过JS动态生成 -->
                            </ul>
                        </div>
                        
                        <!-- 新增：清除本地数据 -->
                        <div class="data-section">
                            <h3 class="section-title">
                                <i class="fas fa-trash-alt"></i> 清除本地数据
                            </h3>
                            <p style="margin-bottom: 15px; color: var(--gray-color); font-size: 14px;">
                                清除所有本地存储的数据，包括事项、模板、记录和备份。此操作不可恢复，请谨慎操作！
                            </p>
                            <div class="button-group">
                                <button class="action-button danger" id="clearLocalDataBtn">
                                    <i class="fas fa-exclamation-triangle"></i> 清除所有本地数据
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入结果弹窗 -->
    <div class="modal-overlay import-results-modal" id="importResultsModal">
        <div class="modal import-results-content">
            <div class="modal-header import-results-header">
                <h3 class="modal-title import-results-title">导入结果</h3>
                <button class="modal-close import-results-close" id="closeImportResultsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body import-results-body">
                <div id="importResultsContent">
                    <!-- 导入结果将通过JS动态生成 -->
                </div>
                <div class="button-group" style="justify-content: center; margin-top: 25px;">
                    <button class="action-button" id="closeImportResultsBtn">
                        <i class="fas fa-check"></i> 完成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加事项弹框 -->
    <div class="modal-overlay" id="addItemModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="addItemModalTitle">添加事项</h3>
                <button class="modal-close" id="closeAddItemModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">事项名称 (不超过5个字)</label>
                        <div class="input-wrapper">
                            <input type="text" id="itemName" maxlength="5" placeholder="请输入事项名称">
                            <button class="clear-btn" data-target="itemName">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="itemUnitType">事项单位类型</label>
                        <div class="select-wrapper">
                            <select id="itemUnitType">
                                <option value="timePoint">时间点</option>
                                <option value="count">次</option>
                                <option value="distance">公里</option>
                                <option value="duration">时长</option>
                                <!-- 自定义单位类型将通过JS动态生成 -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="intervalDays">间隔天数</label>
                        <div class="select-wrapper">
                            <select id="intervalDays">
                                <option value="0">0 (无间隔，每天执行)</option>
                                <option value="1">1 (间隔1天)</option>
                                <option value="2">2 (间隔2天)</option>
                                <option value="3">3 (间隔3天)</option>
                                <option value="4">4 (间隔4天)</option>
                                <option value="5">5 (间隔5天)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="unfinishedScore">未完成分数</label>
                        <div class="select-wrapper">
                            <select id="unfinishedScore">
                                <option value="-1">-1</option>
                                <option value="-2">-2</option>
                                <option value="-3">-3</option>
                                <option value="-4">-4</option>
                                <option value="-5">-5</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription">事项说明</label>
                    <div class="input-wrapper">
                        <textarea id="itemDescription" placeholder="请输入事项说明" rows="2"></textarea>
                        <button class="clear-btn" data-target="itemDescription">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 时间点设置区域 -->
                <div class="unit-type-section" id="timePointSection">
                    <h4>时间点设置</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>开始时间</label>
                            <div class="form-row">
                                <div class="select-wrapper">
                                    <select class="time-hour" data-index="0">
                                        <option value="">时</option>
                                        <!-- 小时选项将通过JS动态生成 -->
                                    </select>
                                </div>
                                <span>:</span>
                                <div class="select-wrapper">
                                    <select class="time-minute" data-index="0">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>结束时间 (可选)</label>
                            <div class="form-row">
                                <div class="select-wrapper">
                                    <select class="time-hour" data-index="1">
                                        <option value="">时</option>
                                        <!-- 小时选项将通过JS动态生成 -->
                                    </select>
                                </div>
                                <span>:</span>
                                <div class="select-wrapper">
                                    <select class="time-minute" data-index="1">
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
    <label for="timeScore">分数</label>
    <div class="score-input-container" style="width: 200px;">
        <div class="select-wrapper" style="display: flex;">
            <select class="score-select" id="timeScore" style="flex: 1; border-right: none; border-radius: var(--border-radius) 0 0 var(--border-radius);">
                <option value="">选择分数</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
                <option value="-1">-1</option>
                <option value="-2">-2</option>
                <option value="-3">-3</option>
                <option value="-4">-4</option>
                <option value="-5">-5</option>
            </select>
            <input type="number" class="score-input" id="timeScoreInput" placeholder="或输入分数" step="1" min="-999" max="999" style="border-left: none; border-radius: 0 var(--border-radius) var(--border-radius) 0; width: 80px;">
        </div>
    </div>
</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="timeDescription">说明/备注</label>
                        <div class="input-wrapper">
                            <textarea id="timeDescription" placeholder="请输入说明或备注" rows="2"></textarea>
                            <button class="clear-btn" data-target="timeDescription">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button class="add-subitem-btn" id="addTimePointBtn">
                        <i class="fas fa-plus"></i> 添加时间点
                    </button>
                    
                    <div id="timePointsList">
                        <!-- 已添加的时间点将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 单位类型评分区域 -->
                <div class="unit-type-section" id="unitScoreSection" style="display: none;">
                    <h4 id="unitScoreTitle">次 数评分</h4>
                    <div class="unit-input-container">
    <div class="unit-range">
        <div class="unit-input" style="flex: 1; display: flex; align-items: center; gap: 5px;">
            <input type="number" id="unitValue1" min="0" max="999" step="0.1" placeholder="最小值" style="flex: 1;">
            <span>~</span>
            <input type="number" id="unitValue2" min="0" max="999" step="0.1" placeholder="最大值" style="flex: 1;">
            <span class="unit-label" id="unitLabel">次</span>
        </div>
        <!-- 修改为可手动输入的评分输入框 -->
        <div class="score-input-container" style="width: 200px;">
            <div class="select-wrapper" style="display: flex;">
                <select class="score-select" id="unitScore" style="flex: 1; border-right: none; border-radius: var(--border-radius) 0 0 var(--border-radius);">
                    <option value="">选择分数</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                    <option value="-1">-1</option>
                    <option value="-2">-2</option>
                    <option value="-3">-3</option>
                    <option value="-4">-4</option>
                    <option value="-5">-5</option>
                </select>
                <input type="number" class="score-input" id="unitScoreInput" placeholder="或输入分数" step="1" min="-999" max="999" style="border-left: none; border-radius: 0 var(--border-radius) var(--border-radius) 0; width: 80px;">
            </div>
        </div>
    </div>
</div>
                    
                    <div class="form-group">
                        <label for="unitDescription">说明/备注</label>
                        <div class="input-wrapper">
                            <textarea id="unitDescription" placeholder="请输入说明或备注" rows="2"></textarea>
                            <button class="clear-btn" data-target="unitDescription">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button class="add-subitem-btn" id="addUnitScoreBtn">
                        <i class="fas fa-plus"></i> 添加评分项
                    </button>
                    
                    <div id="unitScoresList">
                        <!-- 已添加的评分项将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveItemBtn">保存事项</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑时间点弹框 -->
    <div class="modal-overlay" id="editTimePointModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">编辑时间点</h3>
                <button class="modal-close" id="closeEditTimePointModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTimeDisplay">时间</label>
                    <div class="input-wrapper">
                        <input type="text" id="editTimeDisplay" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editTimeScore">分数</label>
                    <!-- 修改为可手动输入的评分输入框 -->
                    <div class="score-input-container">
                        <div class="select-wrapper">
                            <select class="score-select" id="editTimeScore">
                                <option value="">选择分数</option>
                                <option value="5">5</option>
                                <option value="4">4</option>
                                <option value="3">3</option>
                                <option value="2">2</option>
                                <option value="1">1</option>
                                <option value="-1">-1</option>
                                <option value="-2">-2</option>
                                <option value="-3">-3</option>
                                <option value="-4">-4</option>
                                <option value="-5">-5</option>
                            </select>
                            <input type="number" class="score-input" id="editTimeScoreInput" placeholder="或输入分数" step="1" min="-999" max="999">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editTimeDescription">说明/备注</label>
                    <div class="input-wrapper">
                        <textarea id="editTimeDescription" placeholder="请输入说明或备注" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveTimePointBtn">保存时间点</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模板弹框 -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="templateModalTitle">添加模板</h3>
                <button class="modal-close" id="closeTemplateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateName">模板名称</label>
                    <div class="input-wrapper">
                        <input type="text" id="templateName" placeholder="请输入模板名称">
                        <button class="clear-btn" data-target="templateName">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>选择事项</label>
                    <div class="items-selection">
                        <div class="form-row">
                            <div class="select-wrapper">
                                <select id="availableItems">
                                    <!-- 可用事项将通过JS动态生成 -->
                                </select>
                            </div>
                            <button class="action-btn" id="addItemToTemplateBtn" style="background-color: var(--success-color); color: white;">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                        
                        <div id="selectedItemsList" style="margin-top: 20px;">
                            <!-- 已选择的事项将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveTemplateBtn">保存模板</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 选择模板弹框 -->
    <div class="modal-overlay" id="selectTemplateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">选择使用模板</h3>
                <button class="modal-close" id="closeSelectTemplateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="templateSelect">选择模板</label>
                    <div class="select-wrapper">
                        <select id="templateSelect">
                            <!-- 模板选项将通过JS动态生成 -->
                        </select>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="confirmTemplateBtn">确定使用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 记录管理弹框 -->
    <div class="modal-overlay" id="recordsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">记录管理</h3>
                <button class="modal-close" id="closeRecordsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="records-tabs">
                    <button class="tab-btn active" data-tab="dailyQueryTab">每日查询</button>
                    <button class="tab-btn" data-tab="weeklyReportTab">周度报告</button>
                    <button class="tab-btn" data-tab="monthlyReportTab">月度报告</button>
                    <button class="tab-btn" data-tab="allRecordsTab">所有记录</button>
                </div>
                
                <!-- 每日查询 -->
                <div class="tab-content active" id="dailyQueryTab">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="queryDate">日期</label>
                            <div class="input-wrapper">
                                <input type="date" id="queryDate">
                                <button class="clear-btn" data-target="queryDate">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="queryItem">事项</label>
                            <div class="select-wrapper">
                                <select id="queryItem">
                                    <option value="">全部事项</option>
                                    <!-- 事项选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="queryItem">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="searchRecordsBtn">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                    
                    <div class="query-total-score" id="queryTotalScoreContainer" style="display: none;">
                        <div class="query-total-score-label">当日累计得分</div>
                        <div class="query-total-score-value" id="queryTotalScore">0</div>
                    </div>
                    
                    <div class="daily-query-results">
                        <div class="query-results-panel panel-left">
                            <div class="panel-title">
                                <h4>当日模板事项</h4>
                            </div>
                            <div class="query-results-content">
                                <ul class="records-list" id="queryTemplateList">
                                    <!-- 查询结果将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                        <div class="query-results-panel panel-left">
                            <div class="panel-title">
                                <h4>当日完成记录</h4>
                            </div>
                            <div class="query-results-content">
                                <ul class="records-list" id="queryRecordsList">
                                    <!-- 查询结果将通过JS动态生成 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 周度报告 -->
                <div class="tab-content" id="weeklyReportTab">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="reportWeek">选择周次</label>
                            <div class="input-wrapper">
                                <input type="week" id="reportWeek">
                                <button class="clear-btn" data-target="reportWeek">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="generateReportBtn">
                            <i class="fas fa-chart-bar"></i> 生成报告
                        </button>
                    </div>
                    
                    <div class="report-stats" id="weeklyStats">
                        <!-- 周度统计数据将通过JS动态生成 -->
                    </div>
                    
                    <div class="panel-left">
                        <div class="panel-title">
                            <h3>各项完成情况</h3>
                        </div>
                        <div class="completion-summary" id="completionSummary">
                            <!-- 完成情况将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="panel-left">
                        <div class="panel-title">
                            <h3>每日记录摘要</h3>
                        </div>
                        <div class="completion-summary" id="dailySummary">
                            <!-- 每日摘要将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 月度报告 -->
                <div class="tab-content" id="monthlyReportTab">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="reportMonth">选择月份</label>
                            <div class="input-wrapper">
                                <input type="month" id="reportMonth">
                                <button class="clear-btn" data-target="reportMonth">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="generateMonthlyReportBtn">
                            <i class="fas fa-chart-bar"></i> 生成月度报告
                        </button>
                    </div>
                    
                    <div class="monthly-calendar" id="monthlyCalendar">
                        <!-- 月度日历将通过JS动态生成 -->
                    </div>
                    
                    <div class="monthly-stats-grid" id="monthlyStats">
                        <!-- 月度统计数据将通过JS动态生成 -->
                    </div>
                    
                    <div class="panel-left">
                        <div class="panel-title">
                            <h3>月度完成情况</h3>
                        </div>
                        <div class="completion-summary" id="monthlyCompletionSummary">
                            <!-- 月度完成情况将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 所有记录查询 -->
                <div class="tab-content" id="allRecordsTab">
                    <div class="search-form all-records-search">
                        <div class="form-group">
                            <label for="allRecordsItem">事项</label>
                            <div class="select-wrapper">
                                <select id="allRecordsItem">
                                    <option value="">全部事项</option>
                                    <!-- 事项选项将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="allRecordsItem">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="allRecordsScore">分数</label>
                            <div class="select-wrapper">
                                <select id="allRecordsScore">
                                    <option value="">全部分数</option>
                                    <option value="positive">正分</option>
                                    <option value="negative">负分</option>
                                    <option value="5">5分</option>
                                    <option value="4">4分</option>
                                    <option value="3">3分</option>
                                    <option value="2">2分</option>
                                    <option value="1">1分</option>
                                    <option value="-1">-1分</option>
                                    <option value="-2">-2分</option>
                                    <option value="-3">-3分</option>
                                    <option value="-4">-4分</option>
                                    <option value="-5">-5分</option>
                                </select>
                                <button class="clear-btn" data-target="allRecordsScore">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="allRecordsUnitType">单位类型</label>
                            <div class="select-wrapper">
                                <select id="allRecordsUnitType">
                                    <option value="">全部类型</option>
                                    <option value="timePoint">时间点</option>
                                    <option value="count">次</option>
                                    <option value="distance">公里</option>
                                    <option value="duration">时长</option>
                                    <!-- 自定义单位类型将通过JS动态生成 -->
                                </select>
                                <button class="clear-btn" data-target="allRecordsUnitType">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="search-btn" id="searchAllRecordsBtn">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                    
                    <div class="all-records-summary" id="allRecordsSummary">
                        <!-- 所有记录摘要信息将通过JS动态生成 -->
                    </div>
                    
                    <div class="all-records-list-container">
                        <ul class="all-records-list" id="allRecordsList">
                            <!-- 所有记录列表将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 记录详情弹框 -->
    <div class="modal-overlay" id="recordDetailsModal">
        <div class="modal record-details-modal">
            <div class="modal-header">
                <h3 class="modal-title">记录详情</h3>
                <button class="modal-close" id="closeRecordDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="recordDetailsContent">
                    <!-- 记录详情内容将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加自定义单位类型弹框 -->
    <div class="modal-overlay" id="addUnitTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">添加自定义单位类型</h3>
                <button class="modal-close" id="closeAddUnitTypeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="customUnitName">单位名称（不超过5个字）</label>
                    <div class="input-wrapper">
                        <input type="text" id="customUnitName" maxlength="5" placeholder="例如：页、杯、个">
                        <button class="clear-btn" data-target="customUnitName">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="customUnitDescription">单位说明</label>
                    <div class="input-wrapper">
                        <textarea id="customUnitDescription" placeholder="请输入单位说明" rows="2"></textarea>
                        <button class="clear-btn" data-target="customUnitDescription">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 25px;">
                    <button class="save-btn" id="saveUnitTypeBtn">保存单位类型</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用说明弹框 -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">使用说明</h3>
                <button class="modal-close" id="closeHelpModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h3>周勤评分系统使用指南</h3>
                <p>本系统旨在帮助您养成良好的习惯，通过评分机制激励自我提升。</p>
                
                <h4>主要功能</h4>
                <ul class="instructions-list">
                    <li><strong>主界面</strong>：用于新增当日记录，查看当前模板事项和当日完成记录。</li>
                    <li><strong>自定义功能</strong>：包括事项及分数管理、模板管理和数据管理。</li>
                    <li><strong>记录管理</strong>：提供每日查询和周度报告功能，帮助您跟踪习惯养成进度。</li>
                    <li><strong>数据管理</strong>：支持数据导入导出、自动备份和恢复功能。</li>
                </ul>
                
                <h4>使用流程</h4>
                <ol class="instructions-list">
                    <li>在"自定义功能"中设置您要养成习惯的事项及评分规则</li>
                    <li>创建模板，将相关事项组合在一起方便管理</li>
                    <li>在主界面选择当前使用模板</li>
                    <li>每日完成事项后，在主界面添加记录</li>
                    <li>通过"记录管理"查看进度和统计数据</li>
                    <li>通过"数据管理"定期备份您的数据</li>
                </ol>

                <h4>使用须知</h4>
                <ol class="instructions-list" style="color: rgb(76, 92, 185);">
                    <li>所有事项及评分都要事先录入</li>
                    <li>事项录入后，要添加使用模板，系统根据模板来生成拷贝模板，用来主界面显示逻辑和计分</li>
                    <li>周期性事项，使用间隔天数实现，例：每隔三天运动一次，间隔天数即3；默认为0，表示每天都要做。</li>
                    <li>周期性事项在下一次记录之前显示为未到期状态，并显示已经完成日期。</li>
                    <li>当日累计得分：当日完成记录得分 + 显示模板里的事项未完成记录得分</li>
                    <li>仅完成记录总分：仅计算当日完成记录的总得分</li>
                    <li>建议定期导出数据备份，系统会自动保存最近5个备份版本</li>
                </ol>
                
                <h4>注意事项</h4>
                <ul class="instructions-list">
                    <li>事项名称不超过5个字</li>
                    <li>间隔天数表示该事项完成后，下次执行间隔的天数</li>
                    <li>同一事项在同一天可以记录多次，都会参与计分</li>
                    <li>数据会自动保存到浏览器本地存储中</li>
                    <li>导入数据时会进行验证，确保数据格式正确</li>
                    <li>评分可以下拉选择，也可以手动输入整数</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 自定义通知 -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-title" id="notificationTitle">通知</div>
            <button class="notification-close" id="notificationClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-content" id="notificationContent">这是一条通知</div>
    </div>

    <!-- 确认对话框 -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-title" id="confirmTitle">确认操作</div>
            <div class="confirm-message" id="confirmMessage">您确定要执行此操作吗？</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">取消</button>
                <button class="confirm-btn confirm" id="confirmOk">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 周勤评分系统 - 完整版（包含数据导入导出功能和新增功能）
        class HabitScoreSystem {
            constructor() {
                // 初始化数据
                this.data = {
                    items: [], // 事项列表
                    templates: [], // 模板列表
                    currentTemplateId: null, // 当前使用的模板ID
                    dailyRecords: {}, // 每日记录
                    history: [], // 历史记录
                    currentTemplateCopy: [], // 当前模板拷贝，包含事项状态
                    customUnitTypes: [] // 自定义单位类型
                };
                
                // 备份数据
                this.backups = [];
                this.maxBackups = 5; // 最大备份数量
                this.lastExportReminder = null; // 上次导出提醒时间
                this.reminderIntervalDays = 7; // 提醒间隔天数
                
                // 内置单位类型数组
                this.builtInUnitTypes = [
                    { value: 'timePoint', label: '时间点', unit: '时间点' },
                    { value: 'count', label: '次', unit: '次' },
                    { value: 'distance', label: '公里', unit: '公里' },
                    { value: 'duration', label: '时长', unit: '分钟' }
                ];
                
                // 获取所有单位类型（内置+自定义）
                this.getAllUnitTypes = () => {
                    return [...this.builtInUnitTypes, ...this.data.customUnitTypes];
                };
                
                // 当前编辑的事项ID（用于编辑模式）
                this.editingItemId = null;
                
                // 当前编辑的模板ID（用于编辑模式）
                this.editingTemplateId = null;
                
                // 当前编辑的时间点信息
                this.editingTimePoint = {
                    itemId: null,
                    timePointIndex: null,
                    tempId: null
                };
                
                // 当前编辑的单位评分信息
                this.editingUnitScore = {
                    itemId: null,
                    unitScoreIndex: null,
                    tempId: null
                };
                
                // 模板表单中已选择的事项ID数组
                this.selectedTemplateItems = [];
                
                // 确认对话框回调函数
                this.confirmCallback = null;
                
                // 保存记录时的重复记录确认回调
                this.duplicateRecordCallback = null;
                
                // 保存记录时的数据
                this.pendingRecordData = null;
                
                // 是否已播放过庆祝特效
                this.hasCelebrated = false;
                
                // 模态框关闭控制
                this.modalClickStartOutside = false;
                
                // 导入相关变量
                this.importFile = null;
                this.importPreviewData = null;
                
                // 当前查询的所有记录结果
                this.currentAllRecordsResults = [];
                
                // 初始化
                this.init();
            }
            
            // 初始化系统
            init() {
                this.loadData();
                this.loadBackups();
                this.checkExportReminder();
                this.bindEvents();
                this.renderAll();
            }
            
            // 加载数据
            loadData() {
                // 尝试从localStorage加载数据
                const savedData = localStorage.getItem('habitScoreSystem');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // 数据迁移：如果customUnitTypes不存在，初始化为空数组
                    if (!parsedData.customUnitTypes) {
                        parsedData.customUnitTypes = [];
                    }
                    
                    this.data = parsedData;
                    
                    // 如果模板拷贝不存在，重新生成
                    if (!this.data.currentTemplateCopy || this.data.currentTemplateCopy.length === 0) {
                        this.generateTemplateCopy();
                    }
                } else {
                    // 初始化示例数据
                    this.initSampleData();
                }
            }
            
            // 保存数据
            saveData() {
                localStorage.setItem('habitScoreSystem', JSON.stringify(this.data));
                // 自动创建备份
                this.autoCreateBackup();
                // 更新数据统计显示
                if (document.getElementById('dataTab').classList.contains('active')) {
                    this.renderDataStats();
                }
            }
            
            // 加载备份数据
            loadBackups() {
                const savedBackups = localStorage.getItem('habitScoreSystemBackups');
                if (savedBackups) {
                    this.backups = JSON.parse(savedBackups);
                }
            }
            
            // 保存备份数据
            saveBackups() {
                localStorage.setItem('habitScoreSystemBackups', JSON.stringify(this.backups));
                // 更新备份列表显示
                if (document.getElementById('dataTab').classList.contains('active')) {
                    this.renderBackupList();
                }
            }
            
            // 检查导出提醒
            checkExportReminder() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // 从localStorage加载上次提醒时间
                const lastReminderStr = localStorage.getItem('lastExportReminder');
                
                if (lastReminderStr) {
                    this.lastExportReminder = new Date(lastReminderStr);
                    const daysSinceLastReminder = Math.floor((today - this.lastExportReminder) / (1000 * 60 * 60 * 24));
                    
                    // 如果超过提醒间隔天数，显示提醒
                    if (daysSinceLastReminder >= this.reminderIntervalDays) {
                        setTimeout(() => {
                            this.showExportReminder();
                        }, 2000); // 延迟2秒显示，让页面先加载
                    }
                } else {
                    // 第一次使用，设置提醒时间为今天
                    this.lastExportReminder = today;
                    localStorage.setItem('lastExportReminder', today.toISOString());
                }
            }
            
            // 显示导出提醒
            showExportReminder() {
                this.showNotification('数据备份提醒', `您已经${this.reminderIntervalDays}天没有导出数据了，建议定期导出备份以防数据丢失。`, 'warning');
                
                // 更新提醒时间
                const today = new Date();
                localStorage.setItem('lastExportReminder', today.toISOString());
                this.lastExportReminder = today;
            }
            
            // 自动创建备份
            autoCreateBackup() {
                // 每天只自动备份一次
                const today = new Date().toISOString().split('T')[0];
                const lastBackup = this.backups[0];
                
                if (lastBackup && lastBackup.date === today && lastBackup.type === 'auto') {
                    return; // 今天已经自动备份过了
                }
                
                // 创建备份
                const backup = {
                    id: Date.now(),
                    name: `自动备份_${today}`,
                    date: today,
                    time: new Date().toLocaleTimeString(),
                    type: 'auto',
                    data: JSON.parse(JSON.stringify(this.data)) // 深拷贝
                };
                
                // 添加到备份列表开头
                this.backups.unshift(backup);
                
                // 限制备份数量
                if (this.backups.length > this.maxBackups) {
                    this.backups = this.backups.slice(0, this.maxBackups);
                }
                
                // 保存备份
                this.saveBackups();
            }
            
            // 创建手动备份
            createManualBackup() {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toLocaleTimeString();
                
                const backup = {
                    id: Date.now(),
                    name: `手动备份_${dateStr}_${timeStr.replace(/:/g, '-')}`,
                    date: dateStr,
                    time: timeStr,
                    type: 'manual',
                    data: JSON.parse(JSON.stringify(this.data)) // 深拷贝
                };
                
                // 添加到备份列表开头
                this.backups.unshift(backup);
                
                // 限制备份数量
                if (this.backups.length > this.maxBackups) {
                    this.backups = this.backups.slice(0, this.maxBackups);
                }
                
                // 保存备份
                this.saveBackups();
                
                this.showNotification('成功', '手动备份创建成功', 'success');
            }
            
            // 恢复备份
            restoreBackup(backupId) {
                const backup = this.backups.find(b => b.id === backupId);
                if (!backup) {
                    this.showNotification('错误', '备份不存在', 'error');
                    return;
                }
                
                this.showConfirmDialog('恢复备份', '确定要恢复此备份吗？当前数据将被覆盖。', () => {
                    this.data = JSON.parse(JSON.stringify(backup.data)); // 深拷贝
                    this.saveData();
                    this.renderAll();
                    this.showNotification('成功', '备份恢复成功', 'success');
                });
            }
            
            // 删除备份
            deleteBackup(backupId) {
                const index = this.backups.findIndex(b => b.id === backupId);
                if (index === -1) return;
                
                this.backups.splice(index, 1);
                this.saveBackups();
                this.showNotification('成功', '备份删除成功', 'success');
            }
            
            // 清空所有备份
            clearAllBackups() {
                if (this.backups.length === 0) {
                    this.showNotification('提示', '没有备份可清除', 'info');
                    return;
                }
                
                this.showConfirmDialog('清空备份', '确定要清空所有备份吗？此操作不可撤销。', () => {
                    this.backups = [];
                    this.saveBackups();
                    this.showNotification('成功', '所有备份已清除', 'success');
                });
            }
            
            // 初始化示例数据
            initSampleData() {
                // 初始化事项数据
                this.data.items = [
                    {
                        id: 1,
                        name: '早餐',
                        description: '每日早餐',
                        unitType: 'timePoint',
                        intervalDays: 0,
                        unfinishedScore: -2,
                        timePoints: [
                            { id: 1, time: '6:00', score: 4, description: '按时早餐' },
                            { id: 2, time: '7:00', score: 2, description: '稍晚早餐' },
                            { id: 3, time: '8:00', score: 1, description: '迟到早餐' }
                        ]
                    },
                    {
                        id: 2,
                        name: '跑步',
                        description: '日常跑步',
                        unitType: 'distance',
                        intervalDays: 1,
                        unfinishedScore: -3,
                        unitScores: [
                            { id: 1, value: "1~3", unit: '公里', score: 3, description: '1-3公里跑步' },
                            { id: 2, value: "3~5", unit: '公里', score: 5, description: '3-5公里跑步' },
                            { id: 3, value: "5", unit: '公里', score: 8, description: '5公里跑步' }
                        ]
                    },
                    {
                        id: 3,
                        name: '阅读',
                        description: '每日阅读',
                        unitType: 'duration',
                        intervalDays: 0,
                        unfinishedScore: -1,
                        unitScores: [
                            { id: 4, value: "15~30", unit: '分钟', score: 2, description: '15-30分钟阅读' },
                            { id: 5, value: "30~60", unit: '分钟', score: 4, description: '30-60分钟阅读' },
                            { id: 6, value: "60", unit: '分钟', score: 6, description: '60分钟阅读' }
                        ]
                    },
                    {
                        id: 4,
                        name: '俯卧撑',
                        description: '每日锻炼',
                        unitType: 'count',
                        intervalDays: 0,
                        unfinishedScore: -2,
                        unitScores: [
                            { id: 7, value: "10~20", unit: '次', score: 3, description: '10-20次俯卧撑' },
                            { id: 8, value: "20~30", unit: '次', score: 5, description: '20-30次俯卧撑' },
                            { id: 9, value: "30", unit: '次', score: 8, description: '30次俯卧撑' }
                        ]
                    }
                ];
                
                // 初始化模板数据
                this.data.templates = [
                    {
                        id: 1,
                        name: '默认模板',
                        itemIds: [1, 2, 3, 4]
                    },
                    {
                        id: 2,
                        name: '健康模板',
                        itemIds: [1, 2, 4]
                    },
                    {
                        id: 3,
                        name: '学习模板',
                        itemIds: [1, 3]
                    }
                ];
                
                // 初始化自定义单位类型
                this.data.customUnitTypes = [
                    { value: 'page', label: '页', unit: '页' },
                    { value: 'cup', label: '杯', unit: '杯' }
                ];
                
                // 设置当前模板
                this.data.currentTemplateId = 1;
                
                // 生成模板拷贝
                this.generateTemplateCopy();
                
                // 初始化今日记录
                const today = this.getTodayDate();
                this.data.dailyRecords = {
                    [today]: {
                        date: today,
                        totalScore: 0,
                        records: [],
                        templateId: 1
                    }
                };
                
                // 初始化历史记录
                this.data.history = [
                    {
                        date: this.getPreviousDayDate(),
                        totalScore: 16,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '6:00', score: 4, isTemplateItem: true },
                            { itemId: 2, itemName: '跑步', value: 3, unit: '公里', score: 5, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 30, unit: '分钟', score: 4, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 20, unit: '次', score: 3, isTemplateItem: true }
                        ],
                        templateId: 1
                    },
                    {
                        date: '2023-10-24',
                        totalScore: 14,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '7:00', score: 2, isTemplateItem: true },
                            { itemId: 2, itemName: '跑步', value: 1, unit: '公里', score: 3, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 15, unit: '分钟', score: 2, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 10, unit: '次', score: 3, isTemplateItem: true }
                        ],
                        templateId: 1
                    },
                    {
                        date: '2023-10-25',
                        totalScore: 12,
                        records: [
                            { itemId: 1, itemName: '早餐', time: '6:00', score: 4, isTemplateItem: true },
                            { itemId: 3, itemName: '阅读', value: 60, unit: '分钟', score: 6, isTemplateItem: true },
                            { itemId: 4, itemName: '俯卧撑', value: 30, unit: '次', score: 2, isTemplateItem: true }
                        ],
                        templateId: 1
                    }
                ];
                
                this.saveData();
            }
            
            // 获取今天日期字符串
            getTodayDate() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }
            
            // 获取前一天日期字符串
            getPreviousDayDate() {
                const today = new Date();
                const previousDay = new Date(today);
                previousDay.setDate(today.getDate() - 1);
                return previousDay.toISOString().split('T')[0];
            }
            
            // 获取当前模板
            getCurrentTemplate() {
                return this.data.templates.find(t => t.id === this.data.currentTemplateId);
            }
            
            // 生成模板拷贝
            generateTemplateCopy() {
                const currentTemplate = this.getCurrentTemplate();
                if (!currentTemplate) {
                    this.data.currentTemplateCopy = [];
                    return;
                }
                
                const today = this.getTodayDate();
                const todayRecord = this.getTodayRecord();
                
                // 初始化模板拷贝
                this.data.currentTemplateCopy = currentTemplate.itemIds.map(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return null;
                    
                    // 检查今日是否已完成
                    const completedToday = todayRecord.records.some(r => r.itemId === itemId);
                    
                    if (completedToday) {
                        // 今日已完成
                        return {
                            itemId,
                            status: 'completed',
                            completionDate: today
                        };
                    }
                    
                    // 如果间隔天数为0，检查今日是否完成
                    if (item.intervalDays === 0) {
                        // 间隔为0，今日未完成
                        return {
                            itemId,
                            status: 'overdue'
                        };
                    }
                    
                    // 间隔天数大于0，查询历史记录
                    // 从今天往前推，最多查询间隔天数内的记录
                    const intervalDays = item.intervalDays;
                    let foundCompletion = false;
                    let completionDate = null;
                    
                    // 检查今天之前的间隔天数内的记录
                    for (let i = 1; i <= intervalDays; i++) {
                        const checkDate = new Date();
                        checkDate.setDate(checkDate.getDate() - i);
                        const checkDateStr = checkDate.toISOString().split('T')[0];
                        
                        // 检查该日期是否有完成记录
                        const isCompleted = this.isItemCompleted(itemId, checkDateStr);
                        if (isCompleted) {
                            foundCompletion = true;
                            completionDate = checkDateStr;
                            break;
                        }
                    }
                    
                    if (foundCompletion) {
                        // 在间隔天数内找到了完成记录
                        return {
                            itemId,
                            status: 'notDue',
                            completionDate
                        };
                    } else {
                        // 间隔天数内没有完成记录
                        return {
                            itemId,
                            status: 'overdue'
                        };
                    }
                }).filter(item => item !== null);
                
                // 保存数据
                this.saveData();
            }
            
            // 更新模板拷贝中特定事项的状态
            updateTemplateCopyItem(itemId, status, completionDate = null) {
                const copyItem = this.data.currentTemplateCopy.find(c => c.itemId === itemId);
                if (copyItem) {
                    copyItem.status = status;
                    if (completionDate) {
                        copyItem.completionDate = completionDate;
                    }
                    this.saveData();
                }
            }
            
            // 获取今日记录
            getTodayRecord() {
                const today = this.getTodayDate();
                if (!this.data.dailyRecords[today]) {
                    this.data.dailyRecords[today] = {
                        date: today,
                        totalScore: 0,
                        records: [],
                        templateId: this.data.currentTemplateId
                    };
                    // 生成模板拷贝
                    this.generateTemplateCopy();
                    this.saveData();
                }
                return this.data.dailyRecords[today];
            }
            
            // 计算当日累计分数（包括已完成事项和未完成事项的未完成分数）
            calculateDailyTotalScore() {
                const todayRecord = this.getTodayRecord();
                let totalScore = todayRecord.totalScore;
                
                // 遍历模板拷贝，将状态为overdue的事项的未完成分数加入
                this.data.currentTemplateCopy.forEach(copyItem => {
                    if (copyItem.status === 'overdue') {
                        const item = this.getItem(copyItem.itemId);
                        if (item) {
                            totalScore += item.unfinishedScore;
                        }
                    }
                });
                
                return totalScore;
            }
            
            // 计算仅完成记录总分（仅计算完成记录的总得分）
            calculateCompletedTotalScore() {
                const todayRecord = this.getTodayRecord();
                return todayRecord.totalScore;
            }
            
            // 计算指定日期的累计分数
            calculateDailyTotalScoreForDate(date) {
                let record = this.data.dailyRecords[date];
                if (!record) {
                    record = this.data.history.find(r => r.date === date);
                }
                
                if (!record) {
                    return 0;
                }
                
                let totalScore = record.totalScore;
                
                // 对于历史日期，我们需要模拟计算模板拷贝的状态
                const template = this.data.templates.find(t => t.id === record.templateId);
                if (template) {
                    // 遍历模板内的所有事项
                    template.itemIds.forEach(itemId => {
                        const item = this.getItem(itemId);
                        if (!item) return;
                        
                        // 检查该事项在指定日期是否已完成
                        const isCompleted = record.records.some(r => r.itemId === itemId);
                        
                        if (!isCompleted) {
                            // 未完成，需要检查是否在间隔天数内
                            if (item.intervalDays === 0) {
                                // 间隔为0，当日未完成，加上未完成分数
                                totalScore += item.unfinishedScore;
                            } else {
                                // 间隔天数大于0，检查间隔天数内的完成记录
                                const targetDate = new Date(date);
                                let foundCompletion = false;
                                
                                for (let i = 1; i <= item.intervalDays; i++) {
                                    const checkDate = new Date(targetDate);
                                    checkDate.setDate(checkDate.getDate() - i);
                                    const checkDateStr = checkDate.toISOString().split('T')[0];
                                    
                                    // 检查该日期是否有完成记录
                                    const isCompletedInHistory = this.isItemCompleted(itemId, checkDateStr);
                                    if (isCompletedInHistory) {
                                        foundCompletion = true;
                                        break;
                                    }
                                }
                                
                                // 如果间隔天数内没有找到完成记录，加上未完成分数
                                if (!foundCompletion) {
                                    totalScore += item.unfinishedScore;
                                }
                            }
                        }
                    });
                }
                
                return totalScore;
            }
            
            // 获取事项
            getItem(itemId) {
                return this.data.items.find(item => item.id === itemId);
            }
            
            // 获取事项名称
            getItemName(itemId) {
                const item = this.getItem(itemId);
                return item ? item.name : '未知事项';
            }
            
            // 获取事项的时间点选项
            getTimeOptions(itemId) {
                const item = this.getItem(itemId);
                if (!item || item.unitType !== 'timePoint') return [];
                
                return item.timePoints.map(tp => ({
                    value: tp.id,
                    text: `${tp.time} (${tp.score >= 0 ? '+' : ''}${tp.score}分) - ${tp.description}`
                }));
            }
            
            // 获取事项的单位评分选项
            getUnitScoreOptions(itemId) {
                const item = this.getItem(itemId);
                if (!item || item.unitType === 'timePoint') return [];
                
                const unitLabel = this.getUnitLabel(item.unitType);
                return item.unitScores.map(us => ({
                    value: us.id,
                    text: `${us.value}${unitLabel} (${us.score >= 0 ? '+' : ''}${us.score}分) - ${us.description}`
                }));
            }
            
            // 获取时间点的分数
            getTimePointScore(timePointId) {
                for (const item of this.data.items) {
                    if (item.unitType !== 'timePoint' || !item.timePoints) continue;
                    const timePoint = item.timePoints.find(tp => tp.id === timePointId);
                    if (timePoint) {
                        return timePoint.score;
                    }
                }
                return 0;
            }
            
            // 获取单位评分的分数
            getUnitScoreScore(unitScoreId) {
                for (const item of this.data.items) {
                    if (item.unitType === 'timePoint' || !item.unitScores) continue;
                    const unitScore = item.unitScores.find(us => us.id === unitScoreId);
                    if (unitScore) {
                        return unitScore.score;
                    }
                }
                return 0;
            }
            
            // 根据来源获取事项列表
            getItemsBySource(source) {
                if (source === 'template') {
                    const currentTemplate = this.getCurrentTemplate();
                    if (!currentTemplate) return [];
                    
                    return this.data.items.filter(item => 
                        currentTemplate.itemIds.includes(item.id)
                    );
                } else {
                    return this.data.items;
                }
            }
            
            // 获取单位标签
            getUnitLabel(unitType) {
                // 首先检查自定义单位类型
                const customUnit = this.data.customUnitTypes.find(u => u.value === unitType);
                if (customUnit) {
                    return customUnit.unit;
                }
                
                // 然后检查内置单位类型
                const builtInUnit = this.builtInUnitTypes.find(u => u.value === unitType);
                return builtInUnit ? builtInUnit.unit : '单位';
            }
            
            // 检查事项是否已完成
            isItemCompleted(itemId, date = null) {
                const targetDate = date || this.getTodayDate();
                const record = this.data.dailyRecords[targetDate] || 
                              this.data.history.find(r => r.date === targetDate);
                
                if (!record) return false;
                
                return record.records.some(r => r.itemId === itemId);
            }
            
            // 添加记录
            addRecord(itemId, scoreId, isTimePoint = true) {
                const item = this.getItem(itemId);
                if (!item) return false;
                
                const todayRecord = this.getTodayRecord();
                
                // 检查是否已记录过该事项（现在只提示，不阻止）
                const existingRecords = todayRecord.records.filter(r => r.itemId === itemId);
                
                let record;
                
                if (isTimePoint && item.unitType === 'timePoint') {
                    // 获取时间点
                    let timePoint = null;
                    for (const tp of item.timePoints) {
                        if (tp.id === scoreId) {
                            timePoint = tp;
                            break;
                        }
                    }
                    
                    if (!timePoint) {
                        this.showNotification('错误', '未找到对应的时间点', 'error');
                        return false;
                    }
                    
                    // 检查是否为模板内事项
                    const currentTemplate = this.getCurrentTemplate();
                    const isTemplateItem = currentTemplate ? 
                        currentTemplate.itemIds.includes(itemId) : false;
                    
                    // 添加记录
                    record = {
                        itemId,
                        itemName: item.name,
                        time: timePoint.time,
                        score: timePoint.score,
                        isTemplateItem,
                        scoreId,
                        unitType: 'timePoint'
                    };
                } else if (!isTimePoint && item.unitType !== 'timePoint') {
                    // 获取单位评分
                    let unitScore = null;
                    for (const us of item.unitScores) {
                        if (us.id === scoreId) {
                            unitScore = us;
                            break;
                        }
                    }
                    
                    if (!unitScore) {
                        this.showNotification('错误', '未找到对应的评分项', 'error');
                        return false;
                    }
                    
                    // 检查是否为模板内事项
                    const currentTemplate = this.getCurrentTemplate();
                    const isTemplateItem = currentTemplate ? 
                        currentTemplate.itemIds.includes(itemId) : false;
                    
                    // 添加记录
                    record = {
                        itemId,
                        itemName: item.name,
                        value: unitScore.value,
                        unit: unitScore.unit,
                        score: unitScore.score,
                        isTemplateItem,
                        scoreId,
                        unitType: item.unitType
                    };
                } else {
                    this.showNotification('错误', '记录类型不匹配', 'error');
                    return false;
                }
                
                todayRecord.records.push(record);
                todayRecord.totalScore += record.score;
                
                // 如果记录在模板内，更新模板拷贝状态
                if (record.isTemplateItem) {
                    this.updateTemplateCopyItem(itemId, 'completed', this.getTodayDate());
                }
                
                this.saveData();
                
                // 检查是否是第一条记录，如果是则触发庆祝特效
                if (todayRecord.records.length === 1) {
                    this.triggerCelebration();
                } else {
                    this.showNotification('成功', '记录添加成功', 'success');
                }
                
                // 更新当日累计分数显示
                this.updateDailyTotalScore();
                
                return true;
            }
            
            // 触发庆祝特效
            triggerCelebration() {
                // 显示庆祝消息
                const celebrationMessage = document.getElementById('celebrationMessage');
                celebrationMessage.classList.add('active');
                
                // 显示烟花特效
                const fireworksContainer = document.getElementById('fireworksContainer');
                fireworksContainer.classList.add('active');
                
                // 生成烟花
                this.createFireworks();
                
                // 3秒后隐藏庆祝消息
                setTimeout(() => {
                    celebrationMessage.classList.remove('active');
                }, 3000);
                
                // 5秒后停止烟花
                setTimeout(() => {
                    fireworksContainer.classList.remove('active');
                    // 清空烟花容器
                    fireworksContainer.innerHTML = '';
                }, 5000);
                
                this.showNotification('成功', '记录添加成功！今日首次签到！', 'success');
            }
            
            // 创建烟花效果
            createFireworks() {
                const container = document.getElementById('fireworksContainer');
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#ff0088'];
                
                // 创建多个烟花
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        
                        // 随机位置
                        const left = Math.random() * 100;
                        const top = Math.random() * 100;
                        
                        // 随机颜色
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        firework.style.left = `${left}%`;
                        firework.style.top = `${top}%`;
                        firework.style.backgroundColor = color;
                        firework.style.boxShadow = `0 0 10px ${color}, 0 0 20px ${color}`;
                        
                        container.appendChild(firework);
                        
                        // 添加爆炸效果
                        this.explodeFirework(firework, color);
                        
                        // 2秒后移除烟花
                        setTimeout(() => {
                            if (firework.parentNode) {
                                firework.parentNode.removeChild(firework);
                            }
                        }, 2000);
                        
                    }, i * 150);
                }
            }
            
            // 烟花爆炸效果
            explodeFirework(firework, color) {
                setTimeout(() => {
                    const container = firework.parentNode;
                    const rect = firework.getBoundingClientRect();
                    
                    // 创建爆炸粒子
                    for (let i = 0; i < 12; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework';
                        
                        // 计算粒子位置
                        const angle = (i / 12) * Math.PI * 2;
                        const distance = 30 + Math.random() * 40;
                        
                        particle.style.left = `50%`;
                        particle.style.top = `50%`;
                        particle.style.width = '3px';
                        particle.style.height = '3px';
                        particle.style.backgroundColor = color;
                        particle.style.boxShadow = `0 0 5px ${color}`;
                        particle.style.position = 'absolute';
                        particle.style.transform = `translate(-50%, -50%)`;
                        
                        container.appendChild(particle);
                        
                        // 动画
                        setTimeout(() => {
                            particle.style.transition = 'all 0.8s ease-out';
                            particle.style.left = `${50 + Math.cos(angle) * distance}%`;
                            particle.style.top = `${50 + Math.sin(angle) * distance}%`;
                            particle.style.opacity = '0';
                            
                            // 移除粒子
                            setTimeout(() => {
                                if (particle.parentNode) {
                                    particle.parentNode.removeChild(particle);
                                }
                            }, 800);
                        }, 10);
                    }
                }, 500);
            }
            
            // 删除记录
            deleteRecord(date, recordIndex) {
                const record = this.data.dailyRecords[date] || 
                              this.data.history.find(r => r.date === date);
                
                if (!record || !record.records[recordIndex]) return false;
                
                const deletedRecord = record.records[recordIndex];
                
                // 更新总分
                record.totalScore -= deletedRecord.score;
                
                // 如果删除的是模板内事项，重新生成模板拷贝
                if (deletedRecord.isTemplateItem && date === this.getTodayDate()) {
                    // 删除记录
                    record.records.splice(recordIndex, 1);
                    // 重新生成模板拷贝
                    this.generateTemplateCopy();
                } else {
                    // 删除记录
                    record.records.splice(recordIndex, 1);
                }
                
                this.saveData();
                return true;
            }
            
            // 添加事项
            addItem(itemData) {
                // 检查事项名称是否已存在
                const existingItem = this.data.items.find(item => item.name === itemData.name);
                if (existingItem) {
                    return false; // 名称已存在
                }
                
                // 生成新ID
                const newId = this.data.items.length > 0 ? 
                    Math.max(...this.data.items.map(i => i.id)) + 1 : 1;
                
                // 创建新事项
                const newItem = {
                    id: newId,
                    ...itemData
                };
                
                this.data.items.push(newItem);
                this.saveData();
                return newId;
            }
            
            // 更新事项
            updateItem(itemId, itemData) {
                const index = this.data.items.findIndex(i => i.id === itemId);
                if (index === -1) return false;
                
                // 检查事项名称是否已存在（除了自己）
                const existingItem = this.data.items.find(item => item.name === itemData.name && item.id !== itemId);
                if (existingItem) {
                    return false; // 名称已存在
                }
                
                // 保留ID
                itemData.id = itemId;
                this.data.items[index] = itemData;
                this.saveData();
                return true;
            }
            
            // 删除事项
            deleteItem(itemId) {
                const index = this.data.items.findIndex(i => i.id === itemId);
                if (index === -1) return false;
                
                // 从所有模板中移除该事项
                for (const template of this.data.templates) {
                    const itemIndex = template.itemIds.indexOf(itemId);
                    if (itemIndex !== -1) {
                        template.itemIds.splice(itemIndex, 1);
                    }
                }
                
                // 从模板拷贝中移除
                this.data.currentTemplateCopy = this.data.currentTemplateCopy.filter(c => c.itemId !== itemId);
                
                // 删除事项
                this.data.items.splice(index, 1);
                this.saveData();
                return true;
            }
            
            // 添加自定义单位类型
            addCustomUnitType(unitData) {
                // 检查单位名称是否已存在
                const existingUnit = this.data.customUnitTypes.find(u => u.label === unitData.label);
                if (existingUnit) {
                    return false; // 名称已存在
                }
                
                // 生成新值
                const newValue = unitData.label.toLowerCase() + '_' + Date.now();
                
                // 创建新单位类型
                const newUnit = {
                    value: newValue,
                    label: unitData.label,
                    unit: unitData.unit,
                    description: unitData.description || ''
                };
                
                this.data.customUnitTypes.push(newUnit);
                this.saveData();
                return newValue;
            }
            
            // 删除自定义单位类型
            deleteCustomUnitType(unitValue) {
                const index = this.data.customUnitTypes.findIndex(u => u.value === unitValue);
                if (index === -1) return false;
                
                // 检查是否有事项使用此单位类型
                const itemsUsingUnit = this.data.items.filter(item => item.unitType === unitValue);
                if (itemsUsingUnit.length > 0) {
                    return false; // 有事项在使用此单位类型，不能删除
                }
                
                this.data.customUnitTypes.splice(index, 1);
                this.saveData();
                return true;
            }
            
            // 添加模板
            addTemplate(templateData) {
                // 检查模板名称是否已存在
                const existingTemplate = this.data.templates.find(t => t.name === templateData.name);
                if (existingTemplate) {
                    return false; // 名称已存在
                }
                
                // 生成新ID
                const newId = this.data.templates.length > 0 ? 
                    Math.max(...this.data.templates.map(t => t.id)) + 1 : 1;
                
                // 创建新模板
                const newTemplate = {
                    id: newId,
                    ...templateData
                };
                
                this.data.templates.push(newTemplate);
                this.saveData();
                return newId;
            }
            
            // 更新模板
            updateTemplate(templateId, templateData) {
                const index = this.data.templates.findIndex(t => t.id === templateId);
                if (index === -1) return false;
                
                // 检查模板名称是否已存在（除了自己）
                const existingTemplate = this.data.templates.find(t => t.name === templateData.name && t.id !== templateId);
                if (existingTemplate) {
                    return false; // 名称已存在
                }
                
                // 保留ID
                templateData.id = templateId;
                this.data.templates[index] = templateData;
                this.saveData();
                return true;
            }
            
            // 删除模板
            deleteTemplate(templateId) {
                // 不能删除当前使用的模板
                if (templateId === this.data.currentTemplateId) {
                    return false;
                }
                
                const index = this.data.templates.findIndex(t => t.id === templateId);
                if (index === -1) return false;
                
                this.data.templates.splice(index, 1);
                this.saveData();
                return true;
            }
            
            // 设置当前模板
            setCurrentTemplate(templateId) {
                const template = this.data.templates.find(t => t.id === templateId);
                if (!template) return false;
                
                this.data.currentTemplateId = templateId;
                
                // 更新今日记录的模板ID
                const todayRecord = this.getTodayRecord();
                todayRecord.templateId = templateId;
                
                // 重新生成模板拷贝
                this.generateTemplateCopy();
                
                this.saveData();
                return true;
            }
            
            // 查询每日记录
            queryDailyRecords(date, itemFilter = '') {
                let record = this.data.dailyRecords[date];
                if (!record) {
                    record = this.data.history.find(r => r.date === date);
                }
                
                if (!record) {
                    return {
                        totalScore: 0,
                        completedTotalScore: 0,
                        templateItems: [],
                        records: []
                    };
                }
                
                // 获取当日模板
                const template = this.data.templates.find(t => t.id === record.templateId);
                const templateItems = template ? template.itemIds.map(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return null;
                    
                    const completed = record.records.some(r => r.itemId === itemId);
                    
                    // 确定状态
                    let status = 'overdue';
                    let completionDate = null;
                    
                    if (completed) {
                        status = 'completed';
                        completionDate = date;
                    } else if (item.intervalDays > 0) {
                        // 检查间隔天数内的完成记录
                        const targetDate = new Date(date);
                        let foundCompletion = false;
                        
                        for (let i = 1; i <= item.intervalDays; i++) {
                            const checkDate = new Date(targetDate);
                            checkDate.setDate(checkDate.getDate() - i);
                            const checkDateStr = checkDate.toISOString().split('T')[0];
                            
                            // 检查该日期是否有完成记录
                            const isCompletedInHistory = this.isItemCompleted(itemId, checkDateStr);
                            if (isCompletedInHistory) {
                                foundCompletion = true;
                                completionDate = checkDateStr;
                                break;
                            }
                        }
                        
                        if (foundCompletion) {
                            status = 'notDue';
                        }
                    }
                    
                    return {
                        itemId,
                        name: item.name,
                        intervalDays: item.intervalDays,
                        unfinishedScore: item.unfinishedScore,
                        status,
                        completionDate
                    };
                }).filter(item => item !== null) : [];
                
                // 过滤记录
                let records = record.records;
                if (itemFilter) {
                    records = records.filter(r => r.itemName === itemFilter);
                }
                
                // 计算完成记录总分
                const completedTotalScore = record.totalScore;
                
                return {
                    totalScore: this.calculateDailyTotalScoreForDate(date),
                    completedTotalScore,
                    templateItems,
                    records
                };
            }
            
            // 生成周度报告
            generateWeeklyReport(startDateStr) {
                // 计算一周的日期范围
                const startDate = new Date(startDateStr);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                // 获取该周的所有记录
                const weekRecords = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    let record = this.data.dailyRecords[dateStr];
                    if (!record) {
                        record = this.data.history.find(r => r.date === dateStr);
                    }
                    if (record) {
                        weekRecords.push(record);
                    }
                }
                
                if (weekRecords.length === 0) {
                    return null;
                }
                
                // 计算统计数据
                const stats = {
                    recordDays: weekRecords.length,
                    interruptDays: 7 - weekRecords.length,
                    longestStreak: 0,
                    currentStreak: 0,
                    totalScore: 0,
                    completedTotalScore: 0,
                    maxDailyScore: -Infinity,
                    minDailyScore: Infinity,
                    averageScore: 0,
                    itemsCompletion: {}
                };
                
                // 计算连续天数
                let currentStreak = 0;
                let longestStreak = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const hasRecord = weekRecords.some(r => r.date === dateStr);
                    
                    if (hasRecord) {
                        currentStreak++;
                        longestStreak = Math.max(longestStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                }
                
                stats.longestStreak = longestStreak;
                stats.currentStreak = currentStreak;
                
                // 计算分数统计
                for (const record of weekRecords) {
                    const dailyTotal = this.calculateDailyTotalScoreForDate(record.date);
                    stats.totalScore += dailyTotal;
                    stats.completedTotalScore += record.totalScore;
                    stats.maxDailyScore = Math.max(stats.maxDailyScore, dailyTotal);
                    stats.minDailyScore = Math.min(stats.minDailyScore, dailyTotal);
                    
                    // 统计事项完成情况
                    for (const r of record.records) {
                        if (!stats.itemsCompletion[r.itemName]) {
                            stats.itemsCompletion[r.itemName] = {
                                count: 0,
                                totalScore: 0
                            };
                        }
                        stats.itemsCompletion[r.itemName].count++;
                        stats.itemsCompletion[r.itemName].totalScore += r.score;
                    }
                }
                
                stats.averageScore = stats.recordDays > 0 ? stats.totalScore / stats.recordDays : 0;
                
                return {
                    weekStart: startDateStr,
                    weekEnd: endDate.toISOString().split('T')[0],
                    records: weekRecords,
                    stats
                };
            }
            
            // 生成月度报告
            generateMonthlyReport(yearMonth) {
                // 解析年月
                const [year, month] = yearMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0); // 当月最后一天
                
                // 获取该月的所有记录
                const monthRecords = [];
                const calendarDays = [];
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    let record = this.data.dailyRecords[dateStr];
                    if (!record) {
                        record = this.data.history.find(r => r.date === dateStr);
                    }
                    
                    calendarDays.push({
                        date: dateStr,
                        day: d.getDate(),
                        hasRecord: !!record,
                        record: record
                    });
                    
                    if (record) {
                        monthRecords.push(record);
                    }
                }
                
                if (monthRecords.length === 0) {
                    return null;
                }
                
                // 计算统计数据
                const stats = {
                    recordDays: monthRecords.length,
                    totalDays: endDate.getDate(),
                    completionRate: Math.round((monthRecords.length / endDate.getDate()) * 100),
                    longestStreak: 0,
                    currentStreak: 0,
                    totalScore: 0,
                    completedTotalScore: 0,
                    maxDailyScore: -Infinity,
                    minDailyScore: Infinity,
                    averageScore: 0,
                    itemsCompletion: {},
                    dailyScores: []
                };
                
                // 计算连续天数
                let currentStreak = 0;
                let longestStreak = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const hasRecord = monthRecords.some(r => r.date === dateStr);
                    
                    if (hasRecord) {
                        currentStreak++;
                        longestStreak = Math.max(longestStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                }
                
                stats.longestStreak = longestStreak;
                
                // 计算当前连续天数（从最后一天往前）
                currentStreak = 0;
                for (let d = new Date(endDate); d >= startDate; d.setDate(d.getDate() - 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const hasRecord = monthRecords.some(r => r.date === dateStr);
                    
                    if (hasRecord) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
                stats.currentStreak = currentStreak;
                
                // 计算分数统计
                for (const record of monthRecords) {
                    const dailyTotal = this.calculateDailyTotalScoreForDate(record.date);
                    stats.totalScore += dailyTotal;
                    stats.completedTotalScore += record.totalScore;
                    stats.maxDailyScore = Math.max(stats.maxDailyScore, dailyTotal);
                    stats.minDailyScore = Math.min(stats.minDailyScore, dailyTotal);
                    stats.dailyScores.push({
                        date: record.date,
                        score: dailyTotal,
                        completedScore: record.totalScore
                    });
                    
                    // 统计事项完成情况
                    for (const r of record.records) {
                        if (!stats.itemsCompletion[r.itemName]) {
                            stats.itemsCompletion[r.itemName] = {
                                count: 0,
                                totalScore: 0
                            };
                        }
                        stats.itemsCompletion[r.itemName].count++;
                        stats.itemsCompletion[r.itemName].totalScore += r.score;
                    }
                }
                
                stats.averageScore = stats.recordDays > 0 ? Math.round(stats.totalScore / stats.recordDays * 10) / 10 : 0;
                
                return {
                    year,
                    month,
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    calendarDays,
                    records: monthRecords,
                    stats
                };
            }
            
            // 查询所有记录（除当日）
            queryAllRecords(filters = {}) {
                const today = this.getTodayDate();
                const allRecords = [];
                
                // 获取历史记录
                this.data.history.forEach(record => {
                    if (record.date !== today) {
                        allRecords.push({
                            date: record.date,
                            type: 'history',
                            record: record
                        });
                    }
                });
                
                // 获取每日记录（除今日）
                Object.entries(this.data.dailyRecords).forEach(([date, record]) => {
                    if (date !== today) {
                        allRecords.push({
                            date: date,
                            type: 'daily',
                            record: record
                        });
                    }
                });
                
                // 按日期倒序排序
                allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // 应用筛选条件
                let filteredRecords = allRecords;
                
                if (filters.item) {
                    filteredRecords = filteredRecords.filter(item => {
                        return item.record.records.some(r => r.itemName === filters.item);
                    });
                }
                
                if (filters.score) {
                    if (filters.score === 'positive') {
                        filteredRecords = filteredRecords.filter(item => {
                            return item.record.totalScore > 0;
                        });
                    } else if (filters.score === 'negative') {
                        filteredRecords = filteredRecords.filter(item => {
                            return item.record.totalScore < 0;
                        });
                    } else {
                        const scoreValue = parseInt(filters.score);
                        filteredRecords = filteredRecords.filter(item => {
                            return item.record.records.some(r => r.score === scoreValue);
                        });
                    }
                }
                
                if (filters.unitType) {
                    filteredRecords = filteredRecords.filter(item => {
                        return item.record.records.some(r => r.unitType === filters.unitType);
                    });
                }
                
                // 为每个记录添加统计信息
                filteredRecords.forEach(item => {
                    const dailyStats = this.calculateDailyStats(item.date);
                    item.stats = dailyStats;
                });
                
                return filteredRecords;
            }
            
            // 计算每日统计信息
            calculateDailyStats(date) {
                const queryResult = this.queryDailyRecords(date);
                const overdueCount = queryResult.templateItems.filter(item => item.status === 'overdue').length;
                
                return {
                    totalScore: queryResult.totalScore,
                    completedTotalScore: queryResult.completedTotalScore,
                    recordCount: queryResult.records.length,
                    overdueCount: overdueCount,
                    templateItemCount: queryResult.templateItems.length
                };
            }
            
            // ==================== 数据导入导出功能 ====================
            
            // 导出数据
            exportData() {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                const exportScopes = Array.from(document.querySelectorAll('input[name="exportScope"]:checked')).map(cb => cb.value);
                
                if (exportScopes.length === 0) {
                    this.showNotification('错误', '请选择至少一个导出范围', 'error');
                    return;
                }
                
                if (format === 'json') {
                    this.exportAsJSON(exportScopes);
                } else {
                    this.exportAsCSV(exportScopes);
                }
            }
            
            // 导出为JSON格式
            exportAsJSON(exportScopes) {
                const exportData = {
                    meta: {
                        version: "1.5",
                        exportDate: new Date().toISOString(),
                        system: "周勤评分系统",
                        dataVersion: 1
                    },
                    data: {}
                };
                
                // 根据选择的范围导出数据
                if (exportScopes.includes('items')) {
                    exportData.data.items = this.data.items;
                    exportData.data.customUnitTypes = this.data.customUnitTypes;
                }
                
                if (exportScopes.includes('templates')) {
                    exportData.data.templates = this.data.templates;
                    exportData.data.currentTemplateId = this.data.currentTemplateId;
                    exportData.data.currentTemplateCopy = this.data.currentTemplateCopy;
                }
                
                if (exportScopes.includes('records')) {
                    exportData.data.dailyRecords = this.data.dailyRecords;
                    exportData.data.history = this.data.history;
                }
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const today = this.getTodayDate();
                const fileName = `周勤评分系统_备份_${today}.json`;
                
                this.downloadFile(dataStr, fileName, 'application/json');
                this.showNotification('成功', '数据导出成功', 'success');
            }
            
            // 导出为CSV格式
            exportAsCSV(exportScopes) {
                const today = this.getTodayDate();
                let csvContent = '';
                
                // 导出事项数据
                if (exportScopes.includes('items')) {
                    csvContent += "=== 事项数据 ===\n";
                    csvContent += "ID,名称,说明,单位类型,间隔天数,未完成分数,时间点/评分项\n";
                    
                    this.data.items.forEach(item => {
                        let details = '';
                        if (item.unitType === 'timePoint' && item.timePoints) {
                            details = item.timePoints.map(tp => 
                                `${tp.time}:${tp.score}分(${tp.description})`
                            ).join('; ');
                        } else if (item.unitScores) {
                            details = item.unitScores.map(us => 
                                `${us.value}${us.unit}:${us.score}分(${us.description})`
                            ).join('; ');
                        }
                        
                        csvContent += `${item.id},"${item.name}","${item.description || ''}",${item.unitType},${item.intervalDays},${item.unfinishedScore},"${details}"\n`;
                    });
                    
                    csvContent += "\n";
                }
                
                // 导出模板数据
                if (exportScopes.includes('templates')) {
                    csvContent += "=== 模板数据 ===\n";
                    csvContent += "ID,名称,包含事项ID\n";
                    
                    this.data.templates.forEach(template => {
                        const itemIds = template.itemIds.join(',');
                        csvContent += `${template.id},"${template.name}","${itemIds}"\n`;
                    });
                    
                    csvContent += `当前模板ID: ${this.data.currentTemplateId}\n`;
                    csvContent += "\n";
                }
                
                // 导出记录数据
                if (exportScopes.includes('records')) {
                    csvContent += "=== 每日记录 ===\n";
                    csvContent += "日期,事项ID,事项名称,单位类型,时间/数值,单位,分数,是否模板事项\n";
                    
                    // 导出每日记录
                    Object.values(this.data.dailyRecords).forEach(record => {
                        record.records.forEach(r => {
                            let valueField = '';
                            let unitField = '';
                            
                            if (r.unitType === 'timePoint') {
                                valueField = r.time;
                            } else {
                                valueField = r.value;
                                unitField = r.unit;
                            }
                            
                            csvContent += `${record.date},${r.itemId},"${r.itemName}",${r.unitType},"${valueField}","${unitField}",${r.score},${r.isTemplateItem ? '是' : '否'}\n`;
                        });
                    });
                    
                    csvContent += "\n=== 历史记录 ===\n";
                    csvContent += "日期,事项ID,事项名称,单位类型,时间/数值,单位,分数,是否模板事项\n";
                    
                    // 导出历史记录
                    this.data.history.forEach(record => {
                        record.records.forEach(r => {
                            let valueField = '';
                            let unitField = '';
                            
                            if (r.unitType === 'timePoint') {
                                valueField = r.time;
                            } else {
                                valueField = r.value;
                                unitField = r.unit;
                            }
                            
                            csvContent += `${record.date},${r.itemId},"${r.itemName}",${r.unitType},"${valueField}","${unitField}",${r.score},${r.isTemplateItem ? '是' : '否'}\n`;
                        });
                    });
                }
                
                const fileName = `周勤评分系统_备份_${today}.csv`;
                this.downloadFile(csvContent, fileName, 'text/csv');
                this.showNotification('成功', 'CSV数据导出成功', 'success');
            }
            
            // 导出所有备份
            exportAllBackups() {
                if (this.backups.length === 0) {
                    this.showNotification('提示', '没有备份可导出', 'info');
                    return;
                }
                
                const exportData = {
                    meta: {
                        version: "1.5",
                        exportDate: new Date().toISOString(),
                        system: "周勤评分系统",
                        type: "all_backups"
                    },
                    backups: this.backups
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const today = this.getTodayDate();
                const fileName = `周勤评分系统_所有备份_${today}.json`;
                
                this.downloadFile(dataStr, fileName, 'application/json');
                this.showNotification('成功', '所有备份导出成功', 'success');
            }
            
            // 下载文件
            downloadFile(content, fileName, mimeType) {
                // 在浏览器中，我们不能选择保存路径，只能使用默认下载路径
                // 但我们可以尝试使用新的showSaveFilePicker API（如果可用）
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: 'JSON文件',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        
                        handle.then(fileHandle => {
                            return fileHandle.createWritable();
                        }).then(writable => {
                            writable.write(content);
                            writable.close();
                            this.showNotification('成功', '数据保存成功', 'success');
                        }).catch(err => {
                            console.error('保存文件失败:', err);
                            // 如果新API失败，回退到旧方法
                            this.downloadFileLegacy(content, fileName, mimeType);
                        });
                    } catch (err) {
                        // 如果新API不可用或出错，回退到旧方法
                        this.downloadFileLegacy(content, fileName, mimeType);
                    }
                } else {
                    // 使用传统的下载方法
                    this.downloadFileLegacy(content, fileName, mimeType);
                }
            }
            
            // 传统的文件下载方法
            downloadFileLegacy(content, fileName, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 清除所有本地数据
            clearLocalData() {
                this.showConfirmDialog('清除本地数据', '确定要清除所有本地数据吗？包括事项、模板、记录和备份。此操作不可恢复！', () => {
                    // 清除所有本地存储数据
                    localStorage.removeItem('habitScoreSystem');
                    localStorage.removeItem('habitScoreSystemBackups');
                    localStorage.removeItem('lastExportReminder');
                    
                    // 重置数据
                    this.data = {
                        items: [],
                        templates: [],
                        currentTemplateId: null,
                        dailyRecords: {},
                        history: [],
                        currentTemplateCopy: [],
                        customUnitTypes: []
                    };
                    
                    this.backups = [];
                    
                    // 重新初始化示例数据
                    this.initSampleData();
                    
                    // 重新渲染所有内容
                    this.renderAll();
                    
                    this.showNotification('成功', '所有本地数据已清除，已恢复为示例数据', 'success');
                });
            }
            
            // 导入数据
            importData() {
                if (!this.importFile) {
                    this.showNotification('错误', '请先选择文件', 'error');
                    return;
                }
                
                const reader = new FileReader();
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const fileName = this.importFile.name.toLowerCase();
                        
                        let importResult;
                        
                        if (fileName.endsWith('.json')) {
                            importResult = this.importJSONData(content, importMode);
                        } else if (fileName.endsWith('.csv')) {
                            importResult = this.importCSVData(content, importMode);
                        } else {
                            this.showNotification('错误', '不支持的文件格式', 'error');
                            return;
                        }
                        
                        if (importResult.success) {
                            // 显示导入结果
                            this.showImportResults(importResult);
                            
                            // 重新渲染所有内容
                            this.renderAll();
                            
                            // 清空导入文件
                            this.clearImportFile();
                        } else {
                            this.showNotification('错误', importResult.message || '导入失败', 'error');
                        }
                    } catch (error) {
                        console.error('导入数据出错:', error);
                        this.showNotification('错误', '导入文件格式不正确', 'error');
                    }
                };
                
                reader.readAsText(this.importFile);
            }
            
            // 导入JSON数据
            importJSONData(content, importMode) {
                const importData = JSON.parse(content);
                const result = {
                    success: true,
                    message: '数据导入成功',
                    stats: {
                        itemsAdded: 0,
                        itemsUpdated: 0,
                        templatesAdded: 0,
                        templatesUpdated: 0,
                        recordsAdded: 0,
                        customUnitsAdded: 0
                    },
                    errors: []
                };
                
                // 验证数据格式
                if (!importData.data && !importData.backups) {
                    result.success = false;
                    result.message = '数据格式不正确';
                    return result;
                }
                
                // 如果是备份文件
                if (importData.backups) {
                    if (importMode === 'replace') {
                        this.backups = importData.backups;
                        this.saveBackups();
                        result.message = '备份数据导入成功';
                    } else {
                        // 合并备份
                        importData.backups.forEach(backup => {
                            const existingIndex = this.backups.findIndex(b => b.id === backup.id);
                            if (existingIndex === -1) {
                                this.backups.push(backup);
                                result.stats.recordsAdded++;
                            }
                        });
                        this.saveBackups();
                        result.message = '备份数据合并成功';
                    }
                    return result;
                }
                
                // 导入自定义单位类型
                if (importData.data.customUnitTypes) {
                    importData.data.customUnitTypes.forEach(unit => {
                        try {
                            const existingIndex = this.data.customUnitTypes.findIndex(u => u.value === unit.value);
                            
                            if (existingIndex === -1) {
                                this.data.customUnitTypes.push(unit);
                                result.stats.customUnitsAdded++;
                            } else if (importMode === 'replace') {
                                this.data.customUnitTypes[existingIndex] = unit;
                            }
                        } catch (error) {
                            result.errors.push(`导入单位类型"${unit.label}"时出错: ${error.message}`);
                        }
                    });
                }
                
                // 导入事项数据
                if (importData.data.items) {
                    importData.data.items.forEach(item => {
                        try {
                            const existingIndex = this.data.items.findIndex(i => i.id === item.id);
                            
                            if (existingIndex === -1) {
                                // 新事项
                                this.data.items.push(item);
                                result.stats.itemsAdded++;
                            } else if (importMode === 'replace') {
                                // 替换现有事项
                                this.data.items[existingIndex] = item;
                                result.stats.itemsUpdated++;
                            } else {
                                // 合并模式：保留现有，不替换
                                result.errors.push(`事项"${item.name}"已存在，跳过`);
                            }
                        } catch (error) {
                            result.errors.push(`导入事项"${item.name}"时出错: ${error.message}`);
                        }
                    });
                }
                
                // 导入模板数据
                if (importData.data.templates) {
                    importData.data.templates.forEach(template => {
                        try {
                            const existingIndex = this.data.templates.findIndex(t => t.id === template.id);
                            
                            if (existingIndex === -1) {
                                // 新模板
                                this.data.templates.push(template);
                                result.stats.templatesAdded++;
                            } else if (importMode === 'replace') {
                                // 替换现有模板
                                this.data.templates[existingIndex] = template;
                                result.stats.templatesUpdated++;
                            } else {
                                // 合并模式：保留现有，不替换
                                result.errors.push(`模板"${template.name}"已存在，跳过`);
                            }
                        } catch (error) {
                            result.errors.push(`导入模板"${template.name}"时出错: ${error.message}`);
                        }
                    });
                    
                    // 设置当前模板
                    if (importData.data.currentTemplateId) {
                        if (importMode === 'replace') {
                            this.data.currentTemplateId = importData.data.currentTemplateId;
                        } else if (!this.data.currentTemplateId) {
                            this.data.currentTemplateId = importData.data.currentTemplateId;
                        }
                    }
                    
                    // 导入模板拷贝
                    if (importData.data.currentTemplateCopy && importMode === 'replace') {
                        this.data.currentTemplateCopy = importData.data.currentTemplateCopy;
                    }
                }
                
                // 导入记录数据
                if (importData.data.dailyRecords) {
                    Object.entries(importData.data.dailyRecords).forEach(([date, record]) => {
                        try {
                            if (importMode === 'replace' || !this.data.dailyRecords[date]) {
                                this.data.dailyRecords[date] = record;
                                result.stats.recordsAdded++;
                            } else {
                                // 合并记录
                                const existingRecord = this.data.dailyRecords[date];
                                record.records.forEach(newRecord => {
                                    // 检查是否已存在相同记录
                                    const exists = existingRecord.records.some(r => 
                                        r.itemId === newRecord.itemId && 
                                        r.score === newRecord.score &&
                                        ((r.unitType === 'timePoint' && r.time === newRecord.time) ||
                                         (r.unitType !== 'timePoint' && r.value === newRecord.value))
                                    );
                                    
                                    if (!exists) {
                                        existingRecord.records.push(newRecord);
                                        existingRecord.totalScore += newRecord.score;
                                        result.stats.recordsAdded++;
                                    }
                                });
                            }
                        } catch (error) {
                            result.errors.push(`导入日期${date}的记录时出错: ${error.message}`);
                        }
                    });
                }
                
                // 导入历史记录
                if (importData.data.history) {
                    importData.data.history.forEach(record => {
                        try {
                            const existingIndex = this.data.history.findIndex(h => h.date === record.date);
                            
                            if (existingIndex === -1) {
                                this.data.history.push(record);
                                result.stats.recordsAdded++;
                            } else if (importMode === 'replace') {
                                this.data.history[existingIndex] = record;
                                result.stats.recordsAdded++;
                            } else {
                                // 合并历史记录
                                const existingRecord = this.data.history[existingIndex];
                                record.records.forEach(newRecord => {
                                    const exists = existingRecord.records.some(r => 
                                        r.itemId === newRecord.itemId && 
                                        r.score === newRecord.score &&
                                        ((r.unitType === 'timePoint' && r.time === newRecord.time) ||
                                         (r.unitType !== 'timePoint' && r.value === newRecord.value))
                                    );
                                    
                                    if (!exists) {
                                        existingRecord.records.push(newRecord);
                                        existingRecord.totalScore += newRecord.score;
                                        result.stats.recordsAdded++;
                                    }
                                });
                            }
                        } catch (error) {
                            result.errors.push(`导入历史记录${record.date}时出错: ${error.message}`);
                        }
                    });
                }
                
                // 保存数据
                if (result.stats.itemsAdded > 0 || result.stats.templatesAdded > 0 || result.stats.recordsAdded > 0) {
                    this.saveData();
                }
                
                return result;
            }
            
            // 导入CSV数据
            importCSVData(content, importMode) {
                const result = {
                    success: true,
                    message: 'CSV数据导入成功',
                    stats: {
                        itemsAdded: 0,
                        itemsUpdated: 0,
                        templatesAdded: 0,
                        templatesUpdated: 0,
                        recordsAdded: 0,
                        customUnitsAdded: 0
                    },
                    errors: []
                };
                
                const lines = content.split('\n');
                let currentSection = '';
                let isFirstLine = true;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('===')) {
                        currentSection = line.replace(/=/g, '').trim();
                        isFirstLine = true;
                        continue;
                    }
                    
                    if (!line || isFirstLine) {
                        isFirstLine = false;
                        continue;
                    }
                    
                    try {
                        if (currentSection === '事项数据') {
                            // 解析CSV行（简单解析，不处理复杂情况）
                            const parts = this.parseCSVLine(line);
                            if (parts.length >= 6) {
                                const item = {
                                    id: parseInt(parts[0]),
                                    name: parts[1],
                                    description: parts[2],
                                    unitType: parts[3],
                                    intervalDays: parseInt(parts[4]),
                                    unfinishedScore: parseInt(parts[5])
                                };
                                
                                // 解析时间点/评分项
                                if (parts.length > 6 && parts[6]) {
                                    const details = parts[6];
                                    if (item.unitType === 'timePoint') {
                                        item.timePoints = this.parseTimePoints(details);
                                    } else {
                                        item.unitScores = this.parseUnitScores(details, item.unitType);
                                    }
                                }
                                
                                const existingIndex = this.data.items.findIndex(it => it.id === item.id);
                                
                                if (existingIndex === -1) {
                                    this.data.items.push(item);
                                    result.stats.itemsAdded++;
                                } else if (importMode === 'replace') {
                                    this.data.items[existingIndex] = item;
                                    result.stats.itemsUpdated++;
                                }
                            }
                        } else if (currentSection === '模板数据') {
                            if (line.startsWith('当前模板ID:')) {
                                if (importMode === 'replace') {
                                    const templateId = parseInt(line.replace('当前模板ID:', '').trim());
                                    this.data.currentTemplateId = templateId;
                                }
                            } else {
                                const parts = this.parseCSVLine(line);
                                if (parts.length >= 3) {
                                    const template = {
                                        id: parseInt(parts[0]),
                                        name: parts[1],
                                        itemIds: parts[2] ? parts[2].split(',').map(id => parseInt(id)).filter(id => !isNaN(id)) : []
                                    };
                                    
                                    const existingIndex = this.data.templates.findIndex(t => t.id === template.id);
                                    
                                    if (existingIndex === -1) {
                                        this.data.templates.push(template);
                                        result.stats.templatesAdded++;
                                    } else if (importMode === 'replace') {
                                        this.data.templates[existingIndex] = template;
                                        result.stats.templatesUpdated++;
                                    }
                                }
                            }
                        } else if (currentSection === '每日记录' || currentSection === '历史记录') {
                            const parts = this.parseCSVLine(line);
                            if (parts.length >= 8) {
                                const record = {
                                    date: parts[0],
                                    itemId: parseInt(parts[1]),
                                    itemName: parts[2],
                                    unitType: parts[3],
                                    score: parseInt(parts[6]),
                                    isTemplateItem: parts[7] === '是'
                                };
                                
                                if (record.unitType === 'timePoint') {
                                    record.time = parts[4];
                                } else {
                                    record.value = parts[4];
                                    record.unit = parts[5];
                                }
                                
                                // 添加到对应的记录集
                                if (currentSection === '每日记录') {
                                    if (!this.data.dailyRecords[record.date]) {
                                        this.data.dailyRecords[record.date] = {
                                            date: record.date,
                                            totalScore: 0,
                                            records: [],
                                            templateId: this.data.currentTemplateId
                                        };
                                    }
                                    
                                    const existingRecord = this.data.dailyRecords[record.date];
                                    const exists = existingRecord.records.some(r => 
                                        r.itemId === record.itemId && 
                                        r.score === record.score &&
                                        ((r.unitType === 'timePoint' && r.time === record.time) ||
                                         (r.unitType !== 'timePoint' && r.value === record.value))
                                    );
                                    
                                    if (!exists) {
                                        existingRecord.records.push(record);
                                        existingRecord.totalScore += record.score;
                                        result.stats.recordsAdded++;
                                    }
                                } else {
                                    // 历史记录
                                    const existingIndex = this.data.history.findIndex(h => h.date === record.date);
                                    
                                    if (existingIndex === -1) {
                                        this.data.history.push({
                                            date: record.date,
                                            totalScore: record.score,
                                            records: [record],
                                            templateId: this.data.currentTemplateId
                                        });
                                        result.stats.recordsAdded++;
                                    } else {
                                        const existingRecord = this.data.history[existingIndex];
                                        const exists = existingRecord.records.some(r => 
                                            r.itemId === record.itemId && 
                                            r.score === record.score &&
                                            ((r.unitType === 'timePoint' && r.time === record.time) ||
                                             (r.unitType !== 'timePoint' && r.value === record.value))
                                        );
                                        
                                        if (!exists) {
                                            existingRecord.records.push(record);
                                            existingRecord.totalScore += record.score;
                                            result.stats.recordsAdded++;
                                        }
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        result.errors.push(`第${i+1}行解析错误: ${error.message}`);
                    }
                }
                
                // 保存数据
                if (result.stats.itemsAdded > 0 || result.stats.templatesAdded > 0 || result.stats.recordsAdded > 0) {
                    this.saveData();
                }
                
                return result;
            }
            
            // 解析CSV行（简单实现）
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result.map(s => s.trim());
            }
            
            // 解析时间点字符串
            parseTimePoints(details) {
                if (!details) return [];
                
                const timePoints = [];
                const parts = details.split(';');
                
                parts.forEach(part => {
                    const match = part.trim().match(/(.+):(-?\d+)分\((.+)\)/);
                    if (match) {
                        timePoints.push({
                            id: timePoints.length + 1,
                            time: match[1].trim(),
                            score: parseInt(match[2]),
                            description: match[3].trim()
                        });
                    }
                });
                
                return timePoints;
            }
            
            // 解析单位评分字符串
            parseUnitScores(details, unitType) {
                if (!details) return [];
                
                const unitScores = [];
                const parts = details.split(';');
                const unitLabel = this.getUnitLabel(unitType);
                
                parts.forEach(part => {
                    const match = part.trim().match(/(.+):(-?\d+)分\((.+)\)/);
                    if (match) {
                        unitScores.push({
                            id: unitScores.length + 1,
                            value: match[1].trim(),
                            unit: unitLabel,
                            score: parseInt(match[2]),
                            description: match[3].trim()
                        });
                    }
                });
                
                return unitScores;
            }
            
            // 显示导入结果
            showImportResults(result) {
                const content = document.getElementById('importResultsContent');
                
                let html = `
                    <div class="import-summary">
                        <div class="summary-item">
                            <div class="summary-value">${result.stats.itemsAdded}</div>
                            <div class="summary-label">新增事项</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${result.stats.templatesAdded}</div>
                            <div class="summary-label">新增模板</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${result.stats.recordsAdded}</div>
                            <div class="summary-label">新增记录</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${result.errors.length}</div>
                            <div class="summary-label">错误数量</div>
                        </div>
                    </div>
                    <h4>导入结果</h4>
                    <p>${result.message}</p>
                `;
                
                if (result.errors.length > 0) {
                    html += `
                        <h4>错误详情</h4>
                        <div class="import-details">
                            <table class="import-details-table">
                                <thead>
                                    <tr>
                                        <th>错误信息</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.errors.forEach(error => {
                        html += `
                            <tr>
                                <td class="error">${error}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                content.innerHTML = html;
                document.getElementById('importResultsModal').classList.add('active');
            }
            
            // 预览导入文件
            previewImportFile(file) {
                if (!file) return;
                
                this.importFile = file;
                this.importPreviewData = null;
                
                // 显示文件信息
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                document.getElementById('selectedFileContainer').style.display = 'block';
                document.getElementById('importDataBtn').disabled = false;
                
                // 读取文件内容进行预览
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const fileName = file.name.toLowerCase();
                        
                        if (fileName.endsWith('.json')) {
                            this.previewJSONFile(content);
                        } else if (fileName.endsWith('.csv')) {
                            this.previewCSVFile(content);
                        }
                    } catch (error) {
                        console.error('预览文件出错:', error);
                        this.showImportPreviewError('文件预览失败');
                    }
                };
                
                reader.readAsText(file);
            }
            
            // 预览JSON文件
            previewJSONFile(content) {
                try {
                    const data = JSON.parse(content);
                    this.importPreviewData = data;
                    
                    let previewHtml = `
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>数据类型</th>
                                    <th>数量</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // 检查数据格式
                    if (data.data) {
                        if (data.data.items) {
                            previewHtml += `
                                <tr>
                                    <td>事项</td>
                                    <td>${data.data.items.length}</td>
                                    <td class="success">✓ 可导入</td>
                                </tr>
                            `;
                        }
                        
                        if (data.data.templates) {
                            previewHtml += `
                                <tr>
                                    <td>模板</td>
                                    <td>${data.data.templates.length}</td>
                                    <td class="success">✓ 可导入</td>
                                </tr>
                            `;
                        }
                        
                        if (data.data.dailyRecords) {
                            const recordCount = Object.values(data.data.dailyRecords).reduce((sum, record) => sum + record.records.length, 0);
                            previewHtml += `
                                <tr>
                                    <td>每日记录</td>
                                    <td>${recordCount}</td>
                                    <td class="success">✓ 可导入</td>
                                </tr>
                            `;
                        }
                        
                        if (data.data.history) {
                            const historyCount = data.data.history.reduce((sum, record) => sum + record.records.length, 0);
                            previewHtml += `
                                <tr>
                                    <td>历史记录</td>
                                    <td>${historyCount}</td>
                                    <td class="success">✓ 可导入</td>
                                </tr>
                            `;
                        }
                        
                        if (data.data.customUnitTypes) {
                            previewHtml += `
                                <tr>
                                    <td>自定义单位类型</td>
                                    <td>${data.data.customUnitTypes.length}</td>
                                    <td class="success">✓ 可导入</td>
                                </tr>
                            `;
                        }
                    } else if (data.backups) {
                        previewHtml += `
                            <tr>
                                <td>备份数据</td>
                                <td>${data.backups.length}</td>
                                <td class="success">✓ 可导入</td>
                            </tr>
                        `;
                    } else {
                        previewHtml += `
                            <tr>
                                <td colspan="3" class="error">数据格式不正确</td>
                            </tr>
                        `;
                    }
                    
                    previewHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('importPreview').innerHTML = previewHtml;
                    document.getElementById('importPreview').classList.add('active');
                } catch (error) {
                    this.showImportPreviewError('JSON格式不正确');
                }
            }
            
            // 预览CSV文件
            previewCSVFile(content) {
                const lines = content.split('\n').slice(0, 10); // 只预览前10行
                let previewHtml = `
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>行号</th>
                                <th>内容</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                lines.forEach((line, index) => {
                    if (line.trim()) {
                        previewHtml += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${line.length > 50 ? line.substring(0, 50) + '...' : line}</td>
                            </tr>
                        `;
                    }
                });
                
                previewHtml += `
                        </tbody>
                    </table>
                    <p style="padding: 10px; font-size: 12px; color: var(--gray-color);">
                        ${lines.length >= 10 ? '显示前10行，完整文件将在导入时处理' : '文件预览'}
                    </p>
                `;
                
                document.getElementById('importPreview').innerHTML = previewHtml;
                document.getElementById('importPreview').classList.add('active');
            }
            
            // 显示导入预览错误
            showImportPreviewError(message) {
                document.getElementById('importPreview').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>${message}</p>
                    </div>
                `;
                document.getElementById('importPreview').classList.add('active');
                document.getElementById('importDataBtn').disabled = true;
            }
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 清空导入文件
            clearImportFile() {
                this.importFile = null;
                this.importPreviewData = null;
                document.getElementById('importFileInput').value = '';
                document.getElementById('selectedFileContainer').style.display = 'none';
                document.getElementById('importPreview').classList.remove('active');
                document.getElementById('importDataBtn').disabled = true;
            }
            
            // 渲染数据统计
            renderDataStats() {
                const statsContainer = document.getElementById('dataStats');
                if (!statsContainer) return;
                
                // 计算统计数据
                const itemCount = this.data.items.length;
                const templateCount = this.data.templates.length;
                const dailyRecordCount = Object.values(this.data.dailyRecords).reduce((sum, record) => sum + record.records.length, 0);
                const historyCount = this.data.history.reduce((sum, record) => sum + record.records.length, 0);
                const backupCount = this.backups.length;
                const totalScore = this.calculateDailyTotalScore();
                const completedTotalScore = this.calculateCompletedTotalScore();
                const customUnitCount = this.data.customUnitTypes.length;
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-value">${itemCount}</div>
                        <div class="stat-label">事项数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-value">${templateCount}</div>
                        <div class="stat-label">模板数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-value">${dailyRecordCount + historyCount}</div>
                        <div class="stat-label">总记录数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="stat-value">${customUnitCount}</div>
                        <div class="stat-label">自定义单位类型</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-archive"></i>
                        </div>
                        <div class="stat-value">${backupCount}</div>
                        <div class="stat-label">备份数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-value">${totalScore}</div>
                        <div class="stat-label">今日累计得分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value">${completedTotalScore}</div>
                        <div class="stat-label">今日完成记录总分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-value">${this.formatFileSize(JSON.stringify(this.data).length)}</div>
                        <div class="stat-label">数据大小</div>
                    </div>
                `;
            }
            
            // 渲染备份列表
            renderBackupList() {
                const backupList = document.getElementById('backupList');
                if (!backupList) return;
                
                if (this.backups.length === 0) {
                    backupList.innerHTML = `
                        <div class="no-backups">
                            <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 15px; color: var(--light-gray);"></i>
                            <p>暂无备份</p>
                        </div>
                    `;
                    return;
                }
                
                backupList.innerHTML = '';
                
                this.backups.forEach(backup => {
                    const li = document.createElement('li');
                    li.className = 'backup-item';
                    li.innerHTML = `
                        <div class="backup-info">
                            <div class="backup-name">${backup.name}</div>
                            <div class="backup-details">
                                <span>日期: ${backup.date}</span>
                                <span>时间: ${backup.time}</span>
                                <span>类型: ${backup.type === 'auto' ? '自动备份' : '手动备份'}</span>
                            </div>
                        </div>
                        <div class="backup-actions">
                            <button class="action-btn" data-backup-id="${backup.id}" title="恢复备份">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="action-btn delete-btn" data-backup-id="${backup.id}" title="删除备份">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    backupList.appendChild(li);
                });
                
                // 绑定备份操作事件
                backupList.querySelectorAll('.action-btn[data-backup-id]').forEach(btn => {
                    if (btn.classList.contains('delete-btn')) {
                        btn.addEventListener('click', (e) => {
                            const backupId = parseInt(e.target.closest('.action-btn').getAttribute('data-backup-id'));
                            this.deleteBackup(backupId);
                        });
                    } else {
                        btn.addEventListener('click', (e) => {
                            const backupId = parseInt(e.target.closest('.action-btn').getAttribute('data-backup-id'));
                            this.restoreBackup(backupId);
                        });
                    }
                });
            }
            
            // ==================== 原有功能继续 ====================
            
            // 绑定事件
            bindEvents() {
                // 头部按钮事件
                document.getElementById('customizeBtn').addEventListener('click', () => {
                    this.openModal('customizeModal');
                    // 切换到数据管理标签页
                    setTimeout(() => {
                        this.switchTab('dataTab');
                        this.renderDataStats();
                        this.renderBackupList();
                    }, 100);
                });
                
                document.getElementById('recordsBtn').addEventListener('click', () => {
                    this.openModal('recordsModal');
                    // 设置默认查询日期为前一天
                    document.getElementById('queryDate').value = this.getPreviousDayDate();
                    // 更新事项查询下拉框
                    this.updateQueryItemOptions();
                    // 自动查询前一天数据
                    setTimeout(() => {
                        this.searchDailyRecords();
                    }, 100);
                });
                
                document.getElementById('helpBtn').addEventListener('click', () => {
                    this.openModal('helpModal');
                });
                
                // 关闭按钮事件
                document.getElementById('closeCustomizeModal').addEventListener('click', () => {
                    this.closeModal('customizeModal');
                });
                
                document.getElementById('closeRecordsModal').addEventListener('click', () => {
                    this.closeModal('recordsModal');
                });
                
                document.getElementById('closeHelpModal').addEventListener('click', () => {
                    this.closeModal('helpModal');
                });
                
                document.getElementById('closeAddItemModal').addEventListener('click', () => {
                    this.closeModal('addItemModal');
                    this.editingItemId = null;
                });
                
                document.getElementById('closeTemplateModal').addEventListener('click', () => {
                    this.closeModal('templateModal');
                    this.editingTemplateId = null;
                });
                
                document.getElementById('closeSelectTemplateModal').addEventListener('click', () => {
                    this.closeModal('selectTemplateModal');
                });
                
                document.getElementById('closeEditTimePointModal').addEventListener('click', () => {
                    this.closeModal('editTimePointModal');
                    this.editingTimePoint = {
                        itemId: null,
                        timePointIndex: null,
                        tempId: null
                    };
                });
                
                document.getElementById('closeImportResultsModal').addEventListener('click', () => {
                    this.closeModal('importResultsModal');
                });
                
                document.getElementById('closeImportResultsBtn').addEventListener('click', () => {
                    this.closeModal('importResultsModal');
                });
                
                document.getElementById('closeAddUnitTypeModal').addEventListener('click', () => {
                    this.closeModal('addUnitTypeModal');
                });
                
                document.getElementById('closeRecordDetailsModal').addEventListener('click', () => {
                    this.closeModal('recordDetailsModal');
                });
                
                // 重复记录确认对话框按钮
                document.getElementById('duplicateRecordCancel').addEventListener('click', () => {
                    this.hideDuplicateRecordDialog();
                });
                
                document.getElementById('duplicateRecordConfirm').addEventListener('click', () => {
                    if (this.duplicateRecordCallback && this.pendingRecordData) {
                        const { itemId, scoreId, isTimePoint } = this.pendingRecordData;
                        this.duplicateRecordCallback(itemId, scoreId, isTimePoint);
                    }
                    this.hideDuplicateRecordDialog();
                });
                
                // 点击遮罩层关闭弹框 - 修改为需要鼠标按下和抬起都在弹框外
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('mousedown', (e) => {
                        if (e.target === overlay) {
                            this.modalClickStartOutside = true;
                        } else {
                            this.modalClickStartOutside = false;
                        }
                    });
                    
                    overlay.addEventListener('mouseup', (e) => {
                        if (e.target === overlay && this.modalClickStartOutside) {
                            overlay.classList.remove('active');
                            this.editingItemId = null;
                            this.editingTemplateId = null;
                            this.editingTimePoint = {
                                itemId: null,
                                timePointIndex: null,
                                tempId: null
                            };
                        }
                        this.modalClickStartOutside = false;
                    });
                });
                
                // 标签切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tabId = e.target.getAttribute('data-tab');
                        this.switchTab(tabId);
                        
                        // 如果是周度报告标签，自动生成报告
                        if (tabId === 'weeklyReportTab') {
                            setTimeout(() => {
                                this.generateWeeklyReportFromForm();
                            }, 100);
                        }
                        
                        // 如果是月度报告标签，自动生成报告
                        if (tabId === 'monthlyReportTab') {
                            setTimeout(() => {
                                this.generateMonthlyReportFromForm();
                            }, 100);
                        }
                        
                        // 如果是所有记录标签，更新选项
                        if (tabId === 'allRecordsTab') {
                            setTimeout(() => {
                                this.updateAllRecordsOptions();
                                this.searchAllRecords();
                            }, 100);
                        }
                        
                        // 如果是数据管理标签，更新统计和备份列表
                        if (tabId === 'dataTab') {
                            setTimeout(() => {
                                this.renderDataStats();
                                this.renderBackupList();
                            }, 100);
                        }
                    });
                });
                
// 添加事项按钮
const addItemBtn = document.getElementById('addItemBtn');
if (addItemBtn) {
    addItemBtn.addEventListener('click', () => {
        console.log('点击添加事项按钮');
        this.openAddItemModal();
    });
} else {
    console.error('未找到添加事项按钮');
}
                
                // 添加自定义单位类型按钮
                document.getElementById('addCustomUnitTypeBtn').addEventListener('click', () => {
                    this.openAddUnitTypeModal();
                });
                
                // 保存单位类型按钮
                document.getElementById('saveUnitTypeBtn').addEventListener('click', () => {
                    this.saveUnitTypeFromForm();
                });
                
                // 单位类型改变事件
                document.getElementById('itemUnitType').addEventListener('change', () => {
                    this.toggleUnitTypeSection();
                });
                
                // 添加时间点按钮
                document.getElementById('addTimePointBtn').addEventListener('click', () => {
                    this.addTimePointToForm();
                });
                
                // 添加单位评分按钮
                document.getElementById('addUnitScoreBtn').addEventListener('click', () => {
                    this.addUnitScoreToForm();
                });
                
                // 保存事项按钮
                document.getElementById('saveItemBtn').addEventListener('click', () => {
                    this.saveItemFromForm();
                });
                
                // 添加模板按钮
                document.getElementById('addTemplateBtn').addEventListener('click', () => {
                    this.openTemplateModal();
                });
                
                // 修改模板按钮
                document.getElementById('changeTemplateBtn').addEventListener('click', () => {
                    this.openSelectTemplateModal();
                });
                
                // 保存模板按钮
                document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                    this.saveTemplateFromForm();
                });
                
                // 确认模板选择
                document.getElementById('confirmTemplateBtn').addEventListener('click', () => {
                    this.confirmTemplateSelection();
                });
                
                // 保存记录按钮
                document.getElementById('saveRecordBtn').addEventListener('click', () => {
                    this.saveRecordFromForm();
                });
                
                // 搜索记录按钮
                document.getElementById('searchRecordsBtn').addEventListener('click', () => {
                    this.searchDailyRecords();
                });
                
                // 生成周度报告按钮
                document.getElementById('generateReportBtn').addEventListener('click', () => {
                    this.generateWeeklyReportFromForm();
                });
                
                // 生成月度报告按钮
                document.getElementById('generateMonthlyReportBtn').addEventListener('click', () => {
                    this.generateMonthlyReportFromForm();
                });
                
                // 搜索所有记录按钮
                document.getElementById('searchAllRecordsBtn').addEventListener('click', () => {
                    this.searchAllRecords();
                });
                
                // 保存时间点按钮
                document.getElementById('saveTimePointBtn').addEventListener('click', () => {
                    this.saveTimePointFromForm();
                });
                
                // 事项选择改变事件
                document.getElementById('itemSelect').addEventListener('change', () => {
                    this.updateCurrentScore();
                    this.updateScoreOptions();
                });
                
                // 时间点选择改变事件
                document.getElementById('timeSelect').addEventListener('change', () => {
                    this.updateCurrentScore();
                });
                
                // 事项来源改变事件
                document.getElementById('itemSource').addEventListener('change', () => {
                    this.updateItemOptions();
                });
                
                // 清空按钮事件
                document.querySelectorAll('.clear-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // 防止事件冒泡
                        const targetId = e.target.closest('.clear-btn').getAttribute('data-target');
                        this.clearInput(targetId);
                    });
                });
                
                // 通知关闭按钮
                document.getElementById('notificationClose').addEventListener('click', () => {
                    this.hideNotification();
                });
                
                // 确认对话框按钮
                document.getElementById('confirmCancel').addEventListener('click', () => {
                    this.hideConfirmDialog();
                });
                
                document.getElementById('confirmOk').addEventListener('click', () => {
                    if (this.confirmCallback) {
                        this.confirmCallback();
                    }
                    this.hideConfirmDialog();
                });
                
                // 添加事项到模板按钮
                document.getElementById('addItemToTemplateBtn').addEventListener('click', () => {
                    this.addItemToTemplateForm();
                });
                
                // 数据管理相关事件
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    this.exportData();
                });
                
                document.getElementById('exportAllBackupsBtn').addEventListener('click', () => {
                    this.exportAllBackups();
                });
                
                document.getElementById('importDataBtn').addEventListener('click', () => {
                    this.importData();
                });
                
                document.getElementById('clearImportBtn').addEventListener('click', () => {
                    this.clearImportFile();
                });
                
                document.getElementById('createBackupBtn').addEventListener('click', () => {
                    this.createManualBackup();
                });
                
                document.getElementById('clearBackupsBtn').addEventListener('click', () => {
                    this.clearAllBackups();
                });
                
                document.getElementById('clearLocalDataBtn').addEventListener('click', () => {
                    this.clearLocalData();
                });
                
                // 文件上传事件
                const fileInput = document.getElementById('importFileInput');
                const fileUploadArea = document.getElementById('fileUploadArea');
                
                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.previewImportFile(e.target.files[0]);
                    }
                });
                
                // 拖拽上传事件
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('drag-over');
                });
                
                fileUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('drag-over');
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('drag-over');
                    
                    if (e.dataTransfer.files.length > 0) {
                        this.previewImportFile(e.dataTransfer.files[0]);
                    }
                });
                
                document.getElementById('removeFileBtn').addEventListener('click', () => {
                    this.clearImportFile();
                });
                
                // 初始化小时选择器
                this.initHourSelectors();
                
                // 设置今天日期
                document.getElementById('queryDate').value = this.getTodayDate();
                
                // 设置本周
                this.setCurrentWeek();
                
                // 设置本月
                this.setCurrentMonth();

// 分数选择框和输入框的同步
const scoreSelects = document.querySelectorAll('.score-select');
scoreSelects.forEach(select => {
    select.addEventListener('change', (e) => {
        const input = e.target.closest('.score-input-container').querySelector('.score-input');
        if (input && e.target.value) {
            input.value = e.target.value;
        }
    });
});

const scoreInputs = document.querySelectorAll('.score-input');
scoreInputs.forEach(input => {
    input.addEventListener('input', (e) => {
        const select = e.target.closest('.score-input-container').querySelector('.score-select');
        if (select) {
            select.value = '';
        }
    });
});
            }
            
            // 设置当前周
            setCurrentWeek() {
                const today = new Date();
                const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                const year = firstDayOfWeek.getFullYear();
                const weekNumber = this.getWeekNumber(firstDayOfWeek);
                document.getElementById('reportWeek').value = `${year}-W${String(weekNumber).padStart(2, '0')}`;
            }
            
            // 设置当前月
            setCurrentMonth() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('reportMonth').value = `${year}-${month}`;
            }
            
            // 获取周数
            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }
            
            // 初始化小时选择器
// 初始化小时选择器
initHourSelectors() {
    // 只在添加事项模态框打开时初始化
    const addItemModal = document.getElementById('addItemModal');
    if (!addItemModal || !addItemModal.classList.contains('active')) {
        return;
    }
    
    // 确保小时选择器元素存在
    const hourSelectors = addItemModal.querySelectorAll('.time-hour');
    if (!hourSelectors || hourSelectors.length === 0) {
        return;
    }
    
    hourSelectors.forEach(select => {
        // 检查是否已初始化
        if (select.querySelectorAll('option').length <= 1) {
            // 清空现有选项
            select.innerHTML = '<option value="">时</option>';
            
            // 添加小时选项
            for (let hour = 0; hour < 24; hour++) {
                const hourStr = hour < 10 ? '0' + hour : hour.toString();
                const option = document.createElement('option');
                option.value = hourStr;
                option.textContent = hourStr;
                select.appendChild(option);
            }
        }
    });
}
            
            // 渲染所有内容
            renderAll() {
                this.renderTemplateList();
                this.renderDailyRecords();
                this.renderItemsList();
                this.renderTemplatesCards();
                this.updateItemOptions();
                this.updateCurrentTemplateName();
                this.updateCurrentTemplateDisplay();
                
                // 更新当日累计得分和完成记录总分
                this.updateDailyTotalScore();
                
                // 更新数据统计（如果数据管理标签页是活动的）
                if (document.getElementById('dataTab').classList.contains('active')) {
                    this.renderDataStats();
                    this.renderBackupList();
                }
            }
            
            // 更新当日累计得分和完成记录总分
            updateDailyTotalScore() {
                const totalScore = this.calculateDailyTotalScore();
                const completedTotalScore = this.calculateCompletedTotalScore();
                
                document.getElementById('dailyTotal').textContent = totalScore;
                document.getElementById('completedTotalScore').textContent = completedTotalScore;
            }
            
            // 更新当前模板显示
            updateCurrentTemplateDisplay() {
                const currentTemplate = this.getCurrentTemplate();
                if (currentTemplate) {
                    document.getElementById('currentTemplateDisplay').textContent = currentTemplate.name;
                } else {
                    document.getElementById('currentTemplateDisplay').textContent = '无';
                }
            }
            
            // 渲染模板事项列表（使用模板拷贝）
            renderTemplateList() {
                const templateList = document.getElementById('templateList');
                templateList.innerHTML = '';
                
                const currentTemplate = this.getCurrentTemplate();
                if (!currentTemplate || this.data.currentTemplateCopy.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'template-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">暂无模板</div>
                            <div class="item-details">请先在自定义功能中添加模板</div>
                        </div>
                    `;
                    templateList.appendChild(li);
                    return;
                }
                
                this.data.currentTemplateCopy.forEach(copyItem => {
                    const item = this.getItem(copyItem.itemId);
                    if (!item) return;
                    
                    let className = 'template-item';
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (copyItem.status) {
                        case 'completed':
                            className += ' completed';
                            statusText = '已完成';
                            statusClass = 'positive';
                            break;
                        case 'notDue':
                            className += ' completed';
                            statusText = '未到期';
                            statusClass = 'positive';
                            break;
                        case 'overdue':
                            className += ' overdue';
                            statusText = '未完成';
                            statusClass = 'negative';
                            break;
                    }
                    
                    const li = document.createElement('li');
                    li.className = className;
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                <span>间隔: ${item.intervalDays}天</span>
                                <span>未完成: ${item.unfinishedScore}分</span>
                            </div>
                        </div>
                        <div class="item-score ${statusClass}">
                            ${statusText}
                            ${copyItem.completionDate ? `<div class="completion-date">${copyItem.completionDate}</div>` : ''}
                        </div>
                    `;
                    templateList.appendChild(li);
                });
            }
            
            // 渲染当日记录
            renderDailyRecords() {
                const recordsList = document.getElementById('dailyRecordsList');
                recordsList.innerHTML = '';
                
                const todayRecord = this.getTodayRecord();
                
                if (!todayRecord.records || todayRecord.records.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">暂无记录</div>
                            <div class="item-details">今日尚未添加任何记录</div>
                        </div>
                    `;
                    recordsList.appendChild(li);
                    return;
                }
                
                // 更新当日累计得分和完成记录总分
                this.updateDailyTotalScore();
                
                todayRecord.records.forEach((record, index) => {
                    const li = document.createElement('li');
                    li.className = `record-item ${record.isTemplateItem ? 'template' : 'non-template'}`;
                    
                    let detailsHtml = '';
                    if (record.unitType === 'timePoint') {
                        detailsHtml = `<span>时间: ${record.time}</span>`;
                    } else {
                        detailsHtml = `<span>${record.value}${record.unit}</span>`;
                    }
                    detailsHtml += `<span>${record.isTemplateItem ? '模板内事项' : '额外事项'}</span>`;
                    
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${record.itemName}</div>
                            <div class="item-details">
                                ${detailsHtml}
                            </div>
                        </div>
                        <div class="item-score ${record.score >= 0 ? 'positive' : 'negative'}">
                            ${record.score >= 0 ? '+' : ''}${record.score}
                        </div>
                        <div class="item-actions">
                            <button class="small-delete-btn" data-index="${index}" title="删除记录">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    recordsList.appendChild(li);
                });
                
                // 绑定删除按钮事件
                recordsList.querySelectorAll('.small-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('.small-delete-btn').getAttribute('data-index'));
                        this.deleteTodayRecord(index);
                    });
                });
            }
            
            // 删除当日记录
            deleteTodayRecord(index) {
                this.showConfirmDialog('确认删除', '确定要删除这条记录吗？', () => {
                    const today = this.getTodayDate();
                    if (this.deleteRecord(today, index)) {
                        this.showNotification('成功', '记录删除成功', 'success');
                        this.renderDailyRecords();
                        this.renderTemplateList();
                        this.updateDailyTotalScore();
                    } else {
                        this.showNotification('错误', '删除记录失败', 'error');
                    }
                });
            }
            
            // 渲染事项列表
            renderItemsList() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (this.data.items.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'item-card';
                    li.innerHTML = `
                        <div class="item-header">
                            <div class="item-info">
                                <div class="item-name">暂无事项</div>
                                <div class="item-details">请点击"添加事项"按钮创建新事项</div>
                            </div>
                        </div>
                    `;
                    itemsList.appendChild(li);
                    return;
                }
                
                this.data.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'item-card';
                    li.innerHTML = `
                        <div class="item-header" onclick="habitSystem.toggleItemContent(this)">
                            <div class="item-header-title">
                                <span class="item-index">${index + 1}</span>
                                <div class="item-main-info">
                                    <div class="item-name-container">${item.name}</div>
                                    <div class="item-stats">
                                        <div class="item-stat">
                                            <i class="fas fa-calendar-day"></i>
                                            <span>间隔: ${item.intervalDays}天</span>
                                        </div>
                                        <div class="item-stat">
                                            <i class="fas fa-minus-circle"></i>
                                            <span>未完成: ${item.unfinishedScore}分</span>
                                        </div>
                                        <div class="item-stat">
                                            <i class="fas fa-ruler"></i>
                                            <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                        </div>
                                    </div>
                                </div>
                                <span class="item-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-id="${item.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="action-btn delete-btn" data-id="${item.id}">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="item-content">
                            <div class="item-details">
                                <p><strong>事项说明:</strong> ${item.description || '无'}</p>
                            </div>
                            <h4>${item.unitType === 'timePoint' ? '时间点及分数:' : '评分项:'}</h4>
                            <ul class="sub-items-list">
                                ${item.unitType === 'timePoint' ? 
                                    (item.timePoints ? item.timePoints.map((tp, tpIndex) => `
                                        <li class="sub-item">
                                            <div class="sub-item-info">
                                                <div class="sub-item-time">${tp.time}</div>
                                                <div class="sub-item-score ${tp.score >= 0 ? 'positive' : 'negative'}">${tp.score >= 0 ? '+' : ''}${tp.score}</div>
                                                <div class="sub-item-description">${tp.description}</div>
                                            </div>
                                            <div class="sub-item-actions">
                                                <button class="action-btn delete-btn" data-item-id="${item.id}" data-tp-index="${tpIndex}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('') : '<li>暂无时间点</li>') : 
                                    (item.unitScores ? item.unitScores.map((us, usIndex) => `
                                        <li class="sub-item">
                                            <div class="sub-item-info">
                                                <div class="sub-item-time">${us.value}${us.unit}</div>
                                                <div class="sub-item-score ${us.score >= 0 ? 'positive' : 'negative'}">${us.score >= 0 ? '+' : ''}${us.score}</div>
                                                <div class="sub-item-description">${us.description}</div>
                                            </div>
                                            <div class="sub-item-actions">
                                                <button class="action-btn delete-btn" data-item-id="${item.id}" data-us-index="${usIndex}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('') : '<li>暂无评分项</li>')
                                }
                            </ul>
                        </div>
                    `;
                    itemsList.appendChild(li);
                });
                
                // 绑定事件
                itemsList.querySelectorAll('.edit-btn[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.edit-btn').getAttribute('data-id'));
                        this.editItem(itemId);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-id'));
                        this.deleteItemConfirm(itemId);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-item-id][data-tp-index]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-item-id'));
                        const tpIndex = parseInt(e.target.closest('.delete-btn').getAttribute('data-tp-index'));
                        this.deleteTimePointConfirm(itemId, tpIndex);
                    });
                });
                
                itemsList.querySelectorAll('.delete-btn[data-item-id][data-us-index]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemId = parseInt(e.target.closest('.delete-btn').getAttribute('data-item-id'));
                        const usIndex = parseInt(e.target.closest('.delete-btn').getAttribute('data-us-index'));
                        this.deleteUnitScoreConfirm(itemId, usIndex);
                    });
                });

// 在创建事项卡片后添加事件绑定
const itemCard = document.createElement('li');
itemCard.className = 'item-card';
itemCard.innerHTML = `
    <div class="item-header">
        <!-- 事项标题内容 -->
    </div>
    <div class="item-content">
        <!-- 事项内容 -->
    </div>
`;

// 添加到列表后绑定事件
itemsList.appendChild(itemCard);

// 绑定展开/收起事件
const header = itemCard.querySelector('.item-header');
const content = itemCard.querySelector('.item-content');
const toggle = itemCard.querySelector('.item-toggle');

if (header && content) {
    header.addEventListener('click', (e) => {
        // 如果点击的是操作按钮，不触发展开/收起
        if (e.target.closest('.action-btn')) {
            return;
        }
        content.classList.toggle('open');
        header.classList.toggle('open');
    });
}
            }
            
            // 渲染模板卡片
            renderTemplatesCards() {
                const templatesContainer = document.getElementById('templatesContainer');
                templatesContainer.innerHTML = '';
                
                if (this.data.templates.length === 0) {
                    templatesContainer.innerHTML = `
                        <div style="text-align: center; padding: 25px; color: var(--gray-color);">
                            暂无模板，请点击"添加模板"按钮创建
                        </div>
                    `;
                    return;
                }
                
                this.data.templates.forEach((template, index) => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card';
                    
                    // 计算平均间隔天数和包含事项数
                    let avgInterval = 0;
                    let itemsCount = 0;
                    if (template.itemIds.length > 0) {
                        let totalInterval = 0;
                        template.itemIds.forEach(itemId => {
                            const item = this.getItem(itemId);
                            if (item) {
                                totalInterval += item.intervalDays;
                                itemsCount++;
                            }
                        });
                        avgInterval = itemsCount > 0 ? Math.round(totalInterval / itemsCount) : 0;
                    }
                    
                    templateCard.innerHTML = `
                        <div class="template-card-header" onclick="habitSystem.toggleTemplateCard(this)">
                            <div class="template-card-title">
                                <span class="template-card-index">${index + 1}</span>
                                <div class="template-main-info">
                                    <div class="template-name-container">${template.name}</div>
                                    <div class="template-stats">
                                        <div class="template-stat">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>平均间隔: ${avgInterval}天</span>
                                        </div>
                                        <div class="template-stat">
                                            <i class="fas fa-list-ol"></i>
                                            <span>包含: ${itemsCount}项</span>
                                        </div>
                                    </div>
                                </div>
                                ${template.id === this.data.currentTemplateId ? '<span style="color: green; font-weight: 600; margin-left: 10px;">(使用中)</span>' : ''}
                                <span class="template-card-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-template-id="${template.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" data-template-id="${template.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${template.id !== this.data.currentTemplateId ? `
                                    <button class="action-btn" style="background-color: var(--primary-color); color: white;" data-template-id="${template.id}" data-action="use">
                                        使用
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="template-card-content">
                            <div class="template-items-list">
                                ${template.itemIds.map(itemId => {
                                    const item = this.getItem(itemId);
                                    if (!item) return '';
                                    return `
                                        <div class="template-item-detail">
                                            <span>${item.name}</span>
                                            <span>间隔: ${item.intervalDays}天</span>
                                            <span>类型: ${this.getUnitLabel(item.unitType)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    templatesContainer.appendChild(templateCard);
                });
                
                // 绑定事件
                templatesContainer.querySelectorAll('.edit-btn[data-template-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = parseInt(e.target.closest('.edit-btn').getAttribute('data-template-id'));
                        this.editTemplate(templateId);
                    });
                });
                
                templatesContainer.querySelectorAll('.delete-btn[data-template-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = parseInt(e.target.closest('.delete-btn').getAttribute('data-template-id'));
                        this.deleteTemplateConfirm(templateId);
                    });
                });
                
                templatesContainer.querySelectorAll('.action-btn[data-action="use"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const templateId = parseInt(e.target.closest('.action-btn').getAttribute('data-template-id'));
                        this.setCurrentTemplate(templateId);
                        this.renderAll();
                        this.showNotification('成功', `已切换到模板"${this.getCurrentTemplate().name}"`, 'success');
                    });
                });
                
// 在创建模板卡片后添加事件绑定
const templateCard = document.createElement('div');
templateCard.className = 'template-card';
templateCard.innerHTML = `
    <div class="template-card-header">
        <!-- 模板标题内容 -->
    </div>
    <div class="template-card-content">
        <!-- 模板内容 -->
    </div>
`;

// 添加到容器后绑定事件
templatesContainer.appendChild(templateCard);

// 绑定展开/收起事件
const header = templateCard.querySelector('.template-card-header');
const content = templateCard.querySelector('.template-card-content');
const toggle = templateCard.querySelector('.template-card-toggle');

if (header && content) {
    header.addEventListener('click', (e) => {
        // 如果点击的是操作按钮，不触发展开/收起
        if (e.target.closest('.action-btn')) {
            return;
        }
        content.classList.toggle('open');
        header.classList.toggle('open');
    });
}
            }
            
            // 更新事项选项
            updateItemOptions() {
                const source = document.getElementById('itemSource').value;
                const items = this.getItemsBySource(source);
                const itemSelect = document.getElementById('itemSelect');
                
                itemSelect.innerHTML = '<option value="">请选择事项</option>';
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    itemSelect.appendChild(option);
                });
                
                // 更新当前得分
                this.updateCurrentScore();
                // 更新分数选项
                this.updateScoreOptions();
            }
            
            // 更新分数选项
            updateScoreOptions() {
                const itemId = document.getElementById('itemSelect').value;
                const timeSelect = document.getElementById('timeSelect');
                
                if (!itemId) {
                    timeSelect.innerHTML = '<option value="">请先选择事项</option>';
                    return;
                }
                
                const item = this.getItem(parseInt(itemId));
                if (!item) return;
                
                timeSelect.innerHTML = '<option value="">请选择</option>';
                
                if (item.unitType === 'timePoint') {
                    // 时间点类型
                    const timeOptions = this.getTimeOptions(parseInt(itemId));
                    timeOptions.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        timeSelect.appendChild(opt);
                    });
                } else {
                    // 单位类型
                    const unitOptions = this.getUnitScoreOptions(parseInt(itemId));
                    unitOptions.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        timeSelect.appendChild(opt);
                    });
                }
            }
            
            // 更新当前得分
            updateCurrentScore() {
                const itemId = document.getElementById('itemSelect').value;
                const scoreId = document.getElementById('timeSelect').value;
                
                if (!itemId || !scoreId) {
                    document.getElementById('currentScore').textContent = '0';
                    return;
                }
                
                const item = this.getItem(parseInt(itemId));
                if (!item) return;
                
                let score = 0;
                if (item.unitType === 'timePoint') {
                    score = this.getTimePointScore(parseInt(scoreId));
                } else {
                    score = this.getUnitScoreScore(parseInt(scoreId));
                }
                
                document.getElementById('currentScore').textContent = score >= 0 ? `+${score}` : score;
            }
            
// 打开添加事项模态框
openAddItemModal() {
    console.log('开始打开添加事项模态框');
    
    this.editingItemId = null;
    
    // 确保模态框存在
    const modal = document.getElementById('addItemModal');
    if (!modal) {
        console.error('未找到添加事项模态框');
        return;
    }
    
    // 打开模态框
    modal.classList.add('active');
    console.log('模态框已打开');
    
    // 更新标题
    const titleElement = document.getElementById('addItemModalTitle');
    if (titleElement) {
        titleElement.textContent = '添加事项';
    }
    
    // 使用延迟确保DOM更新
    setTimeout(() => {
        console.log('开始重置表单');
        this.resetItemForm();
        console.log('切换单位类型部分');
        this.toggleUnitTypeSection();
        console.log('初始化小时选择器');
        this.initHourSelectors();
    }, 50);
}
            
            // 加载事项到表单
            loadItemToForm(itemId) {
                const item = this.getItem(itemId);
                if (!item) return;
                
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('intervalDays').value = item.intervalDays;
                document.getElementById('unfinishedScore').value = item.unfinishedScore;
                
                // 更新单位类型选项
                this.updateUnitTypeOptions();
                document.getElementById('itemUnitType').value = item.unitType;
                
                // 切换单位类型部分
                this.toggleUnitTypeSection();
                
                // 清空现有时间点/评分项
                document.getElementById('timePointsList').innerHTML = '';
                document.getElementById('unitScoresList').innerHTML = '';
                
                if (item.unitType === 'timePoint' && item.timePoints) {
                    item.timePoints.forEach(tp => {
                        this.addTimePointToDisplay(tp.time, tp.score, tp.description, tp.id);
                    });
                } else if (item.unitScores) {
                    item.unitScores.forEach(us => {
                        this.addUnitScoreToDisplay(us.value, us.score, us.description, us.id);
                    });
                }
            }
            
// 重置事项表单
resetItemForm() {
    // 首先确保模态框已经打开并可见
    const modal = document.getElementById('addItemModal');
    if (!modal || !modal.classList.contains('active')) {
        console.log('添加事项模态框未打开，跳过重置表单');
        return;
    }
    
// 修改 safeSetValue 函数使用模态框上下文
const safeSetValue = (selector, value) => {
    const element = modal.querySelector(selector);
    if (element) {
        element.value = value;
        console.log(`已设置 ${selector} 的值为: ${value}`);
    } else {
        console.warn(`未找到元素: ${selector}`);
    }
};

// 使用示例
safeSetValue('#itemName', '');
safeSetValue('#itemUnitType', 'timePoint');
    
    const safeClearTextarea = (id) => {
        const element = modal.querySelector(`#${id}`);
        if (element) {
            element.value = '';
        }
    };
    
    const safeClearElement = (id) => {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = '';
        }
    };
    
    // 重置输入框
    safeSetValue('itemName', '');
    safeSetValue('itemUnitType', 'timePoint');
    safeSetValue('intervalDays', '0');
    safeSetValue('unfinishedScore', '-1');
    safeClearTextarea('itemDescription');
    
    // 重置时间点部分
    const timeSection = modal.querySelector('#timePointSection');
    if (timeSection) {
        safeSetValue('timeScore', '');
        safeSetValue('timeScoreInput', '');
        safeClearTextarea('timeDescription');
        
        // 清空时间选择器
        const hourSelects = timeSection.querySelectorAll('.time-hour');
        hourSelects.forEach(select => {
            if (select) select.value = '';
        });
        
        const minuteSelects = timeSection.querySelectorAll('.time-minute');
        minuteSelects.forEach(select => {
            if (select) select.value = '';
        });
    }
    
    // 重置单位评分部分
    const unitSection = modal.querySelector('#unitScoreSection');
    if (unitSection) {
        safeSetValue('unitValue1', '');
        safeSetValue('unitValue2', '');
        safeSetValue('unitScore', '');
        safeSetValue('unitScoreInput', '');
        safeClearTextarea('unitDescription');
    }
    
    // 清空已添加的时间点和评分项
    safeClearElement('timePointsList');
    safeClearElement('unitScoresList');
}
            
            // 更新单位类型选项
            updateUnitTypeOptions() {
                const unitTypeSelect = document.getElementById('itemUnitType');
                
                // 保存当前选中的值
                const currentValue = unitTypeSelect.value;
                
                // 清空选项
                unitTypeSelect.innerHTML = '';
                
                // 添加内置单位类型
                this.builtInUnitTypes.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.label;
                    unitTypeSelect.appendChild(option);
                });
                
                // 添加自定义单位类型
                this.data.customUnitTypes.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.label + ' (自定义)';
                    unitTypeSelect.appendChild(option);
                });
                
                // 恢复选中的值（如果存在）
                if (currentValue && Array.from(unitTypeSelect.options).some(opt => opt.value === currentValue)) {
                    unitTypeSelect.value = currentValue;
                }
            }
            
            // 切换单位类型部分
            toggleUnitTypeSection() {
                const unitType = document.getElementById('itemUnitType').value;
                const timePointSection = document.getElementById('timePointSection');
                const unitScoreSection = document.getElementById('unitScoreSection');
                const unitScoreTitle = document.getElementById('unitScoreTitle');
                const unitLabel = document.getElementById('unitLabel');
                
                if (unitType === 'timePoint') {
                    timePointSection.style.display = 'block';
                    unitScoreSection.style.display = 'none';
                } else {
                    timePointSection.style.display = 'none';
                    unitScoreSection.style.display = 'block';
                    
                    // 更新单位标签
                    const unitText = this.getUnitLabel(unitType);
                    unitScoreTitle.textContent = unitText + '评分';
                    unitLabel.textContent = unitText;
                }
            }
            
            // 添加时间点到表单
            addTimePointToForm() {
                const hour0 = document.querySelector('.time-hour[data-index="0"]').value;
                const minute0 = document.querySelector('.time-minute[data-index="0"]').value;
                
                if (!hour0 || !minute0) {
                    this.showNotification('错误', '请填写开始时间', 'error');
                    return;
                }
                
                const timeStr = `${hour0}:${minute0}`;
                
                // 检查结束时间是否填写
                const hour1 = document.querySelector('.time-hour[data-index="1"]').value;
                const minute1 = document.querySelector('.time-minute[data-index="1"]').value;
                
                let fullTimeStr = timeStr;
                if (hour1 && minute1) {
                    fullTimeStr += `-${hour1}:${minute1}`;
                }
                
                // 获取分数
                const scoreSelect = document.getElementById('timeScore');
                const scoreInput = document.getElementById('timeScoreInput');
                let score = 0;
                
                if (scoreSelect.value) {
                    score = parseInt(scoreSelect.value);
                } else if (scoreInput.value) {
                    score = parseInt(scoreInput.value);
                    // 验证是否为整数
                    if (!Number.isInteger(score)) {
                        this.showNotification('错误', '分数必须是整数', 'error');
                        return;
                    }
                } else {
                    this.showNotification('错误', '请填写分数', 'error');
                    return;
                }
                
                const description = document.getElementById('timeDescription').value || '';
                
                // 添加到显示列表
                this.addTimePointToDisplay(fullTimeStr, score, description);
                
                // 清空表单
                document.querySelector('.time-hour[data-index="0"]').value = '';
                document.querySelector('.time-minute[data-index="0"]').value = '00';
                document.querySelector('.time-hour[data-index="1"]').value = '';
                document.querySelector('.time-minute[data-index="1"]').value = '00';
                scoreSelect.value = '';
                scoreInput.value = '';
                document.getElementById('timeDescription').value = '';
                
            }
            
// 添加单位评分到表单
addUnitScoreToForm() {
    const value1 = document.getElementById('unitValue1').value;
    const value2 = document.getElementById('unitValue2').value;
    const scoreSelect = document.getElementById('unitScore');
    const scoreInput = document.getElementById('unitScoreInput');
    const description = document.getElementById('unitDescription').value;
    
    // 验证最小值
    if (!value1) {
        this.showNotification('错误', '请输入最小值', 'error');
        return;
    }
    
    // 获取分数值（优先使用手动输入的值）
    let score = scoreInput.value ? parseInt(scoreInput.value) : null;
    if (score === null && scoreSelect.value) {
        score = parseInt(scoreSelect.value);
    }
    
    if (score === null || isNaN(score)) {
        this.showNotification('错误', '请选择或输入分数', 'error');
        return;
    }
    
    const unitLabel = document.getElementById('unitLabel').textContent;
    const valueDisplay = value2 ? `${value1}~${value2}` : value1;
    
    // 创建临时ID
    const tempId = Date.now();
    
    // 添加评分项到列表
    const unitScoresList = document.getElementById('unitScoresList');
    const div = document.createElement('div');
    div.className = 'time-point-item';
    div.setAttribute('data-temp-id', tempId);
// 在 addUnitScoreToForm 函数中创建删除按钮的部分修改为：
div.innerHTML = `
    <div class="time-point-info">
        <span class="time-point-time">${valueDisplay}</span>
        <span class="time-point-score">${score >= 0 ? '+' : ''}${score}分</span>
        <span class="time-point-description">${description || '无说明'}</span>
    </div>
    <div class="sub-item-actions">
        <button class="small-delete-btn" data-temp-id="${tempId}">
            <i class="fas fa-times"></i>
        </button>
    </div>
`;

// 添加事件监听
const deleteBtn = div.querySelector('.small-delete-btn');
deleteBtn.addEventListener('click', () => {
    this.deleteTempUnitScore(tempId);
});
    unitScoresList.appendChild(div);
    
    // 清空表单
    document.getElementById('unitValue1').value = '';
    document.getElementById('unitValue2').value = '';
    scoreSelect.value = '';
    scoreInput.value = '';
    document.getElementById('unitDescription').value = '';
}

// 删除临时单位评分
deleteTempUnitScore(tempId) {
    const element = document.querySelector(`[data-temp-id="${tempId}"]`);
    if (element) {
        element.remove();
    }
}

// 删除临时时间点
deleteTempTimePoint(tempId) {
    const element = document.querySelector(`[data-temp-id="${tempId}"]`);
    if (element) {
        element.remove();
    }
}
            
            // 添加单位评分到显示列表
            addUnitScoreToDisplay(value, unit, score, description, tempId = null) {
                const unitScoresList = document.getElementById('unitScoresList');
                const itemId = Date.now().toString() + (tempId || '');
                
                const unitScoreItem = document.createElement('div');
                unitScoreItem.className = 'time-point-item';
                unitScoreItem.setAttribute('data-id', itemId);
                unitScoreItem.innerHTML = `
                    <div class="time-point-info">
                        <div class="time-point-time">${value}${unit}</div>
                        <div class="time-point-score ${score >= 0 ? 'positive' : 'negative'}">${score >= 0 ? '+' : ''}${score}</div>
                        <div class="time-point-description">${description}</div>
                    </div>
                    <div class="time-point-actions">
                        <button class="action-btn delete-btn" data-id="${itemId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                unitScoresList.appendChild(unitScoreItem);
                
                // 绑定删除事件
                unitScoreItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    unitScoreItem.remove();
                });
            }
            
            // 从表单保存事项
            saveItemFromForm() {
                const name = document.getElementById('itemName').value.trim();
                const description = document.getElementById('itemDescription').value.trim();
                const unitType = document.getElementById('itemUnitType').value;
                const intervalDays = parseInt(document.getElementById('intervalDays').value);
                const unfinishedScore = parseInt(document.getElementById('unfinishedScore').value);
                
                // 验证输入
                if (!name) {
                    this.showNotification('错误', '请输入事项名称', 'error');
                    return;
                }
                
                if (name.length > 5) {
                    this.showNotification('错误', '事项名称不能超过5个字', 'error');
                    return;
                }
                
                if (!unitType) {
                    this.showNotification('错误', '请选择单位类型', 'error');
                    return;
                }
                
                // 收集时间点或评分项
                let itemData;
                
                if (unitType === 'timePoint') {
                    const timePointItems = document.querySelectorAll('#timePointsList .time-point-item');
                    if (timePointItems.length === 0) {
                        this.showNotification('错误', '请至少添加一个时间点', 'error');
                        return;
                    }
                    
                    const timePoints = [];
                    timePointItems.forEach((item, index) => {
                        const time = item.querySelector('.time-point-time').textContent;
                        const scoreText = item.querySelector('.time-point-score').textContent;
                        const score = parseInt(scoreText.replace('+', ''));
                        const description = item.querySelector('.time-point-description').textContent;
                        
                        timePoints.push({
                            id: index + 1,
                            time: time,
                            score: score,
                            description: description
                        });
                    });
                    
                    itemData = {
                        name: name,
                        description: description,
                        unitType: unitType,
                        intervalDays: intervalDays,
                        unfinishedScore: unfinishedScore,
                        timePoints: timePoints
                    };
                } else {
                    const unitScoreItems = document.querySelectorAll('#unitScoresList .time-point-item');
                    if (unitScoreItems.length === 0) {
                        this.showNotification('错误', '请至少添加一个评分项', 'error');
                        return;
                    }
                    
                    const unitScores = [];
                    unitScoreItems.forEach((item, index) => {
                        const valueWithUnit = item.querySelector('.time-point-time').textContent;
                        const unitLabel = this.getUnitLabel(unitType);
                        const value = valueWithUnit.replace(unitLabel, '');
                        const scoreText = item.querySelector('.time-point-score').textContent;
                        const score = parseInt(scoreText.replace('+', ''));
                        const description = item.querySelector('.time-point-description').textContent;
                        
                        unitScores.push({
                            id: index + 1,
                            value: value,
                            unit: unitLabel,
                            score: score,
                            description: description
                        });
                    });
                    
                    itemData = {
                        name: name,
                        description: description,
                        unitType: unitType,
                        intervalDays: intervalDays,
                        unfinishedScore: unfinishedScore,
                        unitScores: unitScores
                    };
                }
                
                // 保存事项
                let success;
                if (this.editingItemId) {
                    success = this.updateItem(this.editingItemId, itemData);
                    if (success) {
                        this.showNotification('成功', '事项更新成功', 'success');
                    } else {
                        this.showNotification('错误', '事项名称已存在', 'error');
                        return;
                    }
                } else {
                    const newId = this.addItem(itemData);
                    if (newId) {
                        this.showNotification('成功', '事项添加成功', 'success');
                    } else {
                        this.showNotification('错误', '事项名称已存在', 'error');
                        return;
                    }
                }
                
                // 关闭模态框
                this.closeModal('addItemModal');
                this.editingItemId = null;
                
                // 重新渲染
                this.renderAll();
            }
            
            // 打开添加单位类型模态框
            openAddUnitTypeModal() {
                this.openModal('addUnitTypeModal');
            }
            
            // 从表单保存单位类型
            saveUnitTypeFromForm() {
                const name = document.getElementById('customUnitName').value.trim();
                const description = document.getElementById('customUnitDescription').value.trim();
                
                // 验证输入
                if (!name) {
                    this.showNotification('错误', '请输入单位名称', 'error');
                    return;
                }
                
                if (name.length > 5) {
                    this.showNotification('错误', '单位名称不能超过5个字', 'error');
                    return;
                }
                
                // 检查是否已存在
                const existingUnit = this.data.customUnitTypes.find(u => u.label === name);
                if (existingUnit) {
                    this.showNotification('错误', '单位名称已存在', 'error');
                    return;
                }
                
                // 添加单位类型
                const unitData = {
                    label: name,
                    unit: name,
                    description: description
                };
                
                const newValue = this.addCustomUnitType(unitData);
                if (newValue) {
                    this.showNotification('成功', '单位类型添加成功', 'success');
                    this.closeModal('addUnitTypeModal');
                    
                    // 更新单位类型选项
                    this.updateUnitTypeOptions();
                    
                    // 清空表单
                    document.getElementById('customUnitName').value = '';
                    document.getElementById('customUnitDescription').value = '';
                } else {
                    this.showNotification('错误', '单位类型添加失败', 'error');
                }
            }
            
            // 打开模板模态框
            openTemplateModal(templateId = null) {
                this.editingTemplateId = templateId;
                const modal = document.getElementById('templateModal');
                const title = document.getElementById('templateModalTitle');
                
                if (templateId) {
                    // 编辑模式
                    title.textContent = '编辑模板';
                    this.loadTemplateToForm(templateId);
                } else {
                    // 添加模式
                    title.textContent = '添加模板';
                    this.resetTemplateForm();
                }
                
                this.openModal('templateModal');
            }
            
            // 加载模板到表单
            loadTemplateToForm(templateId) {
                const template = this.data.templates.find(t => t.id === templateId);
                if (!template) return;
                
                document.getElementById('templateName').value = template.name;
                
                // 设置已选择的事项
                this.selectedTemplateItems = [...template.itemIds];
                this.renderSelectedTemplateItems();
                
                // 更新可用事项下拉框
                this.updateAvailableItems();
            }
            
            // 重置模板表单
            resetTemplateForm() {
                document.getElementById('templateName').value = '';
                this.selectedTemplateItems = [];
                this.renderSelectedTemplateItems();
                this.updateAvailableItems();
            }
            
            // 更新可用事项下拉框
            updateAvailableItems() {
                const availableItemsSelect = document.getElementById('availableItems');
                availableItemsSelect.innerHTML = '<option value="">选择事项</option>';
                
                this.data.items.forEach(item => {
                    // 只显示未选择的事项
                    if (!this.selectedTemplateItems.includes(item.id)) {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        availableItemsSelect.appendChild(option);
                    }
                });
            }
            
            // 渲染已选择的模板事项
            renderSelectedTemplateItems() {
                const selectedItemsList = document.getElementById('selectedItemsList');
                selectedItemsList.innerHTML = '';
                
                if (this.selectedTemplateItems.length === 0) {
                    selectedItemsList.innerHTML = '<p style="color: var(--gray-color);">暂无选择的事项</p>';
                    return;
                }
                
                this.selectedTemplateItems.forEach(itemId => {
                    const item = this.getItem(itemId);
                    if (!item) return;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'selected-template-item';
                    itemElement.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        margin-bottom: 8px;
                        background-color: #f8fafc;
                        border-radius: var(--border-radius);
                        border-left: 3px solid var(--primary-color);
                    `;
                    
                    itemElement.innerHTML = `
                        <div>
                            <strong>${item.name}</strong>
                            <div style="font-size: 12px; color: var(--gray-color);">
                                类型: ${this.getUnitLabel(item.unitType)}, 间隔: ${item.intervalDays}天
                            </div>
                        </div>
                        <button class="small-delete-btn" data-item-id="${itemId}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    selectedItemsList.appendChild(itemElement);
                    
                    // 绑定删除事件
                    itemElement.querySelector('.small-delete-btn').addEventListener('click', () => {
                        const index = this.selectedTemplateItems.indexOf(itemId);
                        if (index !== -1) {
                            this.selectedTemplateItems.splice(index, 1);
                            this.renderSelectedTemplateItems();
                            this.updateAvailableItems();
                        }
                    });
                });
            }
            
            // 添加事项到模板表单
            addItemToTemplateForm() {
                const itemId = parseInt(document.getElementById('availableItems').value);
                if (!itemId) return;
                
                if (!this.selectedTemplateItems.includes(itemId)) {
                    this.selectedTemplateItems.push(itemId);
                    this.renderSelectedTemplateItems();
                    this.updateAvailableItems();
                }
                
                // 重置选择
                document.getElementById('availableItems').value = '';
            }
            
            // 从表单保存模板
            saveTemplateFromForm() {
                const name = document.getElementById('templateName').value.trim();
                
                if (!name) {
                    this.showNotification('错误', '请输入模板名称', 'error');
                    return;
                }
                
                if (this.selectedTemplateItems.length === 0) {
                    this.showNotification('错误', '请至少选择一个事项', 'error');
                    return;
                }
                
                const templateData = {
                    name: name,
                    itemIds: [...this.selectedTemplateItems]
                };
                
                // 保存模板
                let success;
                if (this.editingTemplateId) {
                    success = this.updateTemplate(this.editingTemplateId, templateData);
                    if (success) {
                        this.showNotification('成功', '模板更新成功', 'success');
                    } else {
                        this.showNotification('错误', '模板名称已存在', 'error');
                        return;
                    }
                } else {
                    const newId = this.addTemplate(templateData);
                    if (newId) {
                        this.showNotification('成功', '模板添加成功', 'success');
                    } else {
                        this.showNotification('错误', '模板名称已存在', 'error');
                        return;
                    }
                }
                
                // 关闭模态框
                this.closeModal('templateModal');
                this.editingTemplateId = null;
                
                // 重新渲染
                this.renderAll();
            }
            
            // 打开选择模板模态框
            openSelectTemplateModal() {
                const templateSelect = document.getElementById('templateSelect');
                templateSelect.innerHTML = '<option value="">选择模板</option>';
                
                this.data.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    templateSelect.appendChild(option);
                });
                
                // 设置当前选中的模板
                if (this.data.currentTemplateId) {
                    templateSelect.value = this.data.currentTemplateId;
                }
                
                this.openModal('selectTemplateModal');
            }
            
            // 确认模板选择
            confirmTemplateSelection() {
                const templateId = parseInt(document.getElementById('templateSelect').value);
                if (!templateId) {
                    this.showNotification('错误', '请选择模板', 'error');
                    return;
                }
                
                if (this.setCurrentTemplate(templateId)) {
                    this.showNotification('成功', '模板设置成功', 'success');
                    this.closeModal('selectTemplateModal');
                    this.renderAll();
                } else {
                    this.showNotification('错误', '设置模板失败', 'error');
                }
            }
            
            // 保存记录
            saveRecordFromForm() {
                const itemId = document.getElementById('itemSelect').value;
                const scoreId = document.getElementById('timeSelect').value;
                
                if (!itemId || !scoreId) {
                    this.showNotification('错误', '请选择事项和评分项', 'error');
                    return;
                }
                
                const item = this.getItem(parseInt(itemId));
                if (!item) return;
                
                const isTimePoint = item.unitType === 'timePoint';
                const todayRecord = this.getTodayRecord();
                
                // 检查是否已记录过该事项
                const existingRecords = todayRecord.records.filter(r => r.itemId === parseInt(itemId));
                
                if (existingRecords.length > 0) {
                    // 显示重复记录确认对话框
                    this.showDuplicateRecordDialog(item.name, existingRecords.length, () => {
                        this.addRecord(parseInt(itemId), parseInt(scoreId), isTimePoint);
                        this.renderDailyRecords();
                        this.renderTemplateList();
                    });
                } else {
                    // 直接添加记录
                    this.addRecord(parseInt(itemId), parseInt(scoreId), isTimePoint);
                    this.renderDailyRecords();
                    this.renderTemplateList();
                }
                
                // 重置表单
                document.getElementById('itemSelect').value = '';
                document.getElementById('timeSelect').value = '';
                document.getElementById('currentScore').textContent = '0';
                
                // 更新分数选项
                this.updateScoreOptions();
            }
            
// 打开模态框
openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        console.log(`已打开模态框: ${modalId}`);
    } else {
        console.error(`未找到模态框: ${modalId}`);
    }
}
            
            // 关闭模态框
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // 切换标签页
            switchTab(tabId) {
                // 隐藏所有标签内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 移除所有标签的激活状态
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 显示选中的标签内容
                document.getElementById(tabId).classList.add('active');
                
                // 激活选中的标签按钮
                document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            }
            
            // 切换事项内容显示/隐藏
            toggleItemContent(header) {
                const content = header.nextElementSibling;
                const toggle = header.querySelector('.item-toggle');
                
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    header.classList.remove('open');
                    toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                } else {
                    content.classList.add('open');
                    header.classList.add('open');
                    toggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
                }
            }
            
            // 切换模板卡片显示/隐藏
            toggleTemplateCard(header) {
                const content = header.nextElementSibling;
                const toggle = header.querySelector('.template-card-toggle');
                
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    header.classList.remove('open');
                    toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                } else {
                    content.classList.add('open');
                    header.classList.add('open');
                    toggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
                }
            }
            
            // 清空输入
            clearInput(targetId) {
                const target = document.getElementById(targetId);
                if (target) {
                    target.value = '';
                    
                    // 如果是选择框，触发change事件
                    if (target.tagName === 'SELECT') {
                        target.dispatchEvent(new Event('change'));
                    }
                }
            }
            
            // 显示通知
            showNotification(title, content, type = 'info') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notificationTitle');
                const notificationContent = document.getElementById('notificationContent');
                
                notificationTitle.textContent = title;
                notificationContent.textContent = content;
                
                // 设置类型
                notification.className = `notification ${type}`;
                
                // 显示通知
                notification.classList.add('show');
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    this.hideNotification();
                }, 5000);
            }
            
            // 隐藏通知
            hideNotification() {
                const notification = document.getElementById('notification');
                notification.classList.remove('show');
            }
            
            // 显示确认对话框
            showConfirmDialog(title, message, callback) {
                const dialog = document.getElementById('confirmDialog');
                const dialogTitle = document.getElementById('confirmTitle');
                const dialogMessage = document.getElementById('confirmMessage');
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                this.confirmCallback = callback;
                
                dialog.classList.add('active');
            }
            
            // 隐藏确认对话框
            hideConfirmDialog() {
                document.getElementById('confirmDialog').classList.remove('active');
                this.confirmCallback = null;
            }
            
            // 显示重复记录确认对话框
            showDuplicateRecordDialog(itemName, existingCount, callback) {
                const dialog = document.getElementById('duplicateRecordDialog');
                const title = document.getElementById('duplicateRecordTitle');
                const message = document.getElementById('duplicateRecordMessage');
                
                title.textContent = '确认添加记录';
                message.textContent = `事项"${itemName}"今天已经记录了${existingCount}次，确定要继续添加吗？`;
                
                this.duplicateRecordCallback = callback;
                dialog.classList.add('active');
            }
            
            // 隐藏重复记录确认对话框
            hideDuplicateRecordDialog() {
                document.getElementById('duplicateRecordDialog').classList.remove('active');
                this.duplicateRecordCallback = null;
                this.pendingRecordData = null;
            }
            
            // 编辑事项
            editItem(itemId) {
                this.openAddItemModal(itemId);
            }
            
            // 确认删除事项
            deleteItemConfirm(itemId) {
                const item = this.getItem(itemId);
                if (!item) return;
                
                this.showConfirmDialog('确认删除', `确定要删除事项"${item.name}"吗？此操作将同时从所有模板中移除该事项。`, () => {
                    if (this.deleteItem(itemId)) {
                        this.showNotification('成功', '事项删除成功', 'success');
                        this.renderAll();
                    } else {
                        this.showNotification('错误', '事项删除失败', 'error');
                    }
                });
            }
            
            // 确认删除时间点
            deleteTimePointConfirm(itemId, tpIndex) {
                this.showConfirmDialog('确认删除', '确定要删除这个时间点吗？', () => {
                    const item = this.getItem(itemId);
                    if (!item || !item.timePoints) return;
                    
                    item.timePoints.splice(tpIndex, 1);
                    this.saveData();
                    this.renderItemsList();
                    this.showNotification('成功', '时间点删除成功', 'success');
                });
            }
            
            // 确认删除单位评分
            deleteUnitScoreConfirm(itemId, usIndex) {
                this.showConfirmDialog('确认删除', '确定要删除这个评分项吗？', () => {
                    const item = this.getItem(itemId);
                    if (!item || !item.unitScores) return;
                    
                    item.unitScores.splice(usIndex, 1);
                    this.saveData();
                    this.renderItemsList();
                    this.showNotification('成功', '评分项删除成功', 'success');
                });
            }
            
            // 编辑模板
            editTemplate(templateId) {
                this.openTemplateModal(templateId);
            }
            
            // 确认删除模板
            deleteTemplateConfirm(templateId) {
                const template = this.data.templates.find(t => t.id === templateId);
                if (!template) return;
                
                this.showConfirmDialog('确认删除', `确定要删除模板"${template.name}"吗？`, () => {
                    if (this.deleteTemplate(templateId)) {
                        this.showNotification('成功', '模板删除成功', 'success');
                        this.renderAll();
                    } else {
                        this.showNotification('错误', '不能删除当前使用的模板', 'error');
                    }
                });
            }
            
            // 更新当前模板名称
            updateCurrentTemplateName() {
                const currentTemplate = this.getCurrentTemplate();
                if (currentTemplate) {
                    document.getElementById('currentTemplateName').textContent = currentTemplate.name;
                } else {
                    document.getElementById('currentTemplateName').textContent = '无';
                }
            }
            
            // 查询每日记录
            searchDailyRecords() {
                const date = document.getElementById('queryDate').value;
                const itemFilter = document.getElementById('queryItem').value;
                
                if (!date) {
                    this.showNotification('错误', '请选择日期', 'error');
                    return;
                }
                
                const result = this.queryDailyRecords(date, itemFilter);
                
                // 更新总分显示
                document.getElementById('queryTotalScore').textContent = result.totalScore;
                document.getElementById('queryTotalScoreContainer').style.display = 'block';
                
                // 渲染模板事项
                this.renderQueryTemplateItems(result.templateItems);
                
                // 渲染记录列表
                this.renderQueryRecords(result.records);
            }
            
            // 渲染查询模板事项
            renderQueryTemplateItems(templateItems) {
                const templateList = document.getElementById('queryTemplateList');
                templateList.innerHTML = '';
                
                if (templateItems.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'template-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">当日无模板事项</div>
                        </div>
                    `;
                    templateList.appendChild(li);
                    return;
                }
                
                templateItems.forEach(item => {
                    let className = 'template-item';
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (item.status) {
                        case 'completed':
                            className += ' completed';
                            statusText = '已完成';
                            statusClass = 'positive';
                            break;
                        case 'notDue':
                            className += ' completed';
                            statusText = '未到期';
                            statusClass = 'positive';
                            break;
                        case 'overdue':
                            className += ' overdue';
                            statusText = '未完成';
                            statusClass = 'negative';
                            break;
                    }
                    
                    const li = document.createElement('li');
                    li.className = className;
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                <span>间隔: ${item.intervalDays}天</span>
                                <span>未完成: ${item.unfinishedScore}分</span>
                            </div>
                        </div>
                        <div class="item-score ${statusClass}">
                            ${statusText}
                            ${item.completionDate ? `<div class="completion-date">${item.completionDate}</div>` : ''}
                        </div>
                    `;
                    templateList.appendChild(li);
                });
            }
            
            // 渲染查询记录
            renderQueryRecords(records) {
                const recordsList = document.getElementById('queryRecordsList');
                recordsList.innerHTML = '';
                
                if (records.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">当日无完成记录</div>
                        </div>
                    `;
                    recordsList.appendChild(li);
                    return;
                }
                
                records.forEach((record, index) => {
                    const li = document.createElement('li');
                    li.className = `record-item ${record.isTemplateItem ? 'template' : 'non-template'}`;
                    
                    let detailsHtml = '';
                    if (record.unitType === 'timePoint') {
                        detailsHtml = `<span>时间: ${record.time}</span>`;
                    } else {
                        detailsHtml = `<span>${record.value}${record.unit}</span>`;
                    }
                    detailsHtml += `<span>${record.isTemplateItem ? '模板内事项' : '额外事项'}</span>`;
                    
                    li.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${record.itemName}</div>
                            <div class="item-details">
                                ${detailsHtml}
                            </div>
                        </div>
                        <div class="item-score ${record.score >= 0 ? 'positive' : 'negative'}">
                            ${record.score >= 0 ? '+' : ''}${record.score}
                        </div>
                    `;
                    recordsList.appendChild(li);
                });
            }
            
            // 更新查询事项选项
            updateQueryItemOptions() {
                const queryItemSelect = document.getElementById('queryItem');
                queryItemSelect.innerHTML = '<option value="">全部事项</option>';
                
                this.data.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = item.name;
                    queryItemSelect.appendChild(option);
                });
            }
            
            // 生成周度报告
            generateWeeklyReportFromForm() {
                const weekInput = document.getElementById('reportWeek').value;
                if (!weekInput) {
                    this.showNotification('错误', '请选择周次', 'error');
                    return;
                }
                
                // 解析周输入
                const [year, week] = weekInput.split('-W');
                const startDate = this.getDateOfISOWeek(parseInt(week), parseInt(year));
                const startDateStr = startDate.toISOString().split('T')[0];
                
                const report = this.generateWeeklyReport(startDateStr);
                if (!report) {
                    this.showNotification('提示', '该周没有记录数据', 'info');
                    return;
                }
                
                this.renderWeeklyReport(report);
            }
            
            // 根据ISO周获取日期
            getDateOfISOWeek(week, year) {
                const simple = new Date(year, 0, 1 + (week - 1) * 7);
                const dow = simple.getDay();
                const ISOweekStart = simple;
                if (dow <= 4) {
                    ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                } else {
                    ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
                }
                return ISOweekStart;
            }
            
            // 渲染周度报告
            renderWeeklyReport(report) {
                const statsContainer = document.getElementById('weeklyStats');
                const completionSummary = document.getElementById('completionSummary');
                const dailySummary = document.getElementById('dailySummary');
                
                // 渲染统计数据
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.recordDays}</div>
                        <div class="stat-label">记录天数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.interruptDays}</div>
                        <div class="stat-label">中断天数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.longestStreak}</div>
                        <div class="stat-label">最长连续</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.currentStreak}</div>
                        <div class="stat-label">当前连续</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.totalScore}</div>
                        <div class="stat-label">累计得分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${report.stats.averageScore.toFixed(1)}</div>
                        <div class="stat-label">日均得分</div>
                    </div>
                `;
                
                // 渲染事项完成情况
                let completionHtml = '';
                Object.entries(report.stats.itemsCompletion).forEach(([itemName, stats]) => {
                    completionHtml += `
                        <div class="completion-item">
                            <span>${itemName}</span>
                            <span>完成${stats.count}次，总分${stats.totalScore}</span>
                        </div>
                    `;
                });
                
                if (completionHtml === '') {
                    completionHtml = '<p style="color: var(--gray-color); padding: 20px; text-align: center;">本周无事项完成记录</p>';
                }
                
                completionSummary.innerHTML = completionHtml;
                
                // 渲染每日摘要
                let dailyHtml = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(report.weekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayRecord = report.records.find(r => r.date === dateStr);
                    const dayTotal = dayRecord ? this.calculateDailyTotalScoreForDate(dateStr) : 0;
                    const dayCompletedTotal = dayRecord ? dayRecord.totalScore : 0;
                    const recordCount = dayRecord ? dayRecord.records.length : 0;
                    
                    dailyHtml += `
                        <div class="completion-item">
                            <span>${dateStr} (${this.getDayOfWeek(date.getDay())})</span>
                            <span>
                                ${dayRecord ? `累计: ${dayTotal}分，完成: ${dayCompletedTotal}分，记录: ${recordCount}条` : '无记录'}
                            </span>
                        </div>
                    `;
                }
                
                dailySummary.innerHTML = dailyHtml;
            }
            
            // 获取星期几
            getDayOfWeek(dayIndex) {
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                return days[dayIndex];
            }
            
            // 生成月度报告
            generateMonthlyReportFromForm() {
                const monthInput = document.getElementById('reportMonth').value;
                if (!monthInput) {
                    this.showNotification('错误', '请选择月份', 'error');
                    return;
                }
                
                const report = this.generateMonthlyReport(monthInput);
                if (!report) {
                    this.showNotification('提示', '该月没有记录数据', 'info');
                    return;
                }
                
                this.renderMonthlyReport(report);
            }
            
            // 渲染月度报告
            renderMonthlyReport(report) {
                const calendarContainer = document.getElementById('monthlyCalendar');
                const statsContainer = document.getElementById('monthlyStats');
                const completionSummary = document.getElementById('monthlyCompletionSummary');
                
                // 渲染日历
                let calendarHtml = '';
                
                // 添加星期标题
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    calendarHtml += `<div class="calendar-day empty"><strong>${day}</strong></div>`;
                });
                
                // 获取当月第一天是星期几
                const firstDay = new Date(report.year, report.month - 1, 1);
                const firstDayOfWeek = firstDay.getDay();
                
                // 添加空白占位
                for (let i = 0; i < firstDayOfWeek; i++) {
                    calendarHtml += '<div class="calendar-day empty"></div>';
                }
                
                // 添加日期
                report.calendarDays.forEach(day => {
                    const today = this.getTodayDate();
                    let className = 'calendar-day';
                    
                    if (day.hasRecord) {
                        className += ' has-record';
                    }
                    
                    if (day.date === today) {
                        className += ' today';
                    }
                    
                    const score = day.record ? this.calculateDailyTotalScoreForDate(day.date) : 0;
                    
                    calendarHtml += `
                        <div class="${className}">
                            <div class="calendar-day-number">${day.day}</div>
                            ${day.hasRecord ? `<div class="calendar-day-score">${score}分</div>` : ''}
                        </div>
                    `;
                });
                
                calendarContainer.innerHTML = calendarHtml;
                
                // 渲染统计数据
                statsContainer.innerHTML = `
                    <div class="monthly-stat-card">
                        <div class="monthly-stat-value">${report.stats.recordDays}/${report.stats.totalDays}</div>
                        <div class="monthly-stat-label">记录天数</div>
                        <div class="monthly-stat-desc">完成率: ${report.stats.completionRate}%</div>
                    </div>
                    <div class="monthly-stat-card">
                        <div class="monthly-stat-value">${report.stats.longestStreak}</div>
                        <div class="monthly-stat-label">最长连续</div>
                        <div class="monthly-stat-desc">当前连续: ${report.stats.currentStreak}天</div>
                    </div>
                    <div class="monthly-stat-card">
                        <div class="monthly-stat-value">${report.stats.totalScore}</div>
                        <div class="monthly-stat-label">累计得分</div>
                        <div class="monthly-stat-desc">完成记录: ${report.stats.completedTotalScore}分</div>
                    </div>
                    <div class="monthly-stat-card">
                        <div class="monthly-stat-value">${report.stats.averageScore}</div>
                        <div class="monthly-stat-label">日均得分</div>
                        <div class="monthly-stat-desc">最高: ${report.stats.maxDailyScore}分</div>
                    </div>
                `;
                
                // 渲染事项完成情况
                let completionHtml = '';
                Object.entries(report.stats.itemsCompletion).forEach(([itemName, stats]) => {
                    completionHtml += `
                        <div class="completion-item">
                            <span>${itemName}</span>
                            <span>完成${stats.count}次，总分${stats.totalScore}</span>
                        </div>
                    `;
                });
                
                if (completionHtml === '') {
                    completionHtml = '<p style="color: var(--gray-color); padding: 20px; text-align: center;">本月无事项完成记录</p>';
                }
                
                completionSummary.innerHTML = completionHtml;
            }
            
            // 更新所有记录查询选项
            updateAllRecordsOptions() {
                // 更新事项选项
                const itemSelect = document.getElementById('allRecordsItem');
                itemSelect.innerHTML = '<option value="">全部事项</option>';
                
                this.data.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = item.name;
                    itemSelect.appendChild(option);
                });
                
                // 更新单位类型选项
                const unitTypeSelect = document.getElementById('allRecordsUnitType');
                unitTypeSelect.innerHTML = '<option value="">全部类型</option>';
                
                // 添加内置单位类型
                this.builtInUnitTypes.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.label;
                    unitTypeSelect.appendChild(option);
                });
                
                // 添加自定义单位类型
                this.data.customUnitTypes.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.label + ' (自定义)';
                    unitTypeSelect.appendChild(option);
                });
            }
            
            // 查询所有记录
            searchAllRecords() {
                const filters = {
                    item: document.getElementById('allRecordsItem').value || '',
                    score: document.getElementById('allRecordsScore').value || '',
                    unitType: document.getElementById('allRecordsUnitType').value || ''
                };
                
                const results = this.queryAllRecords(filters);
                this.currentAllRecordsResults = results;
                
                this.renderAllRecords(results);
            }
            
            // 渲染所有记录
            renderAllRecords(results) {
                const summaryContainer = document.getElementById('allRecordsSummary');
                const listContainer = document.getElementById('allRecordsList');
                
                // 更新摘要
                summaryContainer.innerHTML = `
                    <div>共找到 <span class="all-records-count">${results.length}</span> 条记录</div>
                    <div>点击日期查看详情</div>
                `;
                
                // 清空列表
                listContainer.innerHTML = '';
                
                if (results.length === 0) {
                    listContainer.innerHTML = `
                        <div class="all-record-item">
                            <div class="all-record-date">无记录</div>
                            <div class="all-record-stats">
                                <span>没有找到符合条件的记录</span>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // 渲染记录列表
                results.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'all-record-item record-date-item';
                    li.setAttribute('data-date', item.date);
                    
                    li.innerHTML = `
                        <div class="all-record-date">${item.date}</div>
                        <div class="all-record-stats">
                            <span>累计得分: <span class="all-record-score">${item.stats.totalScore}</span></span>
                            <span>完成记录: ${item.stats.recordCount}条</span>
                            <span>完成总分: ${item.stats.completedTotalScore}</span>
                            <span>未完成事项: ${item.stats.overdueCount}个</span>
                        </div>
                        <div class="all-record-actions">
                            <button class="action-btn" data-date="${item.date}">
                                <i class="fas fa-eye"></i> 查看详情
                            </button>
                        </div>
                    `;
                    
                    listContainer.appendChild(li);
                });
                
                // 绑定查看详情事件
                listContainer.querySelectorAll('.action-btn[data-date]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const date = e.target.closest('.action-btn').getAttribute('data-date');
                        this.showRecordDetails(date);
                    });
                });
                
                // 绑定点击日期事件
                listContainer.querySelectorAll('.record-date-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.action-btn')) {
                            const date = e.currentTarget.getAttribute('data-date');
                            this.showRecordDetails(date);
                        }
                    });
                });
            }
            
            // 显示记录详情
            showRecordDetails(date) {
                const result = this.queryDailyRecords(date);
                
                // 获取当日模板
                let record = this.data.dailyRecords[date];
                if (!record) {
                    record = this.data.history.find(r => r.date === date);
                }
                
                const template = record ? this.data.templates.find(t => t.id === record.templateId) : null;
                
                let content = `
                    <div class="record-details-header">
                        <div>
                            <div class="record-details-date">${date}</div>
                            <div class="record-details-template">
                                使用模板: <span>${template ? template.name : '未知模板'}</span>
                            </div>
                        </div>
                        <div class="detail-scores">
                            <div class="detail-score-item">
                                <div class="detail-score-label">累计得分</div>
                                <div class="detail-score-value">${result.totalScore}</div>
                            </div>
                            <div class="detail-score-item">
                                <div class="detail-score-label">完成记录总分</div>
                                <div class="detail-score-value">${result.completedTotalScore}</div>
                            </div>
                            <div class="detail-score-item">
                                <div class="detail-score-label">完成记录数</div>
                                <div class="detail-score-value">${result.records.length}</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>模板事项状态</h3>
                    <div class="records-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                `;
                
                if (result.templateItems.length === 0) {
                    content += '<p style="color: var(--gray-color); padding: 10px; text-align: center;">当日无模板事项</p>';
                } else {
                    result.templateItems.forEach(item => {
                        let statusText = '';
                        let statusClass = '';
                        
                        switch (item.status) {
                            case 'completed':
                                statusText = '已完成';
                                statusClass = 'positive';
                                break;
                            case 'notDue':
                                statusText = '未到期';
                                statusClass = 'positive';
                                break;
                            case 'overdue':
                                statusText = '未完成';
                                statusClass = 'negative';
                                break;
                        }
                        
                        content += `
                            <div class="template-item ${item.status === 'overdue' ? 'overdue' : 'completed'}">
                                <div class="item-info">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-details">
                                        <span>间隔: ${item.intervalDays}天</span>
                                        <span>未完成: ${item.unfinishedScore}分</span>
                                        ${item.completionDate ? `<span>完成于: ${item.completionDate}</span>` : ''}
                                    </div>
                                </div>
                                <div class="item-score ${statusClass}">
                                    ${statusText}
                                </div>
                            </div>
                        `;
                    });
                }
                
                content += `
                    </div>
                    
                    <h3>完成记录详情</h3>
                    <div class="records-list" style="max-height: 300px; overflow-y: auto;">
                `;
                
                if (result.records.length === 0) {
                    content += '<p style="color: var(--gray-color); padding: 10px; text-align: center;">当日无完成记录</p>';
                } else {
                    result.records.forEach(record => {
                        let detailsHtml = '';
                        if (record.unitType === 'timePoint') {
                            detailsHtml = `<span>时间: ${record.time}</span>`;
                        } else {
                            detailsHtml = `<span>${record.value}${record.unit}</span>`;
                        }
                        detailsHtml += `<span>${record.isTemplateItem ? '模板内事项' : '额外事项'}</span>`;
                        detailsHtml += `<span>类型: ${this.getUnitLabel(record.unitType)}</span>`;
                        
                        content += `
                            <div class="record-item ${record.isTemplateItem ? 'template' : 'non-template'}">
                                <div class="item-info">
                                    <div class="item-name">${record.itemName}</div>
                                    <div class="item-details">
                                        ${detailsHtml}
                                    </div>
                                </div>
                                <div class="item-score ${record.score >= 0 ? 'positive' : 'negative'}">
                                    ${record.score >= 0 ? '+' : ''}${record.score}
                                </div>
                            </div>
                        `;
                    });
                }
                
                content += '</div>';
                
                document.getElementById('recordDetailsContent').innerHTML = content;
                this.openModal('recordDetailsModal');
            }
        }

        // 创建系统实例
        const habitSystem = new HabitScoreSystem();
        // 创建系统实例
const habitScoreSystem = new HabitScoreSystem();
        
        // 全局函数供HTML内联事件调用
        window.habitSystem = habitSystem;
    </script>
</body>
</html>
